<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-03-12 Sun 09:20 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>unpackaged.el</title>
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
</style>
<link rel="stylesheet" type="text/css" href="export/styles/darksun/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="export/styles/darksun/css/darksun.css"/>
<link rel="stylesheet" type="text/css" href="export/styles/darksun/css/hideshow.css"/>
<script type="text/javascript" src="export/styles/darksun/js/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="export/styles/darksun/js/jquery-ui-1.10.2.min.js"></script>
<script type="text/javascript" src="export/styles/darksun/js/jquery.localscroll-min.js"></script>
<script type="text/javascript" src="export/styles/darksun/js/jquery.scrollTo-1.4.3.1-min.js"></script>
<script type="text/javascript" src="export/styles/darksun/js/jquery.zclip.min.js"></script>
<script type="text/javascript" src="export/styles/darksun/js/darksun.js"></script>
<script type="text/javascript" src="export/styles/darksun/js/hideshow.js"></script>
<script type="text/javascript" src="export/styles/lib/js/jquery.stickytableheaders.min.js"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">unpackaged.el</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#Usage">Usage</a></li>
<li><a href="#Faces%2C%20fonts">Faces, fonts&#xa0;&#xa0;&#xa0;<span class="tag"><span class="faces">faces</span>&#xa0;<span class="fonts">fonts</span></span></a>
<ul>
<li><a href="#font-compare">font-compare</a></li>
</ul>
</li>
<li><a href="#Buffers">Buffers&#xa0;&#xa0;&#xa0;<span class="tag"><span class="buffers">buffers</span></span></a>
<ul>
<li><a href="#ibuffer">ibuffer&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ibuffer">ibuffer</span></span></a>
<ul>
<li><a href="#Filter%20groups">Filter groups</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Customization">Customization</a>
<ul>
<li><a href="#Expand%20all%20options%27%20documentation">Expand all options' documentation</a></li>
<li><a href="#Set%20value%20of%20customization%20option%20at%20point">Set value of customization option at point</a></li>
<li><a href="#Customize%20theme%20faces">Customize theme faces</a></li>
</ul>
</li>
<li><a href="#Elfeed">Elfeed&#xa0;&#xa0;&#xa0;<span class="tag"><span class="Elfeed">Elfeed</span></span></a>
<ul>
<li><a href="#Filter%20hydra">Filter hydra</a></li>
</ul>
</li>
<li><a href="#Meta">Meta&#xa0;&#xa0;&#xa0;<span class="tag"><span class="meta">meta</span></span></a></li>
<li><a href="#Misc">Misc</a>
<ul>
<li><a href="#Define%20a%20%22chooser%22%20command">Define a "chooser" command</a></li>
<li><a href="#Obfuscate%20buffer%20text%20with%20%2Florem%20ipsum%2F%20words">Obfuscate buffer text with <i>lorem ipsum</i> words</a></li>
<li><a href="#Track%20metadata%20from%20MPRIS-supporting%20media%20player">Track metadata from MPRIS-supporting media player&#xa0;&#xa0;&#xa0;<span class="tag"><span class="DBus">DBus</span></span></a></li>
</ul>
</li>
<li><a href="#Org">Org&#xa0;&#xa0;&#xa0;<span class="tag"><span class="Org">Org</span></span></a>
<ul>
<li><a href="#Agenda">Agenda&#xa0;&#xa0;&#xa0;<span class="tag"><span class="agenda">agenda</span></span></a>
<ul>
<li><a href="#Agenda%20for%20subtree%20or%20region">Agenda for subtree or region</a></li>
<li><a href="#Agenda%20for%20outline%20path">Agenda for outline path</a></li>
<li><a href="#Agenda%20previews">Agenda previews</a></li>
</ul>
</li>
<li><a href="#Convert%20Elisp%20to%20Org%20format">Convert Elisp to Org format&#xa0;&#xa0;&#xa0;<span class="tag"><span class="meta">meta</span></span></a></li>
<li><a href="#Download%20and%20attach%20remote%20files">Download and attach remote files</a></li>
<li><a href="#Ensure%20blank%20lines%20between%20headings%20and%20before%20contents">Ensure blank lines between headings and before contents</a></li>
<li><a href="#Export%20to%20HTML%20with%20%2Fuseful%2F%20anchors">Export to HTML with <i>useful</i> anchors</a></li>
<li><a href="#Force%20monospace%20face%20in%20tables">Force monospace face in tables</a></li>
<li><a href="#Outline%20number%20overlays">Outline number overlays</a></li>
<li><a href="#Surround%20region%20with%20emphasis%20or%20syntax%20characters">Surround region with emphasis or syntax characters</a></li>
<li><a href="#Refile%20to%20datetree%20file%20using%20earliest%2Flatest%20timestamp%20in%20entry">Refile to datetree file using earliest/latest timestamp in entry</a></li>
<li><a href="#~org-return-dwim~"><code>org-return-dwim</code></a></li>
<li><a href="#Read-only%20trees">Read-only trees</a></li>
<li><a href="#Sort%20tree%20by%20multiple%20methods%20at%20once">Sort tree by multiple methods at once</a></li>
</ul>
</li>
<li><a href="#Packages">Packages&#xa0;&#xa0;&#xa0;<span class="tag"><span class="packages">packages</span></span></a>
<ul>
<li><a href="#Delete%20all%20installed%20versions%20of%20a%20package">Delete all installed versions of a package</a></li>
<li><a href="#Reload%20a%20package%27s%20features">Reload a package's features</a></li>
<li><a href="#Upgrade%20a%20~quelpa-use-package~%20form%27s%20package">Upgrade a <code>quelpa-use-package</code> form's package</a></li>
<li><a href="#Upgrade%20one%20package%20in%20the%20package%20menu">Upgrade one package in the package menu</a></li>
</ul>
</li>
<li><a href="#Programming">Programming&#xa0;&#xa0;&#xa0;<span class="tag"><span class="programming">programming</span></span></a>
<ul>
<li><a href="#Compile%20top-level%20form%20with%20warnings">Compile top-level form with warnings</a></li>
<li><a href="#Flexibly%20fill%2Funfill%20paragraphs">Flexibly fill/unfill paragraphs</a></li>
<li><a href="#~iedit~"><code>iedit</code>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="iedit">iedit</span>&#xa0;<span class="refactoring">refactoring</span></span></a>
<ul>
<li><a href="#~iedit-scoped~"><code>iedit-scoped</code></a></li>
<li><a href="#~iedit-or-flyspell~"><code>iedit-or-flyspell</code>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="flyspell">flyspell</span>&#xa0;<span class="spell_checking">spell_checking</span></span></a></li>
</ul>
</li>
<li><a href="#Sort%20sexps">Sort sexps</a></li>
</ul>
</li>
<li><a href="#Regular%20expressions">Regular expressions&#xa0;&#xa0;&#xa0;<span class="tag"><span class="regular_expressions">regular_expressions</span></span></a>
<ul>
<li><a href="#query-replace-rx">query-replace-rx</a></li>
</ul>
</li>
<li><a href="#Version%20control">Version control&#xa0;&#xa0;&#xa0;<span class="tag"><span class="version_control">version_control</span></span></a>
<ul>
<li><a href="#Magit">Magit&#xa0;&#xa0;&#xa0;<span class="tag"><span class="Magit">Magit</span></span></a>
<ul>
<li><a href="#Improved%20~magit-status~%20command">Improved <code>magit-status</code> command</a></li>
<li><a href="#magit-log%20date%20headers">magit-log date headers</a></li>
<li><a href="#Save%20buffer%20and%20show%20changes%20in%20Magit%20status">Save buffer and show changes in Magit status</a></li>
</ul>
</li>
<li><a href="#~smerge-mode~"><code>smerge-mode</code></a>
<ul>
<li><a href="#Hydra">Hydra</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Web">Web&#xa0;&#xa0;&#xa0;<span class="tag"><span class="web">web</span></span></a>
<ul>
<li><a href="#EWW%20Imenu%20support">EWW Imenu support&#xa0;&#xa0;&#xa0;<span class="tag"><span class="EWW">EWW</span>&#xa0;<span class="Imenu">Imenu</span></span></a></li>
<li><a href="#feed-for-url">feed-for-url&#xa0;&#xa0;&#xa0;<span class="tag"><span class="RSS">RSS</span>&#xa0;<span class="Atom">Atom</span>&#xa0;<span class="XML">XML</span></span></a></li>
</ul>
</li>
<li><a href="#License">License</a></li>
</ul>
</div>
</div>
<p>
A collection of useful Emacs Lisp code that isn't substantial enough to be packaged.  This code will be maintained here so that it can be updated and improved over time.
</p>

<p>
This can be viewed directly on the <a href="http://github.com/alphapapa/unpackaged.el">repository</a> or as <a href="http://alphapapa.github.io/unpackaged.el">HTML</a>.
</p>

<p>
Contributions welcome!
</p>

<p>
Functions in this file generally use these helper packages:
</p>

<ul class="org-ul">
<li><a href="https://github.com/magnars/dash.el">dash.el</a> (including <code>dash-functional</code>)</li>
<li><a href="https://github.com/magnars/s.el">s.el</a></li>
<li><a href="https://github.com/jwiegley/use-package">use-package</a></li>
</ul>

<div id="outline-container-Usage" class="outline-2">
<h2 id="Usage">Usage</h2>
<div class="outline-text-2" id="text-Usage">
<p>
There are two ways to use the code in this "unpackage":
</p>

<dl class="org-dl">
<dt>Buffet</dt><dd>Choose the the parts you want and copy them into your init files.</dd>
<dt>Whole-hog</dt><dd>Load the file <code>unpackaged.el</code>, which is tangled from this Org file, e.g. <code>(require 'unpackaged)</code>.</dd>
</dl>

<p>
In general, the author will attempt to avoid code that modifies Emacs state by simply loading the tangled "unpackage," but this is not strictly guaranteed.  Please report any problems.
</p>

<p>
An easy way to "whole-hog it" is to use <a href="https://framagit.org/steckerhalter/quelpa-use-package">quelpa-use-package</a> like this:
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">use-package</span> <span style="color: #d33682; font-weight: bold;">unpackaged</span>
  <span style="color: #268bd2; font-weight: bold;">:quelpa</span> (unpackaged <span style="color: #268bd2; font-weight: bold;">:fetcher</span> github <span style="color: #268bd2; font-weight: bold;">:repo</span> <span style="color: #2aa198;">"alphapapa/unpackaged.el"</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-Faces%2C%20fonts" class="outline-2">
<h2 id="Faces%2C%20fonts">Faces, fonts&#xa0;&#xa0;&#xa0;<span class="tag"><span class="faces">faces</span>&#xa0;<span class="fonts">fonts</span></span></h2>
<div class="outline-text-2" id="text-Faces%2C%20fonts">
</div>
<div id="outline-container-font-compare" class="outline-3">
<h3 id="font-compare">font-compare</h3>
<div class="outline-text-3" id="text-font-compare">
<p>
Compare <code>TEXT</code> displayed in <code>FONTS</code>.  <code>FONTS</code> is a list of font specs.
</p>

<p>
Interactively, prompt for <code>TEXT</code>, using <code>lorem-ipsum</code> text if nil or the empty string, and select <code>FONTS</code> with <code>x-select-font</code>, pressing Cancel to stop selecting fonts.
</p>

<p>
<b>Requires:</b>
</p>
<ul class="org-ul">
<li><a href="https://github.com/jschaf/emacs-lorem-ipsum">emacs-lorem-ipsum</a></li>
</ul>

<p>

</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #d33682; font-weight: bold;">seq</span>)

(<span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #6c71c4;">lorem-ipsum-text</span>)

<span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/font-compare</span> (text fonts)
  <span style="color: #35a69c; font-style: italic;">"Compare TEXT displayed in FONTS.</span>
<span style="color: #35a69c; font-style: italic;">If TEXT is nil, use `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">lorem-ipsum</span><span style="color: #35a69c; font-style: italic;">' text.  FONTS is a list of font</span>
<span style="color: #35a69c; font-style: italic;">family strings and/or font specs.</span>

<span style="color: #35a69c; font-style: italic;">Interactively, prompt for TEXT, using `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">lorem-ipsum</span><span style="color: #35a69c; font-style: italic;">' if left</span>
<span style="color: #35a69c; font-style: italic;">empty, and select FONTS with `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">x-select-font</span><span style="color: #35a69c; font-style: italic;">', pressing Cancel to</span>
<span style="color: #35a69c; font-style: italic;">stop selecting fonts."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span> (<span style="text-decoration: underline;">list</span> (<span style="color: #859900; font-weight: bold;">pcase</span> (<span style="text-decoration: underline;">read-string</span> <span style="color: #2aa198;">"Text: "</span>)
                       (<span style="color: #2aa198;">""</span> nil)
                       (else else))
                     <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">`</span><span style="color: #d33682; font-weight: bold; font-style: italic;">x-select-font</span><span style="color: #405A61; font-style: italic;">' calls quit() when Cancel is pressed, so we use</span>
                     <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">`</span><span style="color: #d33682; font-weight: bold; font-style: italic;">inhibit-quit</span><span style="color: #405A61; font-style: italic;">', `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">with-local-quit</span><span style="color: #405A61; font-style: italic;">', and `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">quit-flag</span><span style="color: #405A61; font-style: italic;">' to avoid that.</span>
                     (<span style="color: #859900; font-weight: bold;">let</span> ((inhibit-quit t))
                       (<span style="color: #859900; font-weight: bold;">cl-loop</span> for font = (<span style="color: #859900; font-weight: bold;">with-local-quit</span>
                                             (<span style="text-decoration: underline;">x-select-font</span>))
                                while font
                                collect font into fonts
                                finally do (<span style="color: #859900; font-weight: bold;">setf</span> quit-flag nil)
                                finally return fonts))))
  (<span style="color: #859900; font-weight: bold;">setq</span> text (<span style="color: #859900; font-weight: bold;">or</span> text (<span style="text-decoration: underline;">s-word-wrap</span> 80 (<span style="text-decoration: underline;">s-join</span> <span style="color: #2aa198;">" "</span> (<span style="color: #859900; font-weight: bold;">progn</span>
                                                    (<span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #d33682; font-weight: bold;">lorem-ipsum</span>)
                                                    (<span style="text-decoration: underline;">seq-random-elt</span> lorem-ipsum-text))))))
  (<span style="color: #859900; font-weight: bold;">with-current-buffer</span> (<span style="text-decoration: underline;">get-buffer-create</span> <span style="color: #2aa198;">"*Font Compare*"</span>)
    (<span style="text-decoration: underline;">erase-buffer</span>)
    (<span style="color: #859900; font-weight: bold;">--each</span> fonts
      (<span style="color: #859900; font-weight: bold;">let</span> ((family (<span style="color: #859900; font-weight: bold;">cl-typecase</span> it
                      (font (<span style="text-decoration: underline;">symbol-name</span> (<span style="text-decoration: underline;">font-get</span> it <span style="color: #268bd2; font-weight: bold;">:family</span>)))
                      (<span style="text-decoration: underline;">string</span> it))))
        (<span style="text-decoration: underline;">insert</span> family <span style="color: #2aa198;">": "</span>
                (<span style="text-decoration: underline;">propertize</span> text
                            'face (<span style="text-decoration: underline;">list</span> <span style="color: #268bd2; font-weight: bold;">:family</span> family))
                <span style="color: #2aa198;">"\n\n"</span>)))
    (<span style="text-decoration: underline;">pop-to-buffer</span> (<span style="text-decoration: underline;">current-buffer</span>))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-Buffers" class="outline-2">
<h2 id="Buffers">Buffers&#xa0;&#xa0;&#xa0;<span class="tag"><span class="buffers">buffers</span></span></h2>
<div class="outline-text-2" id="text-Buffers">
</div>
<div id="outline-container-ibuffer" class="outline-3">
<h3 id="ibuffer">ibuffer&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ibuffer">ibuffer</span></span></h3>
<div class="outline-text-3" id="text-ibuffer">
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #405A61; font-style: italic;">;;; </span><span style="color: #405A61; font-style: italic;">ibuffer</span>

</pre>
</div>
</div>

<div id="outline-container-Filter%20groups" class="outline-4">
<h4 id="Filter%20groups">Filter groups</h4>
<div class="outline-text-4" id="text-Filter%20groups">
<p>
These commands toggle and move filter groups.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #d33682; font-weight: bold;">ibuffer</span>)
(<span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #d33682; font-weight: bold;">ibuf-ext</span>)

<span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/ibuffer-toggle-all-filter-groups</span> (toggle-empty)
  <span style="color: #35a69c; font-style: italic;">"Toggle all filter groups.</span>
<span style="color: #35a69c; font-style: italic;">With prefix, toggle `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">ibuffer-show-empty-filter-groups</span><span style="color: #35a69c; font-style: italic;">'."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span> <span style="color: #2aa198;">"P"</span>)
  (<span style="color: #859900; font-weight: bold;">if</span> toggle-empty
      (<span style="color: #859900; font-weight: bold;">progn</span>
        (<span style="color: #859900; font-weight: bold;">setf</span> ibuffer-show-empty-filter-groups (<span style="text-decoration: underline;">not</span> ibuffer-show-empty-filter-groups))
        (<span style="text-decoration: underline;">ibuffer-update</span> nil))
    (<span style="color: #859900; font-weight: bold;">save-excursion</span>
      (<span style="text-decoration: underline;">goto-char</span> (<span style="text-decoration: underline;">point-min</span>))
      (<span style="text-decoration: underline;">ibuffer-forward-filter-group</span>)
      (<span style="color: #859900; font-weight: bold;">let</span> ((start (<span style="text-decoration: underline;">point</span>)))
        (<span style="text-decoration: underline;">forward-char</span>)
        (<span style="color: #859900; font-weight: bold;">while</span> (<span style="text-decoration: underline;">not</span> (&lt;= (<span style="text-decoration: underline;">point</span>) start))
          (<span style="text-decoration: underline;">ibuffer-toggle-filter-group</span>)
          (<span style="text-decoration: underline;">ibuffer-forward-filter-group</span>))))))

<span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/ibuffer-filter-group-move-down</span> ()
  <span style="color: #35a69c; font-style: italic;">"Move filter group at point down."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span>)
  (<span style="text-decoration: underline;">unpackaged/ibuffer-filter-group-move</span> 'down))

<span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/ibuffer-filter-group-move-up</span> ()
  <span style="color: #35a69c; font-style: italic;">"Move filter group at point up."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span>)
  (<span style="text-decoration: underline;">unpackaged/ibuffer-filter-group-move</span> 'up))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/ibuffer-filter-group-move</span> (direction)
  <span style="color: #35a69c; font-style: italic;">"Move filter group at point in DIRECTION, either `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">up</span><span style="color: #35a69c; font-style: italic;">' or `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">down</span><span style="color: #35a69c; font-style: italic;">'."</span>
  (<span style="text-decoration: underline;">ibuffer-kill-line</span>)
  (<span style="color: #859900; font-weight: bold;">pcase-exhaustive</span> direction
    ('down (<span style="text-decoration: underline;">ibuffer-forward-filter-group</span>))
    ('up (<span style="text-decoration: underline;">ibuffer-backward-filter-group</span>)))
  (<span style="text-decoration: underline;">ibuffer-yank</span>))
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-Customization" class="outline-2">
<h2 id="Customization">Customization</h2>
<div class="outline-text-2" id="text-Customization">
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #405A61; font-style: italic;">;;; </span><span style="color: #405A61; font-style: italic;">Customization</span>

</pre>
</div>
</div>

<div id="outline-container-Expand%20all%20options%27%20documentation" class="outline-3">
<h3 id="Expand%20all%20options%27%20documentation">Expand all options' documentation</h3>
<div class="outline-text-3" id="text-Expand%20all%20options%27%20documentation">
<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/custom-toggle-all-more-hide</span> ()
  <span style="color: #35a69c; font-style: italic;">"Toggle all \"More/Hide\" widgets in current buffer."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span>)
  (<span style="text-decoration: underline;">widget-map-buttons</span> (<span style="color: #859900; font-weight: bold;">lambda</span> (widget _)
                        (<span style="color: #859900; font-weight: bold;">pcase</span> (<span style="text-decoration: underline;">widget-get</span> widget <span style="color: #268bd2; font-weight: bold;">:off</span>)
                          (<span style="color: #2aa198;">"More"</span> (<span style="text-decoration: underline;">widget-apply-action</span> widget)))
                        nil)))
</pre>
</div>
</div>
</div>

<div id="outline-container-Set%20value%20of%20customization%20option%20at%20point" class="outline-3">
<h3 id="Set%20value%20of%20customization%20option%20at%20point">Set value of customization option at point</h3>
<div class="outline-text-3" id="text-Set%20value%20of%20customization%20option%20at%20point">
<p>
In <code>Customize</code> buffers, pressing <code>C-c C-c</code> offers to set all variables in the buffer, which isn't always what I want when point is on one option.  This binds that key to a new function in <code>custom-field-keymap</code>, which is only active when point is on an editable field.  The function sets only the current option.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">use-package</span> <span style="color: #d33682; font-weight: bold;">cus-edit</span>
  <span style="color: #268bd2; font-weight: bold;">:general</span>
  (<span style="color: #268bd2; font-weight: bold;">:keymaps</span> 'custom-field-keymap
            <span style="color: #2aa198;">"C-c C-c"</span> (<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/custom-set-at-point</span> ()
                        <span style="color: #35a69c; font-style: italic;">"Set current value of widget at point."</span>
                        (<span style="color: #859900; font-weight: bold;">interactive</span>)
                        (<span style="color: #859900; font-weight: bold;">cl-labels</span> ((find-widget (widget property)
                                                 (<span style="color: #859900; font-weight: bold;">if</span> (<span style="text-decoration: underline;">widget-get</span> widget property)
                                                     widget
                                                   (find-widget (<span style="text-decoration: underline;">widget-get</span> widget <span style="color: #268bd2; font-weight: bold;">:parent</span>) property))))
                          (<span style="color: #859900; font-weight: bold;">when-let*</span> ((widget (find-widget (<span style="text-decoration: underline;">widget-at</span>) <span style="color: #268bd2; font-weight: bold;">:custom-set</span>)))
                            (<span style="color: #859900; font-weight: bold;">when</span> (<span style="text-decoration: underline;">eq</span> (<span style="text-decoration: underline;">widget-get</span> widget <span style="color: #268bd2; font-weight: bold;">:custom-state</span>) 'modified)
                              (<span style="text-decoration: underline;">widget-apply</span> widget <span style="color: #268bd2; font-weight: bold;">:custom-set</span>)))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-Customize%20theme%20faces" class="outline-3">
<h3 id="Customize%20theme%20faces">Customize theme faces</h3>
<div class="outline-text-3" id="text-Customize%20theme%20faces">
<p>
Customize <code>THEME</code> with <code>FACES</code>.  Advises <code>enable-theme</code> with a function that customizes <code>FACES</code> when <code>THEME</code> is enabled.  If <code>THEME</code> is already enabled, also applies faces immediately.  Calls <code>custom-theme-set-faces</code>, which see.
</p>

<p>
For example:
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="text-decoration: underline;">unpackaged/customize-theme-faces</span> 'doom-solarized-dark
  `(font-lock-builtin-face ((t <span style="color: #268bd2; font-weight: bold;">:weight</span> bold <span style="color: #268bd2; font-weight: bold;">:foreground</span> <span style="color: #2aa198;">"#268bd2"</span>)))
  `(font-lock-comment-face ((t <span style="color: #268bd2; font-weight: bold;">:weight</span> bold <span style="color: #268bd2; font-weight: bold;">:slant</span> italic <span style="color: #268bd2; font-weight: bold;">:foreground</span> ,(doom-color 'comments))))
  `(org-list-dt ((t <span style="color: #268bd2; font-weight: bold;">:weight</span> bold)))
  `(org-link ((t <span style="color: #268bd2; font-weight: bold;">:inherit</span> link <span style="color: #268bd2; font-weight: bold;">:foreground</span> ,(doom-color 'cyan) <span style="color: #268bd2; font-weight: bold;">:weight</span> normal)))
  `(org-date ((t <span style="color: #268bd2; font-weight: bold;">:foreground</span> ,(doom-color 'yellow) <span style="color: #268bd2; font-weight: bold;">:weight</span> bold)))
  `(org-table ((t <span style="color: #268bd2; font-weight: bold;">:foreground</span> ,(doom-color 'green) <span style="color: #268bd2; font-weight: bold;">:family</span> <span style="color: #2aa198;">"monospace"</span>)))
  `(org-block-begin-line ((t <span style="color: #268bd2; font-weight: bold;">:weight</span> bold <span style="color: #268bd2; font-weight: bold;">:foreground</span> ,(doom-color 'comments) <span style="color: #268bd2; font-weight: bold;">:background</span> ,(doom-color 'base2) <span style="color: #268bd2; font-weight: bold;">:family</span> <span style="color: #2aa198;">"monospace"</span>)))
  `(org-meta-line ((t <span style="color: #268bd2; font-weight: bold;">:weight</span> bold <span style="color: #268bd2; font-weight: bold;">:foreground</span> ,(doom-color 'comments) <span style="color: #268bd2; font-weight: bold;">:family</span> <span style="color: #2aa198;">"monospace"</span>))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/customize-theme-faces</span> (theme <span style="color: #b58900;">&amp;rest</span> faces)
  <span style="color: #35a69c; font-style: italic;">"Customize THEME with FACES.</span>
<span style="color: #35a69c; font-style: italic;">Advises `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">enable-theme</span><span style="color: #35a69c; font-style: italic;">' with a function that customizes FACES when</span>
<span style="color: #35a69c; font-style: italic;">THEME is enabled.  If THEME is already enabled, also applies</span>
<span style="color: #35a69c; font-style: italic;">faces immediately.  Calls `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">custom-theme-set-faces</span><span style="color: #35a69c; font-style: italic;">', which see."</span>
  (<span style="color: #859900; font-weight: bold;">declare</span> (indent defun))
  (<span style="color: #859900; font-weight: bold;">when</span> (<span style="text-decoration: underline;">member</span> theme custom-enabled-themes)
    <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Theme already enabled: apply faces now.</span>
    (<span style="color: #859900; font-weight: bold;">let</span> ((custom--inhibit-theme-enable nil))
      (<span style="text-decoration: underline;">apply</span> #'custom-theme-set-faces theme faces)))
  (<span style="color: #859900; font-weight: bold;">let</span> ((fn-name (<span style="text-decoration: underline;">intern</span> (<span style="text-decoration: underline;">concat</span> <span style="color: #2aa198;">"unpackaged/enable-theme-advice-for-"</span> (<span style="text-decoration: underline;">symbol-name</span> theme)))))
    <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Apply advice for next time theme is enabled.</span>
    (<span style="text-decoration: underline;">fset</span> fn-name
          (<span style="color: #859900; font-weight: bold;">lambda</span> (enabled-theme)
            (<span style="color: #859900; font-weight: bold;">when</span> (<span style="text-decoration: underline;">eq</span> enabled-theme theme)
              (<span style="color: #859900; font-weight: bold;">let</span> ((custom--inhibit-theme-enable nil))
                (<span style="text-decoration: underline;">apply</span> #'custom-theme-set-faces theme faces)))))
    (<span style="text-decoration: underline;">advice-remove</span> #'enable-theme fn-name)
    (<span style="text-decoration: underline;">advice-add</span> #'enable-theme <span style="color: #268bd2; font-weight: bold;">:after</span> fn-name)))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-Elfeed" class="outline-2">
<h2 id="Elfeed">Elfeed&#xa0;&#xa0;&#xa0;<span class="tag"><span class="Elfeed">Elfeed</span></span></h2>
<div class="outline-text-2" id="text-Elfeed">
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #405A61; font-style: italic;">;;; </span><span style="color: #405A61; font-style: italic;">Elfeed</span>

</pre>
</div>
</div>

<div id="outline-container-Filter%20hydra" class="outline-3">
<h3 id="Filter%20hydra">Filter hydra</h3>
<div class="outline-text-3" id="text-Filter%20hydra">
<p>
<b>Requires:</b> <a href="https://github.com/jerrypnz/major-mode-hydra.el#pretty-hydra-define">pretty-hydra</a>
</p>

<p>
This macro defines a <a href="https://github.com/jerrypnz/major-mode-hydra.el#pretty-hydra-define">pretty-hydra</a> that makes it easy to toggle Elfeed filter components, which allows quickly building a custom filter with a few keystrokes.  You can add your own favorite tokens to the hydra with your own keybindings, and it also provides completion for feeds and tags from the Elfeed database.
</p>

<p>
This animation shows the example hydra from the docstring:
</p>

<p>

</p>

<p>
The example hydra:
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">unpackaged/elfeed-search-view-hydra-define</span> my/elfeed-search-view-hydra
  (<span style="color: #268bd2; font-weight: bold;">:foreign-keys</span> warn)
  (<span style="color: #2aa198;">"Views"</span>
   ((<span style="color: #2aa198;">"@"</span> <span style="color: #268bd2; font-weight: bold;">:complete-age</span> <span style="color: #2aa198;">"Date"</span>)
    (<span style="color: #2aa198;">"d"</span> nil))
   <span style="color: #2aa198;">"Status"</span>
   ((<span style="color: #2aa198;">"su"</span> <span style="color: #2aa198;">"+unread"</span>))
   <span style="color: #2aa198;">"Feed"</span>
   ((<span style="color: #2aa198;">"f TAB"</span> <span style="color: #268bd2; font-weight: bold;">:complete-feed</span> <span style="color: #2aa198;">"Choose"</span>)
    (<span style="color: #2aa198;">"fE"</span> <span style="color: #2aa198;">"=Planet Emacslife"</span> <span style="color: #2aa198;">"Planet Emacslife"</span>))
   <span style="color: #2aa198;">"Tags"</span>
   ((<span style="color: #2aa198;">"t TAB"</span> <span style="color: #268bd2; font-weight: bold;">:complete-tag</span> <span style="color: #2aa198;">"Choose"</span>)
    (<span style="color: #2aa198;">"te"</span> <span style="color: #2aa198;">"+Emacs"</span>))
   <span style="color: #2aa198;">""</span>
   ((<span style="color: #2aa198;">"tn"</span> <span style="color: #2aa198;">"+news"</span>))))
</pre>
</div>

<p>
The macro and function:
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #6c71c4;">elfeed-search-filter</span>)

(<span style="color: #859900; font-weight: bold;">cl-defmacro</span> <span style="color: #268bd2;">unpackaged/elfeed-search-view-hydra-define</span> (name body views)
  <span style="color: #35a69c; font-style: italic;">"Define a pretty hydra named NAME with BODY and VIEWS.</span>
<span style="color: #35a69c; font-style: italic;">VIEWS is a plist: in it, each property is a string which becomes</span>
<span style="color: #35a69c; font-style: italic;">a column header in the hydra, and each value is a list of lists</span>
<span style="color: #35a69c; font-style: italic;">in this format: (KEY COMPONENT &amp;optional LABEL).</span>

<span style="color: #35a69c; font-style: italic;">The KEY is a key sequence passed to `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">kbd</span><span style="color: #35a69c; font-style: italic;">', like \"s\" or \"S</span>
<span style="color: #35a69c; font-style: italic;">TAB\".  The COMPONENT is an Elfeed filter component, which may</span>
<span style="color: #35a69c; font-style: italic;">begin with \"+\" or \"=\", and in which spaces are automatically</span>
<span style="color: #35a69c; font-style: italic;">escaped as required by Elfeed.  The LABEL, if present, is a</span>
<span style="color: #35a69c; font-style: italic;">string displayed next to the KEY; if absent, COMPONENT is</span>
<span style="color: #35a69c; font-style: italic;">displayed.</span>

<span style="color: #35a69c; font-style: italic;">In the resulting hydra, when KEY is pressed, the COMPONENT is</span>
<span style="color: #35a69c; font-style: italic;">toggled in `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">elfeed-search-filter</span><span style="color: #35a69c; font-style: italic;">'.  It is toggled between three</span>
<span style="color: #35a69c; font-style: italic;">states: normal, inverse, and absent.  For example, the component</span>
<span style="color: #35a69c; font-style: italic;">\"+tag\" cycles between three states in the filter: \"+tag\",</span>
<span style="color: #35a69c; font-style: italic;">\"-tag\", and \"\".  The appropriate inverse prefix is used</span>
<span style="color: #35a69c; font-style: italic;">according to the component's prefix (i.e. for \"=\", the inverse</span>
<span style="color: #35a69c; font-style: italic;">is \"~\", and for \"\" (a plain regexp), \"!\" is used).</span>

<span style="color: #35a69c; font-style: italic;">These special components may be used to read choices from the</span>
<span style="color: #35a69c; font-style: italic;">Elfeed database with completion and toggle them:</span>

<span style="color: #35a69c; font-style: italic;">  :complete-age   Completes and sets the age token.</span>
<span style="color: #35a69c; font-style: italic;">  :complete-feed  Completes and toggles a feed token.</span>
<span style="color: #35a69c; font-style: italic;">  :complete-tag   Completes and toggles a tag token.</span>
<span style="color: #35a69c; font-style: italic;">  nil             Sets default filter.</span>

<span style="color: #35a69c; font-style: italic;">A complete example:</span>

<span style="color: #35a69c; font-style: italic;">  (unpackaged/elfeed-search-view-hydra-define my/elfeed-search-view-hydra</span>
<span style="color: #35a69c; font-style: italic;">    (:foreign-keys warn)</span>
<span style="color: #35a69c; font-style: italic;">    (\"Views\"</span>
<span style="color: #35a69c; font-style: italic;">     ((\"@\" :complete-age \"Date\")</span>
<span style="color: #35a69c; font-style: italic;">      (\"d\" nil))</span>
<span style="color: #35a69c; font-style: italic;">     \"Status\"</span>
<span style="color: #35a69c; font-style: italic;">     ((\"su\" \"+unread\"))</span>
<span style="color: #35a69c; font-style: italic;">     \"Feed\"</span>
<span style="color: #35a69c; font-style: italic;">     ((\"f TAB\" :complete-feed \"Choose\")</span>
<span style="color: #35a69c; font-style: italic;">      (\"fE\" \"=Planet Emacslife\" \"Planet Emacslife\"))</span>
<span style="color: #35a69c; font-style: italic;">     \"Tags\"</span>
<span style="color: #35a69c; font-style: italic;">     ((\"t TAB\" :complete-tag \"Choose\")</span>
<span style="color: #35a69c; font-style: italic;">      (\"te\" \"+Emacs\"))</span>
<span style="color: #35a69c; font-style: italic;">     \"\"</span>
<span style="color: #35a69c; font-style: italic;">     ((\"tn\" \"+news\"))))"</span>
  (<span style="color: #859900; font-weight: bold;">declare</span> (indent defun))
  (<span style="color: #859900; font-weight: bold;">cl-labels</span> ((escape-spaces (<span style="text-decoration: underline;">string</span>)
                             <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Return STRING with spaces escaped with "\s-".  Necessary</span>
                             <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">because Elfeed treats all literal spaces as separating tokens.</span>
                             (<span style="text-decoration: underline;">replace-regexp-in-string</span> (<span style="color: #859900; font-weight: bold;">rx</span> space) <span style="color: #2aa198;">"\\s-"</span> string t t)))
    (<span style="color: #859900; font-weight: bold;">let*</span> ((completion-fns
            (<span style="text-decoration: underline;">list</span> (<span style="text-decoration: underline;">cons</span> <span style="color: #268bd2; font-weight: bold;">:complete-age</span>
                        (<span style="color: #859900; font-weight: bold;">lambda</span> ()
                          (<span style="color: #859900; font-weight: bold;">interactive</span>)
                          (<span style="color: #859900; font-weight: bold;">save-match-data</span>
                            (<span style="color: #859900; font-weight: bold;">let*</span> ((date-regexp (<span style="color: #859900; font-weight: bold;">rx</span> (group (<span style="color: #859900; font-weight: bold;">or</span> bos blank) <span style="color: #2aa198;">"@"</span> (<span style="text-decoration: underline;">1+</span> digit) (<span style="text-decoration: underline;">1+</span> (<span style="text-decoration: underline;">not</span> blank)))))
                                   (date-tag (<span style="color: #859900; font-weight: bold;">when</span> (<span style="text-decoration: underline;">string-match</span> date-regexp elfeed-search-filter)
                                               (<span style="text-decoration: underline;">match-string</span> 1 elfeed-search-filter))))
                              (elfeed-search-set-filter
                               (<span style="text-decoration: underline;">replace-regexp-in-string</span> date-regexp (<span style="text-decoration: underline;">read-string</span> <span style="color: #2aa198;">"Date: "</span> date-tag)
                                                         elfeed-search-filter t t))))))
                  (<span style="text-decoration: underline;">cons</span> <span style="color: #268bd2; font-weight: bold;">:complete-feed</span>
                        '(concat <span style="color: #2aa198;">"="</span> (<span style="text-decoration: underline;">replace-regexp-in-string</span>
                                      (<span style="color: #859900; font-weight: bold;">rx</span> space) <span style="color: #2aa198;">"\\s-"</span>
                                      (<span style="color: #859900; font-weight: bold;">-&gt;&gt;</span> (<span style="text-decoration: underline;">hash-table-values</span> elfeed-db-feeds)
                                           (<span style="color: #859900; font-weight: bold;">--map</span> (elfeed-meta it <span style="color: #268bd2; font-weight: bold;">:title</span>))
                                           (<span style="text-decoration: underline;">completing-read</span> <span style="color: #2aa198;">"Feed: "</span>)
                                           regexp-quote) <span style="color: #b58900;">t t)))</span>
                  (<span style="text-decoration: underline;">cons</span> <span style="color: #268bd2; font-weight: bold;">:complete-tag</span>
                        '(concat <span style="color: #2aa198;">"+"</span> (<span style="text-decoration: underline;">completing-read</span> <span style="color: #2aa198;">"Tag: "</span> (elfeed-db-get-all-tags))))))
           (body (<span style="text-decoration: underline;">append</span> '(<span style="color: #268bd2; font-weight: bold;">:title</span> elfeed-search-filter <span style="color: #268bd2; font-weight: bold;">:color</span> pink <span style="color: #268bd2; font-weight: bold;">:hint</span> t <span style="color: #268bd2; font-weight: bold;">:quit-key</span> <span style="color: #2aa198;">"q"</span>)
                         body))
           (heads (<span style="color: #859900; font-weight: bold;">cl-loop</span> for (heading views) on views by #'cddr
                           collect heading
                           collect (<span style="color: #859900; font-weight: bold;">cl-loop</span> for (key component label) in views
                                            collect
                                            `(,key
                                              ,(<span style="color: #859900; font-weight: bold;">cl-typecase</span> component
                                                 ((<span style="color: #859900; font-weight: bold;">and</span> function (<span style="text-decoration: underline;">not</span> null))
                                                  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">I don't understand why nil matches</span>
                                                  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">(or lambda function), but it does,</span>
                                                  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">so we have to account for it.  See</span>
                                                  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">(</span><span style="color: #405A61; font-style: italic; text-decoration: underline;">info-lookup-symbol</span><span style="color: #405A61; font-style: italic;"> 'cl-typep).</span>
                                                  `(funcall ,component))
                                                 (<span style="text-decoration: underline;">string</span>
                                                  `(elfeed-search-set-filter
                                                    (<span style="text-decoration: underline;">unpackaged/elfeed-search-filter-toggle-component</span>
                                                     elfeed-search-filter ,(escape-spaces component))))
                                                 (otherwise
                                                  `(elfeed-search-set-filter
                                                    ,(<span style="color: #859900; font-weight: bold;">when</span> component
                                                       `(unpackaged/elfeed-search-filter-toggle-component
                                                         elfeed-search-filter ,component)))))
                                              ,(<span style="color: #859900; font-weight: bold;">or</span> label component <span style="color: #2aa198;">"Default"</span>))))))
      <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">I am so glad I discovered `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">cl-sublis</span><span style="color: #405A61; font-style: italic;">'.  I tried several variations of `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">cl-labels</span><span style="color: #405A61; font-style: italic;">' and</span>
      <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">`</span><span style="color: #d33682; font-weight: bold; font-style: italic;">cl-macrolet</span><span style="color: #405A61; font-style: italic;">' and `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">cl-symbol-macrolet</span><span style="color: #405A61; font-style: italic;">', but this is the only way that has worked.</span>
      (<span style="color: #859900; font-weight: bold;">setf</span> heads (<span style="text-decoration: underline;">cl-sublis</span> completion-fns heads))
      `(<span style="color: #859900; font-weight: bold;">pretty-hydra-define</span> ,name ,body
         ,heads))))

(<span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #268bd2;">unpackaged/elfeed-search-filter-toggle-component</span> (<span style="text-decoration: underline;">string</span> component)
  <span style="color: #35a69c; font-style: italic;">"Return STRING (which should be `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">elfeed-search-filter</span><span style="color: #35a69c; font-style: italic;">') having toggled COMPONENT.</span>
<span style="color: #35a69c; font-style: italic;">Tries to intelligently handle components based on their prefix:</span>
<span style="color: #35a69c; font-style: italic;">+tag, =feed, regexp."</span>
  (<span style="color: #859900; font-weight: bold;">save-match-data</span>
    (<span style="color: #859900; font-weight: bold;">cl-labels</span> ((toggle (component +prefix -prefix string)
                        (<span style="color: #859900; font-weight: bold;">let</span> ((+pat (<span style="text-decoration: underline;">rx-to-string</span> `(seq (<span style="color: #859900; font-weight: bold;">or</span> bos blank)
                                                        (group ,+prefix ,component)
                                                        (<span style="color: #859900; font-weight: bold;">or</span> eos blank))))
                              (-pat (<span style="text-decoration: underline;">rx-to-string</span> `(seq (group (<span style="color: #859900; font-weight: bold;">or</span> bos (<span style="text-decoration: underline;">1+</span> blank)) ,-prefix ,component)
                                                        (<span style="color: #859900; font-weight: bold;">or</span> eos blank)))))
                          <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #cc9393; font-style: italic;">TODO</span><span style="color: #405A61; font-style: italic;">: In newer Emacs versions, the `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">rx</span><span style="color: #405A61; font-style: italic;">' pattern `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">literal</span><span style="color: #405A61; font-style: italic;">'</span>
                          <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">evaluates at runtime in `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">pcase</span><span style="color: #405A61; font-style: italic;">' expressions.</span>
                          (<span style="color: #859900; font-weight: bold;">pcase</span> string
                            ((pred (<span style="text-decoration: underline;">string-match</span> +pat)) (rm (<span style="text-decoration: underline;">concat</span> -prefix component) string))
                            ((pred (<span style="text-decoration: underline;">string-match</span> -pat)) (rm <span style="color: #2aa198;">""</span> string))
                            (_ (<span style="text-decoration: underline;">concat</span> string <span style="color: #2aa198;">" "</span> +prefix component)))))
                (rm (new string) (<span style="text-decoration: underline;">replace-match</span> new t t string 1)))
      (<span style="color: #859900; font-weight: bold;">pcase</span> component
        ((<span style="color: #859900; font-weight: bold;">rx</span> bos <span style="color: #2aa198;">"+"</span> (group (<span style="text-decoration: underline;">1+</span> anything)))
         (toggle (<span style="text-decoration: underline;">match-string</span> 1 component) <span style="color: #2aa198;">"+"</span> <span style="color: #2aa198;">"-"</span> string))
        ((<span style="color: #859900; font-weight: bold;">rx</span> bos <span style="color: #2aa198;">"="</span> (group (<span style="text-decoration: underline;">1+</span> anything)))
         (toggle (<span style="text-decoration: underline;">match-string</span> 1 component) <span style="color: #2aa198;">"="</span> <span style="color: #2aa198;">"~"</span> string))
        (_ (toggle component <span style="color: #2aa198;">""</span> <span style="color: #2aa198;">"!"</span> string))))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-Meta" class="outline-2">
<h2 id="Meta">Meta&#xa0;&#xa0;&#xa0;<span class="tag"><span class="meta">meta</span></span></h2>
<div class="outline-text-2" id="text-Meta">
<p>
Code used to help maintain this document.  (Note: These links don't work in GitHub's renderer.)
</p>

<ul class="org-ul">
<li></li>
</ul>
</div>
</div>

<div id="outline-container-Misc" class="outline-2">
<h2 id="Misc">Misc</h2>
<div class="outline-text-2" id="text-Misc">
</div>
<div id="outline-container-Define%20a%20%22chooser%22%20command" class="outline-3">
<h3 id="Define%20a%20%22chooser%22%20command">Define a "chooser" command</h3>
<div class="outline-text-3" id="text-Define%20a%20%22chooser%22%20command">
<p>
This macro defines a "chooser" command, which allows the user to use completion to choose a lambda function to run.  It's helpful for grouping related functions together, or swapping between choices which can be set from Lisp code.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">defmacro</span> <span style="color: #268bd2;">unpackaged/define-chooser</span> (name <span style="color: #b58900;">&amp;rest</span> choices)
  <span style="color: #35a69c; font-style: italic;">"Define a chooser command NAME offering CHOICES.</span>
<span style="color: #35a69c; font-style: italic;">Each of CHOICES should be a list, the first of which is the</span>
<span style="color: #35a69c; font-style: italic;">choice's name, and the rest of which is its body forms."</span>
  (<span style="color: #859900; font-weight: bold;">declare</span> (indent defun))
  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Avoid redefining existing, non-chooser functions.</span>
  (<span style="color: #b58900;">cl-assert</span> (<span style="color: #859900; font-weight: bold;">or</span> (<span style="text-decoration: underline;">not</span> (<span style="text-decoration: underline;">fboundp</span> name))
                 (<span style="text-decoration: underline;">get</span> name <span style="color: #268bd2; font-weight: bold;">:unpackaged/define-chooser</span>)))
  (<span style="color: #859900; font-weight: bold;">let*</span> ((choice-names (<span style="text-decoration: underline;">mapcar</span> #'car choices))
         (choice-list (<span style="color: #859900; font-weight: bold;">--map</span> (<span style="text-decoration: underline;">cons</span> (<span style="text-decoration: underline;">car</span> it) `(<span style="color: #859900; font-weight: bold;">lambda</span> (<span style="color: #b58900;">&amp;rest</span> args)
                                               ,@(cdr it)))
                             choices))
         (prompt (<span style="text-decoration: underline;">format</span> <span style="color: #2aa198;">"Choose %s: "</span> name))
         (docstring (<span style="text-decoration: underline;">concat</span> <span style="color: #2aa198;">"Choose between: "</span> (<span style="text-decoration: underline;">s-join</span> <span style="color: #2aa198;">", "</span> choice-names))))
    `(<span style="color: #859900; font-weight: bold;">progn</span>
       (<span style="color: #859900; font-weight: bold;">defun</span> ,name ()
         ,docstring
         (<span style="color: #859900; font-weight: bold;">interactive</span>)
         (<span style="color: #859900; font-weight: bold;">let*</span> ((choice-name (<span style="text-decoration: underline;">completing-read</span> ,prompt ',choice-names)))
           (<span style="text-decoration: underline;">funcall</span> (<span style="text-decoration: underline;">alist-get</span> choice-name ',choice-list nil nil #'equal))))
       (<span style="text-decoration: underline;">put</span> ',name <span style="color: #268bd2; font-weight: bold;">:unpackaged/define-chooser</span> t))))
</pre>
</div>

<p>
This example shows using it to set <a href="https://github.com/alphapapa/prism.el">prism.el</a> themes by calling <code>prism-set-colors</code> in each choice.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">unpackaged/define-chooser</span> ap/prism-theme
  (<span style="color: #2aa198;">"Keen"</span>
   (<span style="text-decoration: underline;">prism-set-colors</span> <span style="color: #268bd2; font-weight: bold;">:num</span> 16
     <span style="color: #268bd2; font-weight: bold;">:local</span> (<span style="color: #859900; font-weight: bold;">pcase</span> current-prefix-arg
              ('(16) 'reset)
              (_ current-prefix-arg))
     <span style="color: #268bd2; font-weight: bold;">:desaturations</span> (<span style="color: #859900; font-weight: bold;">cl-loop</span> for i from 0 below 16
                             collect (* i 2.5))
     <span style="color: #268bd2; font-weight: bold;">:lightens</span> (<span style="color: #859900; font-weight: bold;">cl-loop</span> for i from 0 below 16
                        collect (* i 2.5))
     <span style="color: #268bd2; font-weight: bold;">:colors</span> (<span style="text-decoration: underline;">list</span> <span style="color: #2aa198;">"sandy brown"</span> <span style="color: #2aa198;">"dodgerblue"</span> <span style="color: #2aa198;">"medium sea green"</span>)
     <span style="color: #268bd2; font-weight: bold;">:comments-fn</span> (<span style="color: #859900; font-weight: bold;">lambda</span> (color)
                    (<span style="text-decoration: underline;">prism-blend</span> color (<span style="text-decoration: underline;">face-attribute</span> 'font-lock-comment-face <span style="color: #268bd2; font-weight: bold;">:foreground</span>)
                                 0.25))
     <span style="color: #268bd2; font-weight: bold;">:strings-fn</span> (<span style="color: #859900; font-weight: bold;">lambda</span> (color)
                   (<span style="text-decoration: underline;">prism-blend</span> color <span style="color: #2aa198;">"white"</span> 0.5))))
  (<span style="color: #2aa198;">"Solarized: rainbow"</span>
   (<span style="text-decoration: underline;">prism-set-colors</span> <span style="color: #268bd2; font-weight: bold;">:num</span> 24
     <span style="color: #268bd2; font-weight: bold;">:local</span> (<span style="color: #859900; font-weight: bold;">pcase</span> current-prefix-arg
              ('(16) 'reset)
              (_ current-prefix-arg))
     <span style="color: #268bd2; font-weight: bold;">:lightens</span> '(5 15 25)
     <span style="color: #268bd2; font-weight: bold;">:colors</span> (solarized-with-color-variables 'dark
               (<span style="text-decoration: underline;">list</span> red orange yellow green blue cyan violet magenta))
     <span style="color: #268bd2; font-weight: bold;">:comments-fn</span> (<span style="color: #859900; font-weight: bold;">lambda</span> (color)
                    (<span style="color: #859900; font-weight: bold;">--&gt;</span> color
                         (<span style="text-decoration: underline;">color-desaturate-name</span> it 50)))
     <span style="color: #268bd2; font-weight: bold;">:strings-fn</span> (<span style="color: #859900; font-weight: bold;">lambda</span> (color)
                   (<span style="text-decoration: underline;">prism-blend</span> color <span style="color: #2aa198;">"white"</span> 0.5))))
  (<span style="color: #2aa198;">"Solarized: rainbow inverted"</span>
   (<span style="text-decoration: underline;">prism-set-colors</span> <span style="color: #268bd2; font-weight: bold;">:num</span> 24
     <span style="color: #268bd2; font-weight: bold;">:local</span> (<span style="color: #859900; font-weight: bold;">pcase</span> current-prefix-arg
              ('(16) 'reset)
              (_ current-prefix-arg))
     <span style="color: #268bd2; font-weight: bold;">:lightens</span> '(5 15 25)
     <span style="color: #268bd2; font-weight: bold;">:colors</span> (solarized-with-color-variables 'dark
               (<span style="text-decoration: underline;">nreverse</span> (<span style="text-decoration: underline;">list</span> red orange yellow green blue cyan violet magenta)))
     <span style="color: #268bd2; font-weight: bold;">:comments-fn</span> (<span style="color: #859900; font-weight: bold;">lambda</span> (color)
                    (<span style="color: #859900; font-weight: bold;">--&gt;</span> color
                         (<span style="text-decoration: underline;">color-desaturate-name</span> it 50)))
     <span style="color: #268bd2; font-weight: bold;">:strings-fn</span> (<span style="color: #859900; font-weight: bold;">lambda</span> (color)
                   (<span style="text-decoration: underline;">prism-blend</span> color <span style="color: #2aa198;">"white"</span> 0.5)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-Obfuscate%20buffer%20text%20with%20%2Florem%20ipsum%2F%20words" class="outline-3">
<h3 id="Obfuscate%20buffer%20text%20with%20%2Florem%20ipsum%2F%20words">Obfuscate buffer text with <i>lorem ipsum</i> words</h3>
<div class="outline-text-3" id="text-Obfuscate%20buffer%20text%20with%20%2Florem%20ipsum%2F%20words">
<p>
When taking a screenshot, one may not want to reveal the text that is in it.  Rather than editing the screenshot to hide the text, one can use this command to temporarily overlay text in a buffer with <i>lorem ipsum</i> words, which present a similar appearance without any meaning.
</p>

<p>
<b>Requires:</b>
</p>
<ul class="org-ul">
<li><a href="https://github.com/jschaf/emacs-lorem-ipsum">emacs-lorem-ipsum</a></li>
</ul>

<p>

</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">defcustom</span> <span style="color: #6c71c4;">unpackaged/lorem-ipsum-overlay-exclude</span> nil
  <span style="color: #35a69c; font-style: italic;">"List of regexps to exclude from `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">unpackaged/lorem-ipsum-overlay</span><span style="color: #35a69c; font-style: italic;">'."</span>
  <span style="color: #268bd2; font-weight: bold;">:type</span> '(repeat regexp))

<span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #268bd2;">unpackaged/lorem-ipsum-overlay</span> (<span style="color: #b58900;">&amp;key</span> replace-p use-map-p)
  <span style="color: #35a69c; font-style: italic;">"Overlay all text in current buffer with \"lorem ipsum\" text.</span>
<span style="color: #35a69c; font-style: italic;">When called again, remove overlays.  Useful for taking</span>
<span style="color: #35a69c; font-style: italic;">screenshots without revealing buffer contents.</span>

<span style="color: #35a69c; font-style: italic;">If REPLACE-P is non-nil (interactively, with prefix and prompt),</span>
<span style="color: #35a69c; font-style: italic;">replace buffer contents rather than overlaying them.  When a</span>
<span style="color: #35a69c; font-style: italic;">buffer is very large and would have so many overlays that</span>
<span style="color: #35a69c; font-style: italic;">performance would be prohibitively slow, you may replace the</span>
<span style="color: #35a69c; font-style: italic;">buffer contents instead.  (Of course, be careful about saving the</span>
<span style="color: #35a69c; font-style: italic;">buffer after replacing its contents.)</span>

<span style="color: #35a69c; font-style: italic;">If USE-MAP-P is non-nil (interactively, with prefix and prompt),</span>
<span style="color: #35a69c; font-style: italic;">all instances of a real word are replaced with the same word;</span>
<span style="color: #35a69c; font-style: italic;">otherwise, each instance of a real word is replaced with a random</span>
<span style="color: #35a69c; font-style: italic;">word (further obscuring the text).</span>

<span style="color: #35a69c; font-style: italic;">Each piece of non-whitespace text in the buffer is compared with</span>
<span style="color: #35a69c; font-style: italic;">regexps in `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">unpackaged/lorem-ipsum-overlay-exclude</span><span style="color: #35a69c; font-style: italic;">', and ones</span>
<span style="color: #35a69c; font-style: italic;">that match are not overlaid.  Note that the regexps are compared</span>
<span style="color: #35a69c; font-style: italic;">against the entire non-whitespace token, up-to and including the</span>
<span style="color: #35a69c; font-style: italic;">preceding whitespace, but only the alphabetic part of the token</span>
<span style="color: #35a69c; font-style: italic;">is overlaid.  For example, in an Org buffer, a line that starts</span>
<span style="color: #35a69c; font-style: italic;">with:</span>

<span style="color: #35a69c; font-style: italic;">  #+TITLE: unpackaged.el</span>

<span style="color: #35a69c; font-style: italic;">could be matched against the exclude regexp (in `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">rx</span><span style="color: #35a69c; font-style: italic;">' syntax):</span>

<span style="color: #35a69c; font-style: italic;">  (rx (or bol bos blank) \"#+\" (</span><span style="color: #35a69c; font-style: italic; text-decoration: underline;">1+</span><span style="color: #35a69c; font-style: italic;"> alnum) \":\" (or eol eos blank))</span>

<span style="color: #35a69c; font-style: italic;">And the line would be overlaid like:</span>

<span style="color: #35a69c; font-style: italic;">  #+TITLE: parturient.et"</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span> (<span style="color: #859900; font-weight: bold;">when</span> current-prefix-arg
                 (<span style="text-decoration: underline;">list</span> <span style="color: #268bd2; font-weight: bold;">:replace-p</span> (<span style="text-decoration: underline;">yes-or-no-p</span> <span style="color: #2aa198;">"Replace contents (or just overlay)? "</span>)
                       <span style="color: #268bd2; font-weight: bold;">:use-map-p</span> (<span style="text-decoration: underline;">yes-or-no-p</span> <span style="color: #2aa198;">"Map words (or be completely random)? "</span>))))
  (<span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #d33682; font-weight: bold;">lorem-ipsum</span>)
  (<span style="color: #859900; font-weight: bold;">let</span> ((ovs (<span style="text-decoration: underline;">overlays-in</span> (<span style="text-decoration: underline;">point-min</span>) (<span style="text-decoration: underline;">point-max</span>))))
    (<span style="color: #859900; font-weight: bold;">if</span> (<span style="color: #859900; font-weight: bold;">cl-loop</span> for ov in ovs
                 thereis (<span style="text-decoration: underline;">overlay-get</span> ov <span style="color: #268bd2; font-weight: bold;">:lorem-ipsum-overlay</span>))
        <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Remove overlays.</span>
        (<span style="color: #859900; font-weight: bold;">dolist</span> (<span style="text-decoration: underline;">ov</span> ovs)
          (<span style="color: #859900; font-weight: bold;">when</span> (<span style="text-decoration: underline;">overlay-get</span> ov <span style="color: #268bd2; font-weight: bold;">:lorem-ipsum-overlay</span>)
            (<span style="text-decoration: underline;">delete-overlay</span> ov)))
      <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Add overlays.</span>
      (<span style="color: #859900; font-weight: bold;">let</span> ((lorem-ipsum-words (<span style="color: #859900; font-weight: bold;">--&gt;</span> lorem-ipsum-text
                                    (<span style="text-decoration: underline;">-flatten</span> it) (<span style="text-decoration: underline;">apply</span> #'concat it)
                                    (<span style="text-decoration: underline;">split-string</span> it (<span style="color: #859900; font-weight: bold;">rx</span> (<span style="color: #859900; font-weight: bold;">or</span> space punct)) 'omit-nulls)))
            (case-fold-search nil)
            (map (<span style="text-decoration: underline;">make-hash-table</span> <span style="color: #268bd2; font-weight: bold;">:test</span> #'equal)))
        (<span style="color: #859900; font-weight: bold;">cl-labels</span> ((overlay-group (group)
                                   (<span style="color: #859900; font-weight: bold;">let*</span> ((beg (<span style="text-decoration: underline;">match-beginning</span> group))
                                          (end (<span style="text-decoration: underline;">match-end</span> group))
                                          (replacement-word (<span style="color: #859900; font-weight: bold;">if</span> use-map-p
                                                                (lorem-word* (<span style="text-decoration: underline;">match-string-no-properties</span> group))
                                                              (lorem-word (<span style="text-decoration: underline;">match-string-no-properties</span> group))))
                                          (<span style="text-decoration: underline;">ov</span> (<span style="text-decoration: underline;">make-overlay</span> beg end)))
                                     (<span style="color: #859900; font-weight: bold;">when</span> replacement-word
                                       (<span style="text-decoration: underline;">overlay-put</span> ov <span style="color: #268bd2; font-weight: bold;">:lorem-ipsum-overlay</span> t)
                                       (<span style="text-decoration: underline;">overlay-put</span> ov 'display replacement-word))))
                    (replace-group (group)
                                   (<span style="color: #859900; font-weight: bold;">let*</span> ((beg (<span style="text-decoration: underline;">match-beginning</span> group))
                                          (end (<span style="text-decoration: underline;">match-end</span> group))
                                          (replacement-word (<span style="color: #859900; font-weight: bold;">if</span> use-map-p
                                                                (lorem-word* (<span style="text-decoration: underline;">match-string-no-properties</span> group))
                                                              (lorem-word (<span style="text-decoration: underline;">match-string-no-properties</span> group)))))
                                     (<span style="color: #859900; font-weight: bold;">when</span> replacement-word
                                       (<span style="color: #859900; font-weight: bold;">setf</span> (<span style="text-decoration: underline;">buffer-substring</span> beg end) replacement-word))))
                    (lorem-word (word)
                                (<span style="color: #859900; font-weight: bold;">if-let*</span> ((matches (lorem-matches (<span style="text-decoration: underline;">length</span> word))))
                                    (apply-case word (<span style="text-decoration: underline;">downcase</span> (<span style="text-decoration: underline;">seq-random-elt</span> matches)))
                                  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Word too long: compose one.</span>
                                  (apply-case word (<span style="text-decoration: underline;">downcase</span> (compose-word (<span style="text-decoration: underline;">length</span> word))))))
                    (lorem-word* (word)
                                 (<span style="color: #859900; font-weight: bold;">or</span> (<span style="text-decoration: underline;">gethash</span> word map)
                                     (<span style="text-decoration: underline;">puthash</span> word
                                              (<span style="color: #859900; font-weight: bold;">if-let</span> ((matches (lorem-matches (<span style="text-decoration: underline;">length</span> word))))
                                                  (apply-case word (<span style="text-decoration: underline;">downcase</span> (<span style="text-decoration: underline;">seq-random-elt</span> matches)))
                                                <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Word too long: compose one.</span>
                                                (apply-case word (<span style="text-decoration: underline;">downcase</span> (compose-word (<span style="text-decoration: underline;">length</span> word)))))
                                              map)))
                    (lorem-matches (<span style="text-decoration: underline;">length</span> <span style="color: #b58900;">&amp;optional</span> (comparator #'=))
                                   (<span style="color: #859900; font-weight: bold;">cl-loop</span> for liw in lorem-ipsum-words
                                            when (<span style="text-decoration: underline;">funcall</span> comparator (<span style="text-decoration: underline;">length</span> liw) length)
                                            collect liw))
                    (apply-case (source target)
                                (<span style="color: #859900; font-weight: bold;">cl-loop</span> for sc across-ref source
                                         for tc across-ref target
                                         when (<span style="text-decoration: underline;">not</span> (<span style="text-decoration: underline;">string-match-p</span> (<span style="color: #859900; font-weight: bold;">rx</span> lower) (<span style="text-decoration: underline;">char-to-string</span> sc)))
                                         do (<span style="color: #859900; font-weight: bold;">setf</span> tc (<span style="text-decoration: underline;">string-to-char</span> (<span style="text-decoration: underline;">upcase</span> (<span style="text-decoration: underline;">char-to-string</span> tc)))))
                                target)
                    (compose-word (<span style="text-decoration: underline;">length</span>)
                                  (<span style="color: #859900; font-weight: bold;">cl-loop</span> while (&gt; length 0)
                                           for word = (<span style="text-decoration: underline;">seq-random-elt</span> (lorem-matches length #'&lt;=))
                                           concat word
                                           do (<span style="color: #859900; font-weight: bold;">cl-decf</span> length (<span style="text-decoration: underline;">length</span> word)))))
          (<span style="color: #859900; font-weight: bold;">save-excursion</span>
            (<span style="text-decoration: underline;">goto-char</span> (<span style="text-decoration: underline;">point-min</span>))
            (<span style="color: #859900; font-weight: bold;">while</span> (<span style="text-decoration: underline;">re-search-forward</span> (<span style="color: #859900; font-weight: bold;">rx</span> (group (<span style="text-decoration: underline;">1+</span> (<span style="color: #859900; font-weight: bold;">or</span> bol bos blank (<span style="text-decoration: underline;">not</span> alpha)))
                                                 (0+ (<span style="text-decoration: underline;">not</span> (any alpha blank)))
                                                 (group (<span style="text-decoration: underline;">1+</span> alpha))
                                                 (0+ (<span style="text-decoration: underline;">not</span> (any alpha blank)))))
                                      nil t)
              (<span style="color: #859900; font-weight: bold;">unless</span> (<span style="text-decoration: underline;">cl-member</span> (<span style="text-decoration: underline;">match-string-no-properties</span> 0) unpackaged/lorem-ipsum-overlay-exclude
                                 <span style="color: #268bd2; font-weight: bold;">:test</span> (<span style="color: #859900; font-weight: bold;">lambda</span> (<span style="text-decoration: underline;">string</span> regexp)
                                         (<span style="text-decoration: underline;">string-match-p</span> regexp string)))
                (<span style="color: #859900; font-weight: bold;">if</span> replace-p
                    (replace-group 2)
                  (overlay-group 2)))
              (<span style="text-decoration: underline;">goto-char</span> (<span style="text-decoration: underline;">match-end</span> 2)))))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-Track%20metadata%20from%20MPRIS-supporting%20media%20player" class="outline-3">
<h3 id="Track%20metadata%20from%20MPRIS-supporting%20media%20player">Track metadata from MPRIS-supporting media player&#xa0;&#xa0;&#xa0;<span class="tag"><span class="DBus">DBus</span></span></h3>
<div class="outline-text-3" id="text-Track%20metadata%20from%20MPRIS-supporting%20media%20player">
<p>
Return the artist, album, and title of the track playing in MPRIS-supporting player.  Returns a string in format <code>ARTIST - ~ALBUM~: ~TITLE~ [PLAYER]</code>.  If no track is playing, returns nil.  If more than one player is playing, uses the first one found in DBus.  If <code>PLAYER</code> is non-nil, include the name of the player in the output string.
</p>

<p>
DBus is not a straightforward system to work with, so this may serve as a useful example, or save someone the trouble of figuring out how to get this metadata.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">eval-when-compile</span>
  (<span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #d33682; font-weight: bold;">dbus</span>))

(<span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #268bd2;">unpackaged/mpris-track</span> (<span style="color: #b58900;">&amp;optional</span> player)
  <span style="color: #35a69c; font-style: italic;">"Return the artist, album, and title of the track playing in MPRIS-supporting player.</span>
<span style="color: #35a69c; font-style: italic;">Returns a string in format \"ARTIST - ALBUM: TITLE [PLAYER]\".  If no track is</span>
<span style="color: #35a69c; font-style: italic;">playing, returns nil.  If more than one player is playing, uses</span>
<span style="color: #35a69c; font-style: italic;">the first one found in DBus.</span>

<span style="color: #35a69c; font-style: italic;">If PLAYER is non-nil, include the name of the player in the</span>
<span style="color: #35a69c; font-style: italic;">output string."</span>
  (<span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #d33682; font-weight: bold;">dbus</span>)
  (<span style="color: #859900; font-weight: bold;">when-let*</span> ((mpris-services (<span style="color: #859900; font-weight: bold;">--select</span> (<span style="text-decoration: underline;">string-prefix-p</span> <span style="color: #2aa198;">"org.mpris.MediaPlayer2."</span> it)
                                        (<span style="text-decoration: underline;">dbus-list-known-names</span> <span style="color: #268bd2; font-weight: bold;">:session</span>)))
              (playing-service (<span style="color: #859900; font-weight: bold;">--first</span> (<span style="text-decoration: underline;">string=</span> <span style="color: #2aa198;">"Playing"</span>
                                                 (<span style="text-decoration: underline;">dbus-get-property</span> <span style="color: #268bd2; font-weight: bold;">:session</span> it
                                                                    <span style="color: #2aa198;">"/org/mpris/MediaPlayer2"</span>
                                                                    <span style="color: #2aa198;">"org.mpris.MediaPlayer2.Player"</span>
                                                                    <span style="color: #2aa198;">"PlaybackStatus"</span>))
                                        mpris-services))
              (player-name (<span style="text-decoration: underline;">dbus-get-property</span> <span style="color: #268bd2; font-weight: bold;">:session</span> playing-service
                                              <span style="color: #2aa198;">"/org/mpris/MediaPlayer2"</span>
                                              <span style="color: #2aa198;">"org.mpris.MediaPlayer2"</span>
                                              <span style="color: #2aa198;">"Identity"</span>))
              (metadata (<span style="text-decoration: underline;">dbus-get-property</span> <span style="color: #268bd2; font-weight: bold;">:session</span> playing-service
                                           <span style="color: #2aa198;">"/org/mpris/MediaPlayer2"</span>
                                           <span style="color: #2aa198;">"org.mpris.MediaPlayer2.Player"</span>
                                           <span style="color: #2aa198;">"Metadata"</span>)))
    <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">`</span><span style="color: #d33682; font-weight: bold; font-style: italic;">-let</span><span style="color: #405A61; font-style: italic;">' makes it easy to get the actual strings out of the nested lists of lists of strings.</span>
    (<span style="color: #859900; font-weight: bold;">-let</span> (((<span style="color: #b58900;">&amp;alist</span> <span style="color: #2aa198;">"xesam:artist"</span> ((artists))
                    <span style="color: #2aa198;">"xesam:album"</span> ((album))
                    <span style="color: #2aa198;">"xesam:title"</span> ((title)))
            metadata))
      (<span style="text-decoration: underline;">format</span> <span style="color: #2aa198;">"%s - %s: %s%s"</span> (<span style="text-decoration: underline;">s-join</span> <span style="color: #2aa198;">", "</span> artists) album title
              (<span style="color: #859900; font-weight: bold;">if</span> player
                  (<span style="text-decoration: underline;">format</span> <span style="color: #2aa198;">" [%s]"</span> player-name)
                <span style="color: #2aa198;">""</span>)))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-Org" class="outline-2">
<h2 id="Org">Org&#xa0;&#xa0;&#xa0;<span class="tag"><span class="Org">Org</span></span></h2>
<div class="outline-text-2" id="text-Org">
<p>
Code for <a href="https://orgmode.org/">Org Mode</a>.
</p>
</div>


<div id="outline-container-Agenda" class="outline-3">
<h3 id="Agenda">Agenda&#xa0;&#xa0;&#xa0;<span class="tag"><span class="agenda">agenda</span></span></h3>
<div class="outline-text-3" id="text-Agenda">
</div>
<div id="outline-container-Agenda%20for%20subtree%20or%20region" class="outline-4">
<h4 id="Agenda%20for%20subtree%20or%20region">Agenda for subtree or region</h4>
<div class="outline-text-4" id="text-Agenda%20for%20subtree%20or%20region">
<p>
Display an agenda view for the current subtree or region.  With prefix, display only <code>TODO</code>-keyword items.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #6c71c4;">org-agenda-overriding-header</span>)
(<span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #6c71c4;">org-agenda-sorting-strategy</span>)
(<span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #6c71c4;">org-agenda-restrict</span>)
(<span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #6c71c4;">org-agenda-restrict-begin</span>)
(<span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #6c71c4;">org-agenda-restrict-end</span>)

<span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/org-agenda-current-subtree-or-region</span> (only-todos)
  <span style="color: #35a69c; font-style: italic;">"Display an agenda view for the current subtree or region.</span>
<span style="color: #35a69c; font-style: italic;"> With prefix, display only </span><span style="color: #cc9393; font-style: italic;">TODO</span><span style="color: #35a69c; font-style: italic;">-keyword items."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span> <span style="color: #2aa198;">"P"</span>)
  (<span style="color: #859900; font-weight: bold;">let</span> ((starting-point (<span style="text-decoration: underline;">point</span>))
        header)
    (<span style="color: #859900; font-weight: bold;">with-current-buffer</span> (<span style="color: #859900; font-weight: bold;">or</span> (<span style="text-decoration: underline;">buffer-base-buffer</span> (<span style="text-decoration: underline;">current-buffer</span>))
                             (<span style="text-decoration: underline;">current-buffer</span>))
      (<span style="color: #859900; font-weight: bold;">if</span> (<span style="text-decoration: underline;">use-region-p</span>)
          (<span style="color: #859900; font-weight: bold;">progn</span>
            (<span style="color: #859900; font-weight: bold;">setq</span> header <span style="color: #2aa198;">"Region"</span>)
            (<span style="text-decoration: underline;">put</span> 'org-agenda-files 'org-restrict (<span style="text-decoration: underline;">list</span> (<span style="text-decoration: underline;">buffer-file-name</span> (<span style="text-decoration: underline;">current-buffer</span>))))
            (<span style="color: #859900; font-weight: bold;">setq</span> org-agenda-restrict (<span style="text-decoration: underline;">current-buffer</span>))
            (<span style="text-decoration: underline;">move-marker</span> org-agenda-restrict-begin (<span style="text-decoration: underline;">region-beginning</span>))
            (<span style="text-decoration: underline;">move-marker</span> org-agenda-restrict-end
                         (<span style="color: #859900; font-weight: bold;">save-excursion</span>
                           <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">If point is at beginning of line, include</span>
                           <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">heading on that line by moving forward 1.</span>
                           (<span style="text-decoration: underline;">goto-char</span> (<span style="text-decoration: underline;">1+</span> (<span style="text-decoration: underline;">region-end</span>)))
                           (<span style="text-decoration: underline;">org-end-of-subtree</span>))))
        <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">No region; restrict to subtree.</span>
        (<span style="color: #859900; font-weight: bold;">save-excursion</span>
          (<span style="color: #859900; font-weight: bold;">save-restriction</span>
            <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">In case the command was called from an indirect buffer, set point</span>
            <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">in the base buffer to the same position while setting restriction.</span>
            (<span style="text-decoration: underline;">widen</span>)
            (<span style="text-decoration: underline;">goto-char</span> starting-point)
            (<span style="color: #859900; font-weight: bold;">setq</span> header <span style="color: #2aa198;">"Subtree"</span>)
            (<span style="text-decoration: underline;">org-agenda-set-restriction-lock</span>))))
      <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #d0bf8f; font-style: italic;">NOTE</span><span style="color: #405A61; font-style: italic;">: Unlike other agenda commands, binding `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">org-agenda-sorting-strategy</span><span style="color: #405A61; font-style: italic;">'</span>
      <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">around `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">org-search-view</span><span style="color: #405A61; font-style: italic;">' seems to have no effect.</span>
      (<span style="color: #859900; font-weight: bold;">let</span> ((org-agenda-sorting-strategy '(priority-down timestamp-up))
            (org-agenda-overriding-header header))
        (<span style="text-decoration: underline;">org-search-view</span> (<span style="color: #859900; font-weight: bold;">if</span> only-todos t nil) <span style="color: #2aa198;">"*"</span>))
      (<span style="text-decoration: underline;">org-agenda-remove-restriction-lock</span> t)
      (<span style="text-decoration: underline;">message</span> nil))))
</pre>
</div>
</div>
</div>

<div id="outline-container-Agenda%20for%20outline%20path" class="outline-4">
<h4 id="Agenda%20for%20outline%20path">Agenda for outline path</h4>
<div class="outline-text-4" id="text-Agenda%20for%20outline%20path">
<p>
Show an agenda restricted to subtree at <code>OUTLINE-PATH</code>.  <code>FILE</code> may be a filename to search in, or nil to look in the current buffer.  If <code>ONLY-TODOS</code> is non-nil, show only to-do items. <code>OUTLINE-PATH</code> is a list of strings which are outline headings.  See function <code>org-find-olp</code>.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/org-agenda-olp</span> (outline-path <span style="color: #b58900;">&amp;optional</span> file only-todos)
  <span style="color: #35a69c; font-style: italic;">"Show an agenda restricted to subtree at OUTLINE-PATH.</span>
<span style="color: #35a69c; font-style: italic;">FILE may be a filename to search in, or nil to look in the</span>
<span style="color: #35a69c; font-style: italic;">current buffer.  If ONLY-TODOS is non-nil, show only to-do</span>
<span style="color: #35a69c; font-style: italic;">items. OUTLINE-PATH is a list of strings which are outline</span>
<span style="color: #35a69c; font-style: italic;">headings.  See function `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">org-find-olp</span><span style="color: #35a69c; font-style: italic;">'."</span>
  (<span style="color: #859900; font-weight: bold;">when</span> file
    (<span style="color: #859900; font-weight: bold;">push</span> file outline-path))
  (<span style="color: #859900; font-weight: bold;">let</span> ((marker (<span style="text-decoration: underline;">org-find-olp</span> outline-path (<span style="text-decoration: underline;">not</span> file))))
    (<span style="color: #859900; font-weight: bold;">with-current-buffer</span> (<span style="text-decoration: underline;">marker-buffer</span> marker)
      (<span style="color: #859900; font-weight: bold;">org-with-wide-buffer</span>
       (<span style="text-decoration: underline;">goto-char</span> marker)
       (<span style="text-decoration: underline;">unpackaged/org-agenda-current-subtree-or-region</span> only-todos)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-Agenda%20previews" class="outline-4">
<h4 id="Agenda%20previews">Agenda previews</h4>
<div class="outline-text-4" id="text-Agenda%20previews">
<p>
<i>Before:</i>
</p>

<p>

</p>

<p>
<i>After:</i>
</p>

<p>

</p>

<p>
<b>Requires:</b>
</p>
<ul class="org-ul">
<li><a href="https://github.com/ShingoFukuyama/ov.el">ov</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">defface</span> <span style="color: #6c71c4;">unpackaged/org-agenda-preview</span>
  '((t (<span style="color: #268bd2; font-weight: bold;">:background</span> <span style="color: #2aa198;">"black"</span>)))
  <span style="color: #35a69c; font-style: italic;">"Face for Org Agenda previews."</span>
  <span style="color: #268bd2; font-weight: bold;">:group</span> 'org)

<span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/org-agenda-toggle-preview</span> ()
  <span style="color: #35a69c; font-style: italic;">"Toggle overlay of current item in agenda."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span>)
  (<span style="color: #859900; font-weight: bold;">if-let*</span> ((overlay (<span style="text-decoration: underline;">ov-in</span> 'unpackaged/org-agenda-preview t (<span style="text-decoration: underline;">line-end-position</span>) (<span style="text-decoration: underline;">line-end-position</span>))))
      <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Hide existing preview</span>
      (<span style="color: #859900; font-weight: bold;">ov-reset</span> overlay)
    <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Show preview</span>
    (<span style="color: #859900; font-weight: bold;">let*</span> ((entry-contents (<span style="color: #859900; font-weight: bold;">--&gt;</span> (<span style="color: #859900; font-weight: bold;">org-agenda-with-point-at-orig-entry</span>
                                 nil (<span style="text-decoration: underline;">buffer-substring</span> (<span style="color: #859900; font-weight: bold;">save-excursion</span>
                                                         (<span style="text-decoration: underline;">unpackaged/org-forward-to-entry-content</span> t)
                                                         (<span style="text-decoration: underline;">point</span>))
                                                       (<span style="text-decoration: underline;">org-entry-end-position</span>)))
                                s-trim
                                (<span style="text-decoration: underline;">concat</span> <span style="color: #2aa198;">"\n"</span> it <span style="color: #2aa198;">"\n"</span>))))
      (<span style="text-decoration: underline;">add-face-text-property</span> 0 (<span style="text-decoration: underline;">length</span> entry-contents)
                              'unpackaged/org-agenda-preview nil entry-contents)
      (<span style="text-decoration: underline;">ov</span> (<span style="text-decoration: underline;">line-end-position</span>) (<span style="text-decoration: underline;">line-end-position</span>)
          'unpackaged/org-agenda-preview t
          'before-string entry-contents))))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/org-forward-to-entry-content</span> (<span style="color: #b58900;">&amp;optional</span> unsafe)
  <span style="color: #35a69c; font-style: italic;">"Skip headline, planning line, and all drawers in current entry.</span>
<span style="color: #35a69c; font-style: italic;">If UNSAFE is non-nil, assume point is on headline."</span>
  (<span style="color: #859900; font-weight: bold;">unless</span> unsafe
    <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">To improve performance in loops (e.g. with `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">org-map-entries</span><span style="color: #405A61; font-style: italic;">')</span>
    (<span style="text-decoration: underline;">org-back-to-heading</span>))
  (<span style="color: #859900; font-weight: bold;">cl-loop</span> for element = (<span style="text-decoration: underline;">org-element-at-point</span>)
           for pos = (<span style="color: #859900; font-weight: bold;">pcase</span> element
                       (`(headline . ,_) (<span style="text-decoration: underline;">org-element-property</span> <span style="color: #268bd2; font-weight: bold;">:contents-begin</span> element))
                       (`(,(<span style="color: #859900; font-weight: bold;">or</span> 'planning 'property-drawer 'drawer) . ,_) (<span style="text-decoration: underline;">org-element-property</span> <span style="color: #268bd2; font-weight: bold;">:end</span> element)))
           while pos
           do (<span style="text-decoration: underline;">goto-char</span> pos)))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-Convert%20Elisp%20to%20Org%20format" class="outline-3">
<h3 id="Convert%20Elisp%20to%20Org%20format">Convert Elisp to Org format&#xa0;&#xa0;&#xa0;<span class="tag"><span class="meta">meta</span></span></h3>
<div class="outline-text-3" id="text-Convert%20Elisp%20to%20Org%20format">
<p>
These functions convert Emacs Lisp code and docstrings to Org-formatted text, helpful for inserting into readme files (like this one).
</p>

<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #268bd2;">unpackaged/package-org-docs</span> (<span style="color: #b58900;">&amp;optional</span> (package (<span style="text-decoration: underline;">unpackaged/buffer-provides</span>)))
  <span style="color: #35a69c; font-style: italic;">"Return documentation about PACKAGE as an Org string.</span>
<span style="color: #35a69c; font-style: italic;">Interactively, place on kill ring."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span>)
  (<span style="color: #859900; font-weight: bold;">let*</span> ((commands (<span style="color: #859900; font-weight: bold;">--map</span> (<span style="text-decoration: underline;">cons</span> it (<span style="color: #859900; font-weight: bold;">if</span> (<span style="text-decoration: underline;">documentation</span> it)
                                       (<span style="text-decoration: underline;">unpackaged/docstring-to-org</span> (<span style="text-decoration: underline;">documentation</span> it))
                                     <span style="color: #2aa198;">"Undocumented."</span>))
                          (<span style="text-decoration: underline;">-sort</span> (<span style="text-decoration: underline;">-on</span> #'string&lt; #'symbol-name)
                                 (<span style="text-decoration: underline;">unpackaged/package-commands</span> package))))
         (functions (<span style="text-decoration: underline;">seq-difference</span> (<span style="color: #859900; font-weight: bold;">--map</span> (<span style="text-decoration: underline;">cons</span> it (<span style="color: #859900; font-weight: bold;">if</span> (<span style="text-decoration: underline;">documentation</span> it)
                                                        (<span style="text-decoration: underline;">unpackaged/docstring-to-org</span> (<span style="text-decoration: underline;">documentation</span> it))
                                                      <span style="color: #2aa198;">"Undocumented."</span>))
                                           (<span style="text-decoration: underline;">-sort</span> (<span style="text-decoration: underline;">-on</span> #'string&lt; #'symbol-name)
                                                  (<span style="text-decoration: underline;">unpackaged/package-functions</span> package)))
                                    commands))
         (commands-string (<span style="color: #859900; font-weight: bold;">when</span> commands
                            (<span style="color: #859900; font-weight: bold;">-&gt;&gt;</span> commands
                                 (<span style="color: #859900; font-weight: bold;">--map</span> (<span style="text-decoration: underline;">format</span> <span style="color: #2aa198;">"+  ~%s%s~ :: %s"</span>
                                                (<span style="text-decoration: underline;">car</span> it)
                                                (<span style="color: #859900; font-weight: bold;">--when-let</span> (<span style="text-decoration: underline;">documentation</span> (<span style="text-decoration: underline;">car</span> it))
                                                  (<span style="text-decoration: underline;">concat</span> <span style="color: #2aa198;">" ("</span> (<span style="text-decoration: underline;">unpackaged/docstring-function-args</span> it) <span style="color: #2aa198;">")"</span>))
                                                (<span style="text-decoration: underline;">cdr</span> it)))
                                 (<span style="text-decoration: underline;">s-join</span> <span style="color: #2aa198;">"\n"</span>)
                                 (<span style="text-decoration: underline;">format</span> <span style="color: #2aa198;">"* Commands\n\n%s"</span>))))
         (functions-string (<span style="color: #859900; font-weight: bold;">when</span> functions
                             (<span style="color: #859900; font-weight: bold;">-&gt;&gt;</span> functions
                                  (<span style="color: #859900; font-weight: bold;">--map</span> (<span style="text-decoration: underline;">format</span> <span style="color: #2aa198;">"+  ~%s%s~ :: %s"</span>
                                                 (<span style="text-decoration: underline;">car</span> it)
                                                 (<span style="color: #859900; font-weight: bold;">--when-let</span> (<span style="text-decoration: underline;">documentation</span> (<span style="text-decoration: underline;">car</span> it))
                                                   (<span style="text-decoration: underline;">concat</span> <span style="color: #2aa198;">" ("</span> (<span style="text-decoration: underline;">unpackaged/docstring-function-args</span> it) <span style="color: #2aa198;">")"</span>))
                                                 (<span style="text-decoration: underline;">cdr</span> it)))
                                  (<span style="text-decoration: underline;">s-join</span> <span style="color: #2aa198;">"\n"</span>)
                                  (<span style="text-decoration: underline;">format</span> <span style="color: #2aa198;">"* Functions\n\n%s"</span>))))
         (<span style="text-decoration: underline;">string</span> (<span style="text-decoration: underline;">s-join</span> <span style="color: #2aa198;">"\n\n"</span> (<span style="text-decoration: underline;">list</span> commands-string functions-string))))
    (<span style="color: #859900; font-weight: bold;">if</span> (<span style="text-decoration: underline;">called-interactively-p</span> 'any)
        (<span style="color: #859900; font-weight: bold;">progn</span>
          (<span style="text-decoration: underline;">kill-new</span> string)
          (<span style="text-decoration: underline;">message</span> <span style="color: #2aa198;">"Documentation stored in kill ring"</span>))
      string)))

(<span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #268bd2;">unpackaged/package-commands</span> (<span style="color: #b58900;">&amp;optional</span> (package (<span style="text-decoration: underline;">unpackaged/buffer-provides</span>)))
  <span style="color: #35a69c; font-style: italic;">"Return list of command symbols in PACKAGE, or current buffer's package."</span>
  (<span style="color: #859900; font-weight: bold;">let*</span> ((functions (<span style="text-decoration: underline;">unpackaged/package-functions</span> package)))
    (<span style="text-decoration: underline;">-select</span> #'commandp functions)))

(<span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #268bd2;">unpackaged/package-functions</span> (<span style="color: #b58900;">&amp;optional</span> (package (<span style="text-decoration: underline;">unpackaged/buffer-provides</span>)))
  <span style="color: #35a69c; font-style: italic;">"Return list of functions defined in PACKAGE, or current buffer's package."</span>
  (<span style="color: #859900; font-weight: bold;">let*</span> ((prefix (<span style="text-decoration: underline;">symbol-name</span> package))
         (symbols))
    (<span style="text-decoration: underline;">mapatoms</span> (<span style="color: #859900; font-weight: bold;">lambda</span> (symbol)
                (<span style="color: #859900; font-weight: bold;">when</span> (<span style="text-decoration: underline;">string-prefix-p</span> prefix (<span style="text-decoration: underline;">symbol-name</span> symbol))
                  (<span style="color: #859900; font-weight: bold;">push</span> symbol symbols))))
    (<span style="color: #859900; font-weight: bold;">-&gt;&gt;</span> symbols
         (<span style="text-decoration: underline;">-select</span> #'fboundp)
         (<span style="color: #859900; font-weight: bold;">--select</span> (<span style="text-decoration: underline;">not</span> (<span style="text-decoration: underline;">string-suffix-p</span> <span style="color: #2aa198;">"--cmacro"</span> (<span style="text-decoration: underline;">symbol-name</span> it)))))))

(<span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #268bd2;">unpackaged/buffer-provides</span> (<span style="color: #b58900;">&amp;optional</span> (buffer (<span style="text-decoration: underline;">current-buffer</span>)))
  <span style="color: #35a69c; font-style: italic;">"Return symbol that Emacs package in BUFFER provides."</span>
  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">I couldn't find an existing function that does this, but this is simple enough.</span>
  (<span style="color: #859900; font-weight: bold;">with-current-buffer</span> buffer
    (<span style="color: #859900; font-weight: bold;">save-excursion</span>
      (<span style="text-decoration: underline;">goto-char</span> (<span style="text-decoration: underline;">point-max</span>))
      (<span style="text-decoration: underline;">re-search-backward</span> (<span style="color: #859900; font-weight: bold;">rx</span> bol <span style="color: #2aa198;">"(provide '"</span> (group (<span style="text-decoration: underline;">1+</span> (<span style="text-decoration: underline;">not</span> (any <span style="color: #2aa198;">")"</span>)))) <span style="color: #2aa198;">")"</span>))
      (<span style="text-decoration: underline;">intern</span> (<span style="text-decoration: underline;">match-string</span> 1)))))

<span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/elisp-to-org</span> ()
  <span style="color: #35a69c; font-style: italic;">"Convert elisp code in region to Org syntax and put in kill-ring.</span>
<span style="color: #35a69c; font-style: italic;">Extracts and converts docstring to Org text, and places code in</span>
<span style="color: #35a69c; font-style: italic;">source block."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span>)
  (<span style="color: #859900; font-weight: bold;">let*</span> ((raw (<span style="color: #859900; font-weight: bold;">-&gt;&gt;</span> (<span style="text-decoration: underline;">buffer-substring</span> (<span style="text-decoration: underline;">region-beginning</span>) (<span style="text-decoration: underline;">region-end</span>))
                   (<span style="text-decoration: underline;">replace-regexp-in-string</span> (<span style="color: #859900; font-weight: bold;">rx</span> bol) <span style="color: #2aa198;">"  "</span>)
                   (<span style="text-decoration: underline;">replace-regexp-in-string</span> (<span style="color: #859900; font-weight: bold;">rx</span> bol (<span style="text-decoration: underline;">1+</span> blank) eol) <span style="color: #2aa198;">""</span>)))
         (sexp (<span style="text-decoration: underline;">read</span> raw))
         (docstring (<span style="color: #859900; font-weight: bold;">--when-let</span> (<span style="text-decoration: underline;">-first</span> #'stringp sexp)
                      (<span style="text-decoration: underline;">unpackaged/docstring-to-org</span> it))))
    (<span style="text-decoration: underline;">kill-new</span> (<span style="text-decoration: underline;">concat</span> docstring (<span style="color: #859900; font-weight: bold;">when</span> docstring <span style="color: #2aa198;">"\n\n"</span>)
                      <span style="color: #2aa198;">"#+BEGIN_SRC elisp"</span> <span style="color: #2aa198;">"\n"</span>
                      raw <span style="color: #2aa198;">"\n"</span>
                      <span style="color: #2aa198;">"#+END_SRC"</span>))))

<span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/docstring-to-org</span> (docstring)
  <span style="color: #35a69c; font-style: italic;">"Return DOCSTRING as formatted Org text.</span>

<span style="color: #35a69c; font-style: italic;">Interactively, get text from region, and kill formatted Org text</span>
<span style="color: #35a69c; font-style: italic;">to kill-ring."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span> (<span style="text-decoration: underline;">list</span> (<span style="text-decoration: underline;">buffer-substring</span> (<span style="text-decoration: underline;">region-beginning</span>) (<span style="text-decoration: underline;">region-end</span>))))
  (<span style="color: #859900; font-weight: bold;">cl-macrolet</span> ((string-buffer--&gt; (<span style="text-decoration: underline;">string</span> <span style="color: #b58900;">&amp;rest</span> forms)
                                  `(<span style="color: #859900; font-weight: bold;">with-temp-buffer</span>
                                     (<span style="text-decoration: underline;">insert</span> ,string)
                                     ,@(<span style="color: #859900; font-weight: bold;">cl-loop</span> for form in forms
                                                collect `(goto-char (<span style="text-decoration: underline;">point-min</span>))
                                                collect form)
                                     (<span style="text-decoration: underline;">buffer-string</span>))))
    (<span style="color: #859900; font-weight: bold;">--&gt;</span> (string-buffer--&gt; docstring
                           (<span style="color: #859900; font-weight: bold;">progn</span>
                             <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Remove end-of-string function argument list</span>
                             (<span style="text-decoration: underline;">goto-char</span> (<span style="text-decoration: underline;">point-max</span>))
                             (<span style="color: #859900; font-weight: bold;">when</span> (<span style="text-decoration: underline;">re-search-backward</span> (<span style="color: #859900; font-weight: bold;">rx</span> <span style="color: #2aa198;">"\n\n"</span> <span style="color: #2aa198;">"(fn "</span> (group (<span style="text-decoration: underline;">1+</span> not-newline)) <span style="color: #2aa198;">")"</span> eos) nil t)
                               (<span style="text-decoration: underline;">replace-match</span> <span style="color: #2aa198;">""</span> t t)))
                           (<span style="text-decoration: underline;">unpackaged/caps-to-code</span> (<span style="text-decoration: underline;">point-min</span>) (<span style="text-decoration: underline;">point-max</span>))
                           (<span style="text-decoration: underline;">unpackaged/symbol-quotes-to-org-code</span> (<span style="text-decoration: underline;">point-min</span>) (<span style="text-decoration: underline;">point-max</span>))
                           (unfill-region (<span style="text-decoration: underline;">point-min</span>) (<span style="text-decoration: underline;">point-max</span>))
                           (<span style="color: #859900; font-weight: bold;">while</span> (<span style="text-decoration: underline;">re-search-forward</span> (<span style="color: #859900; font-weight: bold;">rx</span> bol (group (<span style="text-decoration: underline;">1+</span> blank))) nil t)
                             (<span style="text-decoration: underline;">replace-match</span> <span style="color: #2aa198;">""</span> t t nil 1))
                           (<span style="color: #859900; font-weight: bold;">while</span> (<span style="text-decoration: underline;">re-search-forward</span> <span style="color: #2aa198;">"\n"</span> nil t)
                             (<span style="text-decoration: underline;">replace-match</span> <span style="color: #2aa198;">"\n   "</span> t t))
                           (<span style="color: #859900; font-weight: bold;">when</span> (<span style="text-decoration: underline;">looking-at</span> <span style="color: #2aa198;">"\""</span>)
                             (<span style="text-decoration: underline;">delete-char</span> 1))
                           (<span style="color: #859900; font-weight: bold;">when</span> (<span style="color: #859900; font-weight: bold;">progn</span>
                                   (<span style="text-decoration: underline;">goto-char</span> (<span style="text-decoration: underline;">point-max</span>))
                                   (<span style="text-decoration: underline;">looking-back</span> <span style="color: #2aa198;">"\""</span> nil))
                             (<span style="text-decoration: underline;">delete-char</span> -1))
                           (<span style="color: #859900; font-weight: bold;">while</span> (<span style="text-decoration: underline;">re-search-forward</span> (<span style="color: #859900; font-weight: bold;">rx</span> bol (group (&gt;= 2 <span style="color: #2aa198;">" "</span>)) (group (<span style="text-decoration: underline;">1+</span> (<span style="text-decoration: underline;">not</span> space)) (<span style="text-decoration: underline;">1+</span> not-newline))) nil t)
                             <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Indented code samples, by two or more spaces</span>
                             (<span style="text-decoration: underline;">replace-match</span> (<span style="text-decoration: underline;">concat</span> (<span style="text-decoration: underline;">match-string</span> 1) <span style="color: #2aa198;">"~"</span> (<span style="text-decoration: underline;">match-string</span> 2) <span style="color: #2aa198;">"~"</span>))))
         (<span style="text-decoration: underline;">s-trim</span> it)
         (<span style="color: #859900; font-weight: bold;">if</span> (<span style="text-decoration: underline;">called-interactively-p</span> 'interactive)
             (<span style="color: #859900; font-weight: bold;">progn</span>
               (<span style="text-decoration: underline;">message</span> it)
               (<span style="text-decoration: underline;">kill-new</span> it))
           it))))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/docstring-function-args</span> (docstring)
  <span style="color: #35a69c; font-style: italic;">"Return function args parsed from DOCSTRING.</span>
<span style="color: #35a69c; font-style: italic;">DOCSTRING should be like one returned by function</span>
<span style="color: #35a69c; font-style: italic;">`</span><span style="color: #d33682; font-weight: bold; font-style: italic;">documentation</span><span style="color: #35a69c; font-style: italic;">', which typically has function arguments on the</span>
<span style="color: #35a69c; font-style: italic;">last line."</span>
  (<span style="color: #859900; font-weight: bold;">when</span> (<span style="text-decoration: underline;">string-match</span> (<span style="color: #859900; font-weight: bold;">rx</span> <span style="color: #2aa198;">"\n\n"</span> <span style="color: #2aa198;">"(fn "</span> (group (<span style="text-decoration: underline;">1+</span> not-newline)) <span style="color: #2aa198;">")"</span> eos) docstring)
    (<span style="text-decoration: underline;">match-string</span> 1 docstring)))

<span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/caps-to-code</span> (beg end)
  <span style="color: #35a69c; font-style: italic;">"Convert all-caps words in region to Org code emphasis."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span> <span style="color: #2aa198;">"r"</span>)
  (<span style="color: #859900; font-weight: bold;">let</span> ((case-fold-search nil))
    (<span style="color: #859900; font-weight: bold;">save-excursion</span>
      (<span style="color: #859900; font-weight: bold;">save-restriction</span>
        (<span style="text-decoration: underline;">narrow-to-region</span> beg end)
        (<span style="text-decoration: underline;">goto-char</span> (<span style="text-decoration: underline;">point-min</span>))
        (<span style="color: #859900; font-weight: bold;">while</span> (<span style="text-decoration: underline;">re-search-forward</span> (<span style="color: #859900; font-weight: bold;">rx</span> (<span style="color: #859900; font-weight: bold;">or</span> space bol)
                                      (group (<span style="text-decoration: underline;">1+</span> (<span style="color: #859900; font-weight: bold;">or</span> upper <span style="color: #2aa198;">"-"</span>)))
                                      (<span style="color: #859900; font-weight: bold;">or</span> space eol (char punct)))
                                  nil t)
          (<span style="color: #859900; font-weight: bold;">setf</span> (<span style="text-decoration: underline;">buffer-substring</span> (<span style="text-decoration: underline;">match-beginning</span> 1) (<span style="text-decoration: underline;">match-end</span> 1))
                (<span style="text-decoration: underline;">concat</span> <span style="color: #2aa198;">"~"</span> (<span style="text-decoration: underline;">match-string</span> 1) <span style="color: #2aa198;">"~"</span>))
          (<span style="text-decoration: underline;">goto-char</span> (<span style="text-decoration: underline;">match-end</span> 0)))))))

<span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/symbol-quotes-to-org-code</span> (beg end)
  <span style="color: #35a69c; font-style: italic;">"Change Emacs `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">symbol</span><span style="color: #35a69c; font-style: italic;">' quotes to Org =symbol= quotes in region."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span> <span style="color: #2aa198;">"r"</span>)
  (<span style="color: #859900; font-weight: bold;">save-excursion</span>
    (<span style="color: #859900; font-weight: bold;">save-restriction</span>
      (<span style="text-decoration: underline;">goto-char</span> beg)
      (<span style="text-decoration: underline;">narrow-to-region</span> beg end)
      (<span style="color: #859900; font-weight: bold;">while</span> (<span style="text-decoration: underline;">re-search-forward</span> (<span style="color: #859900; font-weight: bold;">rx</span> (<span style="color: #859900; font-weight: bold;">or</span> <span style="color: #2aa198;">"`"</span> <span style="color: #2aa198;">"&#8216;"</span>) (group (<span style="text-decoration: underline;">1+</span> (<span style="color: #859900; font-weight: bold;">or</span> word (syntax symbol)))) (<span style="color: #859900; font-weight: bold;">or</span> <span style="color: #2aa198;">"&#8217;"</span> <span style="color: #2aa198;">"'"</span>)) nil t)
        (<span style="text-decoration: underline;">replace-match</span> (<span style="text-decoration: underline;">concat</span> <span style="color: #2aa198;">"~"</span> (<span style="text-decoration: underline;">match-string</span> 1) <span style="color: #2aa198;">"~"</span>) t)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-Download%20and%20attach%20remote%20files" class="outline-3">
<h3 id="Download%20and%20attach%20remote%20files">Download and attach remote files</h3>
<div class="outline-text-3" id="text-Download%20and%20attach%20remote%20files">
<p>
Download file at <code>URL</code> and attach with <code>org-attach</code>.  Interactively, look for <code>URL</code> at point, in X clipboard, and in kill-ring, prompting if not found.  With prefix, prompt for <code>URL</code>.
</p>

<p>
<b>Requires:</b>
</p>
<ul class="org-ul">
<li><a href="https://github.com/alphapapa/org-web-tools">org-web-tools</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/org-attach-download</span> (url)
  <span style="color: #35a69c; font-style: italic;">"Download file at URL and attach with `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">org-attach</span><span style="color: #35a69c; font-style: italic;">'.</span>
<span style="color: #35a69c; font-style: italic;">Interactively, look for URL at point, in X clipboard, and in</span>
<span style="color: #35a69c; font-style: italic;">kill-ring, prompting if not found.  With prefix, prompt for URL."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span> (<span style="text-decoration: underline;">list</span> (<span style="color: #859900; font-weight: bold;">if</span> current-prefix-arg
                         (<span style="text-decoration: underline;">read-string</span> <span style="color: #2aa198;">"URL: "</span>)
                       (<span style="color: #859900; font-weight: bold;">or</span> (<span style="text-decoration: underline;">org-element-property</span> <span style="color: #268bd2; font-weight: bold;">:raw-link</span> (<span style="text-decoration: underline;">org-element-context</span>))
                           (org-web-tools--get-first-url)
                           (<span style="text-decoration: underline;">read-string</span> <span style="color: #2aa198;">"URL: "</span>)))))
  (<span style="color: #859900; font-weight: bold;">when</span> (<span style="text-decoration: underline;">yes-or-no-p</span> (<span style="text-decoration: underline;">concat</span> <span style="color: #2aa198;">"Attach file at URL: "</span> url))
    (<span style="color: #859900; font-weight: bold;">let*</span> ((temp-dir (<span style="text-decoration: underline;">make-temp-file</span> <span style="color: #2aa198;">"org-attach-download-"</span> 'dir))
           (basename (<span style="text-decoration: underline;">file-name-nondirectory</span> (<span style="text-decoration: underline;">directory-file-name</span> url)))
           (local-path (<span style="text-decoration: underline;">expand-file-name</span> basename temp-dir))
           size)
      (<span style="color: #859900; font-weight: bold;">unwind-protect</span>
          (<span style="color: #859900; font-weight: bold;">progn</span>
            (<span style="text-decoration: underline;">url-copy-file</span> url local-path 'ok-if-exists 'keep-time)
            (<span style="color: #859900; font-weight: bold;">setq</span> size (<span style="text-decoration: underline;">file-size-human-readable</span>
                        (<span style="text-decoration: underline;">file-attribute-size</span>
                         (<span style="text-decoration: underline;">file-attributes</span> local-path))))
            (org-attach-attach local-path nil 'mv)
            (<span style="text-decoration: underline;">message</span> <span style="color: #2aa198;">"Attached %s (%s)"</span> url size))
        (<span style="text-decoration: underline;">delete-directory</span> temp-dir)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-Ensure%20blank%20lines%20between%20headings%20and%20before%20contents" class="outline-3">
<h3 id="Ensure%20blank%20lines%20between%20headings%20and%20before%20contents">Ensure blank lines between headings and before contents</h3>
<div class="outline-text-3" id="text-Ensure%20blank%20lines%20between%20headings%20and%20before%20contents">
<p>
Ensure that blank lines exist between headings and between headings and their contents.  With prefix, operate on whole buffer.  Ensures that blank lines exist after each headings's drawers.
</p>

<p>
For those who prefer to maintain blank lines between headings, this makes it easy to automatically add them where necessary, to a subtree or the whole buffer.  It also adds blank lines after drawers.  Works well with <a href="#~org-return-dwim~"><code>org-return-dwim</code></a>.
</p>

<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/org-fix-blank-lines</span> (<span style="color: #b58900;">&amp;optional</span> prefix)
  <span style="color: #35a69c; font-style: italic;">"Ensure that blank lines exist between headings and between headings and their contents.</span>
<span style="color: #35a69c; font-style: italic;">With prefix, operate on whole buffer. Ensures that blank lines</span>
<span style="color: #35a69c; font-style: italic;">exist after each headings's drawers."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span> <span style="color: #2aa198;">"P"</span>)
  (<span style="text-decoration: underline;">org-map-entries</span> (<span style="color: #859900; font-weight: bold;">lambda</span> ()
                     (<span style="color: #859900; font-weight: bold;">org-with-wide-buffer</span>
                      <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">`</span><span style="color: #d33682; font-weight: bold; font-style: italic;">org-map-entries</span><span style="color: #405A61; font-style: italic;">' narrows the buffer, which prevents us from seeing</span>
                      <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">newlines before the current heading, so we do this part widened.</span>
                      (<span style="color: #859900; font-weight: bold;">while</span> (<span style="text-decoration: underline;">not</span> (<span style="text-decoration: underline;">looking-back</span> <span style="color: #2aa198;">"\n\n"</span> nil))
                        <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Insert blank lines before heading.</span>
                        (<span style="text-decoration: underline;">insert</span> <span style="color: #2aa198;">"\n"</span>)))
                     (<span style="color: #859900; font-weight: bold;">let</span> ((end (<span style="text-decoration: underline;">org-entry-end-position</span>)))
                       <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Insert blank lines before entry content</span>
                       (<span style="text-decoration: underline;">forward-line</span>)
                       (<span style="color: #859900; font-weight: bold;">while</span> (<span style="color: #859900; font-weight: bold;">and</span> (<span style="text-decoration: underline;">org-at-planning-p</span>)
                                   (&lt; (<span style="text-decoration: underline;">point</span>) (<span style="text-decoration: underline;">point-max</span>)))
                         <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Skip planning lines</span>
                         (<span style="text-decoration: underline;">forward-line</span>))
                       (<span style="color: #859900; font-weight: bold;">while</span> (<span style="text-decoration: underline;">re-search-forward</span> org-drawer-regexp end t)
                         <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Skip drawers. You might think that `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">org-at-drawer-p</span><span style="color: #405A61; font-style: italic;">' would suffice, but</span>
                         <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">for some reason it doesn't work correctly when operating on hidden text.</span>
                         <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">This works, taken from `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">org-agenda-get-some-entry-text</span><span style="color: #405A61; font-style: italic;">'.</span>
                         (<span style="text-decoration: underline;">re-search-forward</span> <span style="color: #2aa198;">"^[ \t]*:END:.*\n?"</span> end t)
                         (<span style="text-decoration: underline;">goto-char</span> (<span style="text-decoration: underline;">match-end</span> 0)))
                       (<span style="color: #859900; font-weight: bold;">unless</span> (<span style="color: #859900; font-weight: bold;">or</span> (= (<span style="text-decoration: underline;">point</span>) (<span style="text-decoration: underline;">point-max</span>))
                                   (<span style="text-decoration: underline;">org-at-heading-p</span>)
                                   (<span style="text-decoration: underline;">looking-at-p</span> <span style="color: #2aa198;">"\n"</span>))
                         (<span style="text-decoration: underline;">insert</span> <span style="color: #2aa198;">"\n"</span>))))
                   t (<span style="color: #859900; font-weight: bold;">if</span> prefix
                         nil
                       'tree)))
</pre>
</div>
</div>
</div>

<div id="outline-container-Export%20to%20HTML%20with%20%2Fuseful%2F%20anchors" class="outline-3">
<h3 id="Export%20to%20HTML%20with%20%2Fuseful%2F%20anchors">Export to HTML with <i>useful</i> anchors</h3>
<div class="outline-text-3" id="text-Export%20to%20HTML%20with%20%2Fuseful%2F%20anchors">
<p>
This minor mode causes Org HTML export to use heading titles for HTML IDs and anchors.  For example, instead of:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #268bd2;">li</span>&gt;&lt;<span style="color: #268bd2;">a</span> <span style="color: #6c71c4;">href</span>=<span style="color: #2aa198;">"#org11177f0"</span>&gt;Usage...
&lt;<span style="color: #268bd2;">li</span>&gt;&lt;<span style="color: #268bd2;">a</span> <span style="color: #6c71c4;">href</span>=<span style="color: #2aa198;">"#orge2a172e"</span>&gt;Faces, fonts...
</pre>
</div>

<p>
You get:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #268bd2;">li</span>&gt;&lt;<span style="color: #268bd2;">a</span> <span style="color: #6c71c4;">href</span>=<span style="color: #2aa198;">"#Usage"</span>&gt;Usage...
&lt;<span style="color: #268bd2;">li</span>&gt;&lt;<span style="color: #268bd2;">a</span> <span style="color: #6c71c4;">href</span>=<span style="color: #2aa198;">"#Faces%2C%20fonts"</span>&gt;Faces, fonts...
</pre>
</div>

<p>
So links to sections of the exported HTML will remain useful, rather than being different, random numbers every time the document is exported.  If an anchor is not unique, its ancestor headings are prepended one-at-a-time until unique, and when no more ancestors remain, a number is appended and incremented until unique.  For an example of how this works out in practice, see the links made to headings <a href="https://alphapapa.github.io/emacs-package-dev-handbook/">here</a>, of which there are many having the same name (e.g. <code>Tools</code>, <code>Libraries</code>, etc).
</p>

<p>
Note that this is somewhat of a hack, and it probably breaks some feature deep inside Org Export.  But it seems to work, and it solves the problem!
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">eval-when-compile</span>
  (<span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #d33682; font-weight: bold;">easy-mmode</span>)
  (<span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #d33682; font-weight: bold;">ox</span>))

(<span style="color: #859900; font-weight: bold;">use-package</span> <span style="color: #d33682; font-weight: bold;">ox</span>
  <span style="color: #268bd2; font-weight: bold;">:config</span>
  (<span style="color: #859900; font-weight: bold;">define-minor-mode</span> <span style="color: #268bd2;">unpackaged/org-export-html-with-useful-ids-mode</span>
    <span style="color: #35a69c; font-style: italic;">"Attempt to export Org as HTML with useful link IDs.</span>
<span style="color: #35a69c; font-style: italic;">Instead of random IDs like \"#orga1b2c3\", use heading titles,</span>
<span style="color: #35a69c; font-style: italic;">made unique when necessary."</span>
    <span style="color: #268bd2; font-weight: bold;">:global</span> t
    (<span style="color: #859900; font-weight: bold;">if</span> unpackaged/org-export-html-with-useful-ids-mode
        (<span style="text-decoration: underline;">advice-add</span> #'org-export-get-reference <span style="color: #268bd2; font-weight: bold;">:override</span> #'unpackaged/org-export-get-reference)
      (<span style="text-decoration: underline;">advice-remove</span> #'org-export-get-reference #'unpackaged/org-export-get-reference)))

  (<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/org-export-get-reference</span> (datum info)
    <span style="color: #35a69c; font-style: italic;">"Like `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">org-export-get-reference</span><span style="color: #35a69c; font-style: italic;">', except uses heading titles instead of random numbers."</span>
    (<span style="color: #859900; font-weight: bold;">let</span> ((cache (<span style="text-decoration: underline;">plist-get</span> info <span style="color: #268bd2; font-weight: bold;">:internal-references</span>)))
      (<span style="color: #859900; font-weight: bold;">or</span> (<span style="text-decoration: underline;">car</span> (<span style="text-decoration: underline;">rassq</span> datum cache))
          (<span style="color: #859900; font-weight: bold;">let*</span> ((crossrefs (<span style="text-decoration: underline;">plist-get</span> info <span style="color: #268bd2; font-weight: bold;">:crossrefs</span>))
                 (cells (<span style="text-decoration: underline;">org-export-search-cells</span> datum))
                 <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Preserve any pre-existing association between</span>
                 <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">a search cell and a reference, i.e., when some</span>
                 <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">previously published document referenced a location</span>
                 <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">within current file (see</span>
                 <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">`</span><span style="color: #d33682; font-weight: bold; font-style: italic;">org-publish-resolve-external-link</span><span style="color: #405A61; font-style: italic;">').</span>
                 <span style="color: #405A61; font-style: italic;">;;</span>
                 <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">However, there is no guarantee that search cells are</span>
                 <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">unique, e.g., there might be duplicate custom ID or</span>
                 <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">two headings with the same title in the file.</span>
                 <span style="color: #405A61; font-style: italic;">;;</span>
                 <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">As a consequence, before re-using any reference to</span>
                 <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">an element or object, we check that it doesn't refer</span>
                 <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">to a previous element or object.</span>
                 (new (<span style="color: #859900; font-weight: bold;">or</span> (<span style="text-decoration: underline;">cl-some</span>
                           (<span style="color: #859900; font-weight: bold;">lambda</span> (cell)
                             (<span style="color: #859900; font-weight: bold;">let</span> ((stored (<span style="text-decoration: underline;">cdr</span> (<span style="text-decoration: underline;">assoc</span> cell crossrefs))))
                               (<span style="color: #859900; font-weight: bold;">when</span> stored
                                 (<span style="color: #859900; font-weight: bold;">let</span> ((old (<span style="text-decoration: underline;">org-export-format-reference</span> stored)))
                                   (<span style="color: #859900; font-weight: bold;">and</span> (<span style="text-decoration: underline;">not</span> (<span style="text-decoration: underline;">assoc</span> old cache)) stored)))))
                           cells)
                          (<span style="color: #859900; font-weight: bold;">when</span> (<span style="text-decoration: underline;">org-element-property</span> <span style="color: #268bd2; font-weight: bold;">:raw-value</span> datum)
                            <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Heading with a title</span>
                            (<span style="text-decoration: underline;">unpackaged/org-export-new-title-reference</span> datum cache))
                          <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #d0bf8f; font-style: italic;">NOTE</span><span style="color: #405A61; font-style: italic;">: This probably breaks some Org Export</span>
                          <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">feature, but if it does what I need, fine.</span>
                          (<span style="text-decoration: underline;">org-export-format-reference</span>
                           (<span style="text-decoration: underline;">org-export-new-reference</span> cache))))
                 (reference-string new))
            <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Cache contains both data already associated to</span>
            <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">a reference and in-use internal references, so as to make</span>
            <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">unique references.</span>
            (<span style="color: #859900; font-weight: bold;">dolist</span> (cell cells) (<span style="color: #859900; font-weight: bold;">push</span> (<span style="text-decoration: underline;">cons</span> cell new) cache))
            <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Retain a direct association between reference string and</span>
            <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">DATUM since (1) not every object or element can be given</span>
            <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">a search cell (2) it permits quick lookup.</span>
            (<span style="color: #859900; font-weight: bold;">push</span> (<span style="text-decoration: underline;">cons</span> reference-string datum) cache)
            (<span style="text-decoration: underline;">plist-put</span> info <span style="color: #268bd2; font-weight: bold;">:internal-references</span> cache)
            reference-string))))

  (<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/org-export-new-title-reference</span> (datum cache)
    <span style="color: #35a69c; font-style: italic;">"Return new reference for DATUM that is unique in CACHE."</span>
    (<span style="color: #859900; font-weight: bold;">cl-macrolet</span> ((inc-suffixf (place)
                               `(<span style="color: #859900; font-weight: bold;">progn</span>
                                  (<span style="text-decoration: underline;">string-match</span> (<span style="color: #859900; font-weight: bold;">rx</span> bos
                                                    (minimal-match (group (<span style="text-decoration: underline;">1+</span> anything)))
                                                    (optional <span style="color: #2aa198;">"--"</span> (group (<span style="text-decoration: underline;">1+</span> digit)))
                                                    eos)
                                                ,place)
                                  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #d0bf8f; font-style: italic;">HACK</span><span style="color: #405A61; font-style: italic;">: `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">s1</span><span style="color: #405A61; font-style: italic;">' instead of a gensym.</span>
                                  (<span style="color: #859900; font-weight: bold;">-let*</span> (((s1 suffix) (<span style="text-decoration: underline;">list</span> (<span style="text-decoration: underline;">match-string</span> 1 ,place)
                                                             (<span style="text-decoration: underline;">match-string</span> 2 ,place)))
                                          (suffix (<span style="color: #859900; font-weight: bold;">if</span> suffix
                                                      (<span style="text-decoration: underline;">string-to-number</span> suffix)
                                                    0)))
                                    (<span style="color: #859900; font-weight: bold;">setf</span> ,place (<span style="text-decoration: underline;">format</span> <span style="color: #2aa198;">"%s--%s"</span> s1 (<span style="color: #859900; font-weight: bold;">cl-incf</span> suffix)))))))
      (<span style="color: #859900; font-weight: bold;">let*</span> ((title (<span style="text-decoration: underline;">org-element-property</span> <span style="color: #268bd2; font-weight: bold;">:raw-value</span> datum))
             (ref (<span style="text-decoration: underline;">url-hexify-string</span> (<span style="text-decoration: underline;">substring-no-properties</span> title)))
             (parent (<span style="text-decoration: underline;">org-element-property</span> <span style="color: #268bd2; font-weight: bold;">:parent</span> datum)))
        (<span style="color: #859900; font-weight: bold;">while</span> (<span style="color: #859900; font-weight: bold;">--any</span> (<span style="text-decoration: underline;">equal</span> ref (<span style="text-decoration: underline;">car</span> it))
                      cache)
          <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Title not unique: make it so.</span>
          (<span style="color: #859900; font-weight: bold;">if</span> parent
              <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Append ancestor title.</span>
              (<span style="color: #859900; font-weight: bold;">setf</span> title (<span style="text-decoration: underline;">concat</span> (<span style="text-decoration: underline;">org-element-property</span> <span style="color: #268bd2; font-weight: bold;">:raw-value</span> parent)
                                  <span style="color: #2aa198;">"--"</span> title)
                    ref (<span style="text-decoration: underline;">url-hexify-string</span> (<span style="text-decoration: underline;">substring-no-properties</span> title))
                    parent (<span style="text-decoration: underline;">org-element-property</span> <span style="color: #268bd2; font-weight: bold;">:parent</span> parent))
            <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">No more ancestors: add and increment a number.</span>
            (inc-suffixf ref)))
        ref))))
</pre>
</div>
</div>
</div>

<div id="outline-container-Force%20monospace%20face%20in%20tables" class="outline-3">
<h3 id="Force%20monospace%20face%20in%20tables">Force monospace face in tables</h3>
<div class="outline-text-3" id="text-Force%20monospace%20face%20in%20tables">
<p>
If you use variable-pitch (a.k.a. "proportional") fonts in Org buffers (e.g. using <a href="https://github.com/cadadr/elisp/blob/devel/org-variable-pitch.el">org-variable-pitch</a>), you probably use monospace fonts for Org tables, so they align properly.  However, other elements in a table (such as links, or perhaps timestamps) may still use variable-pitch fonts, which breaks alignment.  This code fixes that by forcibly applying the <code>org-table</code> face family to entire Org tables (which are detected by finding existing text with the <code>org-table</code> face, which makes use of Org's built-in fontification).
</p>

<p>
To use, activate <code>unpackaged/org-table-face-mode</code>.  You may want to add it to <code>org-mode-hook</code>.
</p>

<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">define-minor-mode</span> <span style="color: #268bd2;">unpackaged/org-table-face-mode</span>
  <span style="color: #35a69c; font-style: italic;">"Apply `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">org-table</span><span style="color: #35a69c; font-style: italic;">' face family to all text in Org tables.</span>
<span style="color: #35a69c; font-style: italic;">Useful for forcibly applying the face to portions of table data</span>
<span style="color: #35a69c; font-style: italic;">that might have a different face, which could affect alignment."</span>
  <span style="color: #268bd2; font-weight: bold;">:global</span> nil
  (<span style="color: #859900; font-weight: bold;">let</span> ((keywords '((unpackaged/org-table-face-matcher 0 'org-table))))
    (<span style="color: #859900; font-weight: bold;">if</span> unpackaged/org-table-face-mode
        (<span style="text-decoration: underline;">font-lock-add-keywords</span> nil keywords 'append)
      (<span style="text-decoration: underline;">font-lock-remove-keywords</span> nil keywords))
    (<span style="text-decoration: underline;">font-lock-flush</span>)))

(<span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #268bd2;">unpackaged/org-table-face-matcher</span>
    (limit <span style="color: #b58900;">&amp;optional</span> (face `(<span style="color: #268bd2; font-weight: bold;">:family</span> ,(face-attribute 'org-table <span style="color: #268bd2; font-weight: bold;">:family</span>))))
  <span style="color: #35a69c; font-style: italic;">"Apply FACE to entire Org tables.</span>
<span style="color: #35a69c; font-style: italic;">A `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">font-lock-keywords</span><span style="color: #35a69c; font-style: italic;">' function that searches up to LIMIT."</span>
  (<span style="color: #859900; font-weight: bold;">cl-flet*</span> ((find-face (face <span style="color: #b58900;">&amp;optional</span> limit not)
                        <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Return next position up to LIMIT that has FACE, or doesn't if NOT.</span>
                        (<span style="color: #859900; font-weight: bold;">cl-loop</span> with prev-pos
                                 with pos = (<span style="text-decoration: underline;">point</span>)
                                 while (<span style="text-decoration: underline;">not</span> (<span style="text-decoration: underline;">eobp</span>))
                                 do (<span style="color: #859900; font-weight: bold;">setf</span> pos (<span style="text-decoration: underline;">next-single-property-change</span> pos 'face nil limit))
                                 while (<span style="color: #859900; font-weight: bold;">and</span> pos (<span style="text-decoration: underline;">not</span> (<span style="text-decoration: underline;">equal</span> pos prev-pos)))
                                 for face-at = (<span style="text-decoration: underline;">get-text-property</span> pos 'face)
                                 for face-matches-p = (<span style="color: #859900; font-weight: bold;">or</span> (<span style="text-decoration: underline;">eq</span> face-at face)
                                                          (<span style="color: #859900; font-weight: bold;">when</span> (<span style="text-decoration: underline;">listp</span> face-at)
                                                            (<span style="text-decoration: underline;">member</span> face face-at)))
                                 when (<span style="color: #859900; font-weight: bold;">or</span> (<span style="color: #859900; font-weight: bold;">and</span> not (<span style="text-decoration: underline;">not</span> face-matches-p))
                                          face-matches-p)
                                 return pos
                                 do (<span style="color: #859900; font-weight: bold;">setf</span> prev-pos pos)))
             (apply-face-from (pos face)
                              (<span style="color: #859900; font-weight: bold;">unless</span> (<span style="text-decoration: underline;">eobp</span>)
                                (<span style="color: #859900; font-weight: bold;">let*</span> ((property-at-start (<span style="text-decoration: underline;">get-text-property</span> pos 'face))
                                       (table-face-start (<span style="color: #859900; font-weight: bold;">if</span> (<span style="color: #859900; font-weight: bold;">or</span> (<span style="text-decoration: underline;">eq</span> property-at-start 'org-table)
                                                                 (<span style="color: #859900; font-weight: bold;">when</span> (<span style="text-decoration: underline;">listp</span> property-at-start)
                                                                   (<span style="text-decoration: underline;">member</span> 'org-table property-at-start)))
                                                             (<span style="text-decoration: underline;">point</span>)
                                                           (find-face 'org-table limit)))
                                       table-face-end)
                                  (<span style="color: #859900; font-weight: bold;">when</span> table-face-start
                                    (<span style="text-decoration: underline;">goto-char</span> table-face-start)
                                    (<span style="color: #859900; font-weight: bold;">setf</span> table-face-end (<span style="text-decoration: underline;">line-end-position</span>))
                                    (<span style="text-decoration: underline;">add-face-text-property</span> table-face-start table-face-end face)
                                    (<span style="text-decoration: underline;">goto-char</span> table-face-end))))))
    (<span style="color: #859900; font-weight: bold;">cl-loop</span> with applied-p
             for applied = (apply-face-from (<span style="text-decoration: underline;">point</span>) face)
             when applied
             do (<span style="color: #859900; font-weight: bold;">setf</span> applied-p t)
             while applied
             finally return applied-p)))
</pre>
</div>
</div>
</div>

<div id="outline-container-Outline%20number%20overlays" class="outline-3">
<h3 id="Outline%20number%20overlays">Outline number overlays</h3>
<div class="outline-text-3" id="text-Outline%20number%20overlays">
<p>
This command displays outline numbers (like the ones used when exporting) in a buffer as overlays at the beginning of each heading.  It doesn't update automatically, so it must be called when the outline structure changes.
</p>

<p>

</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/org-outline-numbers</span> (<span style="color: #b58900;">&amp;optional</span> remove-p)
  <span style="color: #35a69c; font-style: italic;">"Add outline number overlays to the current buffer.</span>
<span style="color: #35a69c; font-style: italic;">When REMOVE-P is non-nil (interactively, with prefix), remove</span>
<span style="color: #35a69c; font-style: italic;">them.  Overlays are not automatically updated when the outline</span>
<span style="color: #35a69c; font-style: italic;">structure changes."</span>
  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #d0bf8f; font-style: italic;">NOTE</span><span style="color: #405A61; font-style: italic;">: This does not necessarily play nicely with org-indent-mode</span>
  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">or org-bullets, but it probably wouldn't be too hard to fix that.</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span> (<span style="text-decoration: underline;">list</span> current-prefix-arg))
  (<span style="color: #859900; font-weight: bold;">cl-labels</span> ((heading-number ()
               (<span style="color: #859900; font-weight: bold;">or</span> (<span style="color: #859900; font-weight: bold;">when-let</span> ((num (previous-sibling-number)))
                     (<span style="text-decoration: underline;">1+</span> num))
                   1))
              (previous-sibling-number ()
               (<span style="color: #859900; font-weight: bold;">save-excursion</span>
                 (<span style="color: #859900; font-weight: bold;">let</span> ((pos (<span style="text-decoration: underline;">point</span>)))
                   (<span style="text-decoration: underline;">org-backward-heading-same-level</span> 1)
                   (<span style="color: #859900; font-weight: bold;">when</span> (<span style="text-decoration: underline;">/=</span> pos (<span style="text-decoration: underline;">point</span>))
                     (heading-number)))))
              (number-list ()
               (<span style="color: #859900; font-weight: bold;">let</span> ((ancestor-numbers (<span style="color: #859900; font-weight: bold;">save-excursion</span>
                                         (<span style="color: #859900; font-weight: bold;">cl-loop</span> while (<span style="text-decoration: underline;">org-up-heading-safe</span>)
                                                  collect (heading-number)))))
                 (<span style="text-decoration: underline;">nreverse</span> (<span style="text-decoration: underline;">cons</span> (heading-number) ancestor-numbers))))
              (add-overlay ()
               (<span style="color: #859900; font-weight: bold;">let*</span> ((<span style="text-decoration: underline;">ov-length</span> (<span style="text-decoration: underline;">org-current-level</span>))
                      (<span style="text-decoration: underline;">ov</span> (<span style="text-decoration: underline;">make-overlay</span> (<span style="text-decoration: underline;">point</span>) (+ (<span style="text-decoration: underline;">point</span>) ov-length)))
                      (ov-string (<span style="text-decoration: underline;">concat</span> (<span style="text-decoration: underline;">mapconcat</span> #'number-to-string (number-list) <span style="color: #2aa198;">"."</span>)
                                         <span style="color: #2aa198;">"."</span>)))
                 (<span style="text-decoration: underline;">overlay-put</span> ov 'org-outline-numbers t)
                 (<span style="text-decoration: underline;">overlay-put</span> ov 'display ov-string))))
    (<span style="text-decoration: underline;">remove-overlays</span> nil nil 'org-outline-numbers t)
    (<span style="color: #859900; font-weight: bold;">unless</span> remove-p
      (<span style="color: #859900; font-weight: bold;">org-with-wide-buffer</span>
       (<span style="text-decoration: underline;">goto-char</span> (<span style="text-decoration: underline;">point-min</span>))
       (<span style="color: #859900; font-weight: bold;">when</span> (<span style="text-decoration: underline;">org-before-first-heading-p</span>)
         (<span style="text-decoration: underline;">outline-next-heading</span>))
       (<span style="color: #859900; font-weight: bold;">cl-loop</span> do (add-overlay)
                while (<span style="text-decoration: underline;">outline-next-heading</span>))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-Surround%20region%20with%20emphasis%20or%20syntax%20characters" class="outline-3">
<h3 id="Surround%20region%20with%20emphasis%20or%20syntax%20characters">Surround region with emphasis or syntax characters</h3>
<div class="outline-text-3" id="text-Surround%20region%20with%20emphasis%20or%20syntax%20characters">
<p>
Define and bind interactive commands for each of <code>KEYS</code> that surround the region or insert text.  Commands are bound in <code>org-mode-map</code> to each of <code>KEYS</code>.  If the region is active, commands surround it with the key character, otherwise call <code>org-self-insert-command</code>.
</p>

<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">defmacro</span> <span style="color: #268bd2;">unpackaged/def-org-maybe-surround</span> (<span style="color: #b58900;">&amp;rest</span> keys)
  <span style="color: #35a69c; font-style: italic;">"Define and bind interactive commands for each of KEYS that surround the region or insert text.</span>
<span style="color: #35a69c; font-style: italic;">Commands are bound in `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">org-mode-map</span><span style="color: #35a69c; font-style: italic;">' to each of KEYS.  If the</span>
<span style="color: #35a69c; font-style: italic;">region is active, commands surround it with the key character,</span>
<span style="color: #35a69c; font-style: italic;">otherwise call `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">org-self-insert-command</span><span style="color: #35a69c; font-style: italic;">'."</span>
  `(<span style="color: #859900; font-weight: bold;">progn</span>
     ,@(<span style="color: #859900; font-weight: bold;">cl-loop</span> for key in keys
                for name = (<span style="text-decoration: underline;">intern</span> (<span style="text-decoration: underline;">concat</span> <span style="color: #2aa198;">"unpackaged/org-maybe-surround-"</span> key))
                for docstring = (<span style="text-decoration: underline;">format</span> <span style="color: #2aa198;">"If region is active, surround it with \"%s\", otherwise call `</span><span style="color: #d33682; font-weight: bold;">org-self-insert-command</span><span style="color: #2aa198;">'."</span> key)
                collect `(<span style="color: #859900; font-weight: bold;">defun</span> ,name ()
                           ,docstring
                           (<span style="color: #859900; font-weight: bold;">interactive</span>)
                           (<span style="color: #859900; font-weight: bold;">if</span> (<span style="text-decoration: underline;">region-active-p</span>)
                               (<span style="color: #859900; font-weight: bold;">let</span> ((beg (<span style="text-decoration: underline;">region-beginning</span>))
                                     (end (<span style="text-decoration: underline;">region-end</span>)))
                                 (<span style="color: #859900; font-weight: bold;">save-excursion</span>
                                   (<span style="text-decoration: underline;">goto-char</span> end)
                                   (<span style="text-decoration: underline;">insert</span> ,key)
                                   (<span style="text-decoration: underline;">goto-char</span> beg)
                                   (<span style="text-decoration: underline;">insert</span> ,key)))
                             (<span style="text-decoration: underline;">call-interactively</span> #'org-self-insert-command)))
                collect `(define-key org-mode-map (<span style="text-decoration: underline;">kbd</span> ,key) #',name))))
</pre>
</div>

<p>
Used like:
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">unpackaged/def-org-maybe-surround</span> <span style="color: #2aa198;">"~"</span> <span style="color: #2aa198;">"="</span> <span style="color: #2aa198;">"*"</span> <span style="color: #2aa198;">"/"</span> <span style="color: #2aa198;">"+"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-Refile%20to%20datetree%20file%20using%20earliest%2Flatest%20timestamp%20in%20entry" class="outline-3">
<h3 id="Refile%20to%20datetree%20file%20using%20earliest%2Flatest%20timestamp%20in%20entry">Refile to datetree file using earliest/latest timestamp in entry</h3>
<div class="outline-text-3" id="text-Refile%20to%20datetree%20file%20using%20earliest%2Flatest%20timestamp%20in%20entry">
<p>
Refile current entry to datetree using timestamp found in entry.  <code>WHICH</code> should be <code>earliest</code> or <code>latest</code>. If <code>SUBTREE</code>-P is non-nil, search whole subtree.
</p>

<p>
This is sort of like archiving to a datetree, but it uses either the earliest or latest timestamp found in the entry or subtree rather than the current date.  It's helpful if you have an entry with lots of timestamps or log entries, and you're done with it, and you want to file it in a datetree in a leaf matching either when you started working on the entry or when you finished, using the first or last timestamp found anywhere in the entry.
</p>

<p>
<i>Note:</i> If you can think of a more concise name for this command, please send it in!
</p>

<p>
<b>Requires:</b> <a href="https://github.com/alphapapa/ts.el">ts</a>
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #d33682; font-weight: bold;">org</span>)

(<span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #d33682; font-weight: bold;">ts</span>)

<span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/org-refile-to-datetree-using-ts-in-entry</span> (which-ts file <span style="color: #b58900;">&amp;optional</span> subtree-p)
  <span style="color: #35a69c; font-style: italic;">"Refile current entry to datetree in FILE using timestamp found in entry.</span>
<span style="color: #35a69c; font-style: italic;">WHICH should be `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">earliest</span><span style="color: #35a69c; font-style: italic;">' or `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">latest</span><span style="color: #35a69c; font-style: italic;">'. If SUBTREE-P is non-nil,</span>
<span style="color: #35a69c; font-style: italic;">search whole subtree."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span> (<span style="text-decoration: underline;">list</span> (<span style="text-decoration: underline;">intern</span> (<span style="text-decoration: underline;">completing-read</span> <span style="color: #2aa198;">"Which timestamp? "</span> '(earliest latest)))
                     (<span style="text-decoration: underline;">read-file-name</span> <span style="color: #2aa198;">"File: "</span> (<span style="text-decoration: underline;">concat</span> org-directory <span style="color: #2aa198;">"/"</span>) nil 'mustmatch nil
                                     (<span style="color: #859900; font-weight: bold;">lambda</span> (filename)
                                       (<span style="text-decoration: underline;">string-suffix-p</span> <span style="color: #2aa198;">".org"</span> filename)))
                     current-prefix-arg))
  (<span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #d33682; font-weight: bold;">ts</span>)
  (<span style="color: #859900; font-weight: bold;">let*</span> ((sorter (<span style="color: #859900; font-weight: bold;">pcase</span> which-ts
                   ('earliest #'ts&lt;)
                   ('latest #'ts&gt;)))
         (tss (<span style="text-decoration: underline;">unpackaged/org-timestamps-in-entry</span> subtree-p))
         (ts (<span style="text-decoration: underline;">car</span> (<span style="text-decoration: underline;">sort</span> tss sorter)))
         (date (<span style="text-decoration: underline;">list</span> (<span style="text-decoration: underline;">ts-month</span> ts) (<span style="text-decoration: underline;">ts-day</span> ts) (<span style="text-decoration: underline;">ts-year</span> ts))))
    (<span style="text-decoration: underline;">unpackaged/org-refile-to-datetree</span> file <span style="color: #268bd2; font-weight: bold;">:date</span> date)))

<span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/org-timestamps-in-entry</span> (<span style="color: #b58900;">&amp;optional</span> subtree-p)
  <span style="color: #35a69c; font-style: italic;">"Return timestamp objects for all Org timestamps in entry.</span>
<span style="color: #35a69c; font-style: italic;"> If SUBTREE-P is non-nil (interactively, with prefix), search</span>
<span style="color: #35a69c; font-style: italic;"> whole subtree."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span> (<span style="text-decoration: underline;">list</span> current-prefix-arg))
  (<span style="color: #859900; font-weight: bold;">save-excursion</span>
    (<span style="color: #859900; font-weight: bold;">let*</span> ((beg (<span style="text-decoration: underline;">org-entry-beginning-position</span>))
           (end (<span style="color: #859900; font-weight: bold;">if</span> subtree-p
                    (<span style="text-decoration: underline;">org-end-of-subtree</span>)
                  (<span style="text-decoration: underline;">org-entry-end-position</span>))))
      (<span style="text-decoration: underline;">goto-char</span> beg)
      (<span style="color: #859900; font-weight: bold;">cl-loop</span> while (<span style="text-decoration: underline;">re-search-forward</span> org-tsr-regexp-both end t)
               collect (<span style="text-decoration: underline;">ts-parse-org</span> (<span style="text-decoration: underline;">match-string</span> 0))))))

<span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #268bd2;">unpackaged/org-refile-to-datetree</span> (file <span style="color: #b58900;">&amp;key</span> (date (<span style="text-decoration: underline;">calendar-current-date</span>)) entry)
  <span style="color: #35a69c; font-style: italic;">"Refile ENTRY or current node to entry for DATE in datetree in FILE.</span>
<span style="color: #35a69c; font-style: italic;">DATE should be a list of (MONTH DAY YEAR) integers, e.g. as</span>
<span style="color: #35a69c; font-style: italic;">returned by `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">calendar-current-date</span><span style="color: #35a69c; font-style: italic;">'."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span> (<span style="text-decoration: underline;">list</span> (<span style="text-decoration: underline;">read-file-name</span> <span style="color: #2aa198;">"File: "</span> (<span style="text-decoration: underline;">concat</span> org-directory <span style="color: #2aa198;">"/"</span>) nil 'mustmatch nil
                                     (<span style="color: #859900; font-weight: bold;">lambda</span> (filename)
                                       (<span style="text-decoration: underline;">string-suffix-p</span> <span style="color: #2aa198;">".org"</span> filename)))))
  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">If org-datetree isn't loaded, it will cut the tree but not file</span>
  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">it anywhere, losing data. I don't know why</span>
  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">org-datetree-file-entry-under is in a separate package, not</span>
  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">loaded with the rest of org-mode.</span>
  (<span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #d33682; font-weight: bold;">org-datetree</span>)
  (<span style="color: #859900; font-weight: bold;">unless</span> entry
    (<span style="text-decoration: underline;">org-cut-subtree</span>))
  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Using a condition-case to be extra careful. In case the refile</span>
  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">fails in any way, put cut subtree back.</span>
  (<span style="color: #859900; font-weight: bold;">condition-case</span> err
      (<span style="color: #859900; font-weight: bold;">with-current-buffer</span> (<span style="color: #859900; font-weight: bold;">or</span> (<span style="text-decoration: underline;">org-find-base-buffer-visiting</span> file)
                               (<span style="text-decoration: underline;">find-file-noselect</span> file))
        (org-datetree-file-entry-under (<span style="color: #859900; font-weight: bold;">or</span> entry (<span style="text-decoration: underline;">car</span> kill-ring)) date)
        (<span style="text-decoration: underline;">save-buffer</span>))
    (<span style="color: #b58900;">error</span> (<span style="color: #859900; font-weight: bold;">unless</span> entry
             (<span style="text-decoration: underline;">org-paste-subtree</span>))
           (<span style="text-decoration: underline;">message</span> <span style="color: #2aa198;">"Unable to refile! %s"</span> err))))
</pre>
</div>
</div>
</div>

<div id="outline-container-~org-return-dwim~" class="outline-3">
<h3 id="~org-return-dwim~"><code>org-return-dwim</code></h3>
<div class="outline-text-3" id="text-~org-return-dwim~">
<p>
A helpful replacement for <code>org-return</code>.  With prefix, call <code>org-return</code>.
</p>

<p>
On headings, move point to position after entry content.  In lists, insert a new item or end the list, with checkbox if appropriate.  In tables, insert a new row or end the table.
</p>

<p>
Inspired by <a href="http://kitchingroup.cheme.cmu.edu/blog/2017/04/09/A-better-return-in-org-mode/">John Kitchin</a>.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/org-element-descendant-of</span> (type element)
  <span style="color: #35a69c; font-style: italic;">"Return non-nil if ELEMENT is a descendant of TYPE.</span>
<span style="color: #35a69c; font-style: italic;">TYPE should be an element type, like `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">item</span><span style="color: #35a69c; font-style: italic;">' or `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">paragraph</span><span style="color: #35a69c; font-style: italic;">'.</span>
<span style="color: #35a69c; font-style: italic;">ELEMENT should be a list like that returned by `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">org-element-context</span><span style="color: #35a69c; font-style: italic;">'."</span>
  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">MAYBE: Use `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">org-element-lineage</span><span style="color: #405A61; font-style: italic;">'.</span>
  (<span style="color: #859900; font-weight: bold;">when-let*</span> ((parent (<span style="text-decoration: underline;">org-element-property</span> <span style="color: #268bd2; font-weight: bold;">:parent</span> element)))
    (<span style="color: #859900; font-weight: bold;">or</span> (<span style="text-decoration: underline;">eq</span> type (<span style="text-decoration: underline;">car</span> parent))
        (<span style="text-decoration: underline;">unpackaged/org-element-descendant-of</span> type parent))))

<span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/org-return-dwim</span> (<span style="color: #b58900;">&amp;optional</span> default)
  <span style="color: #35a69c; font-style: italic;">"A helpful replacement for `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">org-return</span><span style="color: #35a69c; font-style: italic;">'.  With prefix, call `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">org-return</span><span style="color: #35a69c; font-style: italic;">'.</span>

<span style="color: #35a69c; font-style: italic;">On headings, move point to position after entry content.  In</span>
<span style="color: #35a69c; font-style: italic;">lists, insert a new item or end the list, with checkbox if</span>
<span style="color: #35a69c; font-style: italic;">appropriate.  In tables, insert a new row or end the table."</span>
  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Inspired by John Kitchin: http://kitchingroup.cheme.cmu.edu/blog/2017/04/09/A-better-return-in-org-mode/</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span> <span style="color: #2aa198;">"P"</span>)
  (<span style="color: #859900; font-weight: bold;">if</span> default
      (<span style="text-decoration: underline;">org-return</span>)
    (<span style="color: #859900; font-weight: bold;">cond</span>
     <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Act depending on context around point.</span>

     <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #d0bf8f; font-style: italic;">NOTE</span><span style="color: #405A61; font-style: italic;">: I prefer RET to not follow links, but by uncommenting this block, links will be</span>
     <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">followed.</span>

     <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">((</span><span style="color: #405A61; font-style: italic; text-decoration: underline;">eq</span><span style="color: #405A61; font-style: italic;"> 'link (</span><span style="color: #405A61; font-style: italic; text-decoration: underline;">car</span><span style="color: #405A61; font-style: italic;"> (</span><span style="color: #405A61; font-style: italic; text-decoration: underline;">org-element-context</span><span style="color: #405A61; font-style: italic;">)))</span>
     <span style="color: #405A61; font-style: italic;">;;  </span><span style="color: #405A61; font-style: italic;">;; Link: Open it.</span>
     <span style="color: #405A61; font-style: italic;">;;  </span><span style="color: #405A61; font-style: italic;">(</span><span style="color: #405A61; font-style: italic; text-decoration: underline;">org-open-at-point-global</span><span style="color: #405A61; font-style: italic;">))</span>

     ((<span style="text-decoration: underline;">org-at-heading-p</span>)
      <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Heading: Move to position after entry content.</span>
      <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #d0bf8f; font-style: italic;">NOTE</span><span style="color: #405A61; font-style: italic;">: This is probably the most interesting feature of this function.</span>
      (<span style="color: #859900; font-weight: bold;">let</span> ((heading-start (<span style="text-decoration: underline;">org-entry-beginning-position</span>)))
        (<span style="text-decoration: underline;">goto-char</span> (<span style="text-decoration: underline;">org-entry-end-position</span>))
        (<span style="color: #859900; font-weight: bold;">cond</span> ((<span style="color: #859900; font-weight: bold;">and</span> (<span style="text-decoration: underline;">org-at-heading-p</span>)
                    (= heading-start (<span style="text-decoration: underline;">org-entry-beginning-position</span>)))
               <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Entry ends on its heading; add newline after</span>
               (<span style="text-decoration: underline;">end-of-line</span>)
               (<span style="text-decoration: underline;">insert</span> <span style="color: #2aa198;">"\n\n"</span>))
              (t
               <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Entry ends after its heading; back up</span>
               (<span style="text-decoration: underline;">forward-line</span> -1)
               (<span style="text-decoration: underline;">end-of-line</span>)
               (<span style="color: #859900; font-weight: bold;">when</span> (<span style="text-decoration: underline;">org-at-heading-p</span>)
                 <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">At the same heading</span>
                 (<span style="text-decoration: underline;">forward-line</span>)
                 (<span style="text-decoration: underline;">insert</span> <span style="color: #2aa198;">"\n"</span>)
                 (<span style="text-decoration: underline;">forward-line</span> -1))
               <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #cc9393; font-style: italic;">FIXME</span><span style="color: #405A61; font-style: italic;">: looking-back is supposed to be called with more arguments.</span>
               (<span style="color: #859900; font-weight: bold;">while</span> (<span style="text-decoration: underline;">not</span> (<span style="text-decoration: underline;">looking-back</span> (<span style="color: #859900; font-weight: bold;">rx</span> (<span style="text-decoration: underline;">repeat</span> 3 (seq (optional blank) <span style="color: #2aa198;">"\n"</span>)))))
                 (<span style="text-decoration: underline;">insert</span> <span style="color: #2aa198;">"\n"</span>))
               (<span style="text-decoration: underline;">forward-line</span> -1)))))

     ((<span style="text-decoration: underline;">org-at-item-checkbox-p</span>)
      <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Checkbox: Insert new item with checkbox.</span>
      (<span style="text-decoration: underline;">org-insert-todo-heading</span> nil))

     ((<span style="text-decoration: underline;">org-in-item-p</span>)
      <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Plain list.  Yes, this gets a little complicated...</span>
      (<span style="color: #859900; font-weight: bold;">let</span> ((context (<span style="text-decoration: underline;">org-element-context</span>)))
        (<span style="color: #859900; font-weight: bold;">if</span> (<span style="color: #859900; font-weight: bold;">or</span> (<span style="text-decoration: underline;">eq</span> 'plain-list (<span style="text-decoration: underline;">car</span> context))  <span style="color: #405A61; font-style: italic;">; </span><span style="color: #405A61; font-style: italic;">First item in list</span>
                (<span style="color: #859900; font-weight: bold;">and</span> (<span style="text-decoration: underline;">eq</span> 'item (<span style="text-decoration: underline;">car</span> context))
                     (<span style="text-decoration: underline;">not</span> (<span style="text-decoration: underline;">eq</span> (<span style="text-decoration: underline;">org-element-property</span> <span style="color: #268bd2; font-weight: bold;">:contents-begin</span> context)
                              (<span style="text-decoration: underline;">org-element-property</span> <span style="color: #268bd2; font-weight: bold;">:contents-end</span> context))))
                (<span style="text-decoration: underline;">unpackaged/org-element-descendant-of</span> 'item context))  <span style="color: #405A61; font-style: italic;">; </span><span style="color: #405A61; font-style: italic;">Element in list item, e.g. a link</span>
            <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Non-empty item: Add new item.</span>
            (<span style="text-decoration: underline;">org-insert-item</span>)
          <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Empty item: Close the list.</span>
          <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #cc9393; font-style: italic;">TODO</span><span style="color: #405A61; font-style: italic;">: Do this with org functions rather than operating on the text. Can't seem to find the right function.</span>
          (<span style="text-decoration: underline;">delete-region</span> (<span style="text-decoration: underline;">line-beginning-position</span>) (<span style="text-decoration: underline;">line-end-position</span>))
          (<span style="text-decoration: underline;">insert</span> <span style="color: #2aa198;">"\n"</span>))))

     ((<span style="color: #859900; font-weight: bold;">when</span> (<span style="text-decoration: underline;">fboundp</span> 'org-inlinetask-in-task-p)
        (org-inlinetask-in-task-p))
      <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Inline task: Don't insert a new heading.</span>
      (<span style="text-decoration: underline;">org-return</span>))

     ((<span style="text-decoration: underline;">org-at-table-p</span>)
      (<span style="color: #859900; font-weight: bold;">cond</span> ((<span style="color: #859900; font-weight: bold;">save-excursion</span>
               (<span style="text-decoration: underline;">beginning-of-line</span>)
               <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">See `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">org-table-next-field</span><span style="color: #405A61; font-style: italic;">'.</span>
               (<span style="color: #859900; font-weight: bold;">cl-loop</span> with end = (<span style="text-decoration: underline;">line-end-position</span>)
                        for cell = (<span style="text-decoration: underline;">org-element-table-cell-parser</span>)
                        always (<span style="text-decoration: underline;">equal</span> (<span style="text-decoration: underline;">org-element-property</span> <span style="color: #268bd2; font-weight: bold;">:contents-begin</span> cell)
                                      (<span style="text-decoration: underline;">org-element-property</span> <span style="color: #268bd2; font-weight: bold;">:contents-end</span> cell))
                        while (<span style="text-decoration: underline;">re-search-forward</span> <span style="color: #2aa198;">"|"</span> end t)))
             <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Empty row: end the table.</span>
             (<span style="text-decoration: underline;">delete-region</span> (<span style="text-decoration: underline;">line-beginning-position</span>) (<span style="text-decoration: underline;">line-end-position</span>))
             (<span style="text-decoration: underline;">org-return</span>))
            (t
             <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Non-empty row: call `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">org-return</span><span style="color: #405A61; font-style: italic;">'.</span>
             (<span style="text-decoration: underline;">org-return</span>))))
     (t
      <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">All other cases: call `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">org-return</span><span style="color: #405A61; font-style: italic;">'.</span>
      (<span style="text-decoration: underline;">org-return</span>)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-Read-only%20trees" class="outline-3">
<h3 id="Read-only%20trees">Read-only trees</h3>
<div class="outline-text-3" id="text-Read-only%20trees">
<p>
This code applies the <code>read-only</code> text-property to trees tagged <code>read_only</code>, preventing them from being modified accidentally.  (Note: If read-only headings appear in an Agenda buffer, it can cause slightly unusual behavior.  Usually this is not an issue.)  This was originally inspired by John Kitchin's <a href="http://kitchingroup.cheme.cmu.edu/blog/2014/09/13/Make-some-org-sections-read-only/">blog article</a> and later <a href="https://www.reddit.com/r/emacs/comments/92k7n1/guide_to_profiling_and_optimizing_an_orgrelated/">rewritten</a> in a faster version.
</p>

<p>
To use, load these functions, and then add to this hook to automatically mark read-only sections when an Org file is loaded:
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="text-decoration: underline;">add-hook</span> 'org-mode-hook 'unpackaged/org-mark-read-only)
</pre>
</div>

<p>
The functions may also be called interactively as needed.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/org-next-heading-tagged</span> (tag)
  <span style="color: #35a69c; font-style: italic;">"Move to beginning of next heading tagged with TAG and return point, or return nil if none found."</span>
  (<span style="color: #859900; font-weight: bold;">when</span> (<span style="text-decoration: underline;">re-search-forward</span> (<span style="text-decoration: underline;">rx-to-string</span> `(seq bol (<span style="text-decoration: underline;">1+</span> <span style="color: #2aa198;">"*"</span>) (<span style="text-decoration: underline;">1+</span> blank) (optional (<span style="text-decoration: underline;">1+</span> not-newline) (<span style="text-decoration: underline;">1+</span> blank))
                                               <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Beginning of tags</span>
                                               <span style="color: #2aa198;">":"</span>
                                               <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Possible other tags</span>
                                               (0+ (seq (<span style="text-decoration: underline;">1+</span> (<span style="text-decoration: underline;">not</span> (any <span style="color: #2aa198;">":"</span> blank))) <span style="color: #2aa198;">":"</span>) )
                                               <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">The tag that matters</span>
                                               ,tag <span style="color: #2aa198;">":"</span>))
                           nil 'noerror)
    (<span style="text-decoration: underline;">goto-char</span> (<span style="text-decoration: underline;">match-beginning</span> 0))))

  <span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###autoload</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/org-mark-read-only</span> ()
  <span style="color: #35a69c; font-style: italic;">"Mark all entries in the buffer tagged \"read_only\" with read-only text properties."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span>)
  (<span style="color: #859900; font-weight: bold;">org-with-wide-buffer</span>
   (<span style="text-decoration: underline;">goto-char</span> (<span style="text-decoration: underline;">point-min</span>))
   (<span style="color: #859900; font-weight: bold;">while</span> (<span style="text-decoration: underline;">unpackaged/org-next-heading-tagged</span> <span style="color: #2aa198;">"read_only"</span>)
     (<span style="text-decoration: underline;">add-text-properties</span> (<span style="text-decoration: underline;">point</span>) (<span style="text-decoration: underline;">org-end-of-subtree</span> t)
                          '(read-only t)))))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/org-remove-read-only</span> ()
  <span style="color: #35a69c; font-style: italic;">"Remove read-only text properties from Org entries tagged \"read_only\" in current buffer."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span>)
  (<span style="color: #859900; font-weight: bold;">let</span> ((inhibit-read-only t))
    (<span style="color: #859900; font-weight: bold;">org-with-wide-buffer</span>
     (<span style="text-decoration: underline;">goto-char</span> (<span style="text-decoration: underline;">point-min</span>))
     (<span style="color: #859900; font-weight: bold;">while</span> (<span style="text-decoration: underline;">unpackaged/org-next-heading-tagged</span> <span style="color: #2aa198;">"read_only"</span>)
       (<span style="text-decoration: underline;">remove-text-properties</span> (<span style="text-decoration: underline;">point</span>) (<span style="text-decoration: underline;">org-end-of-subtree</span> t)
                               '(read-only t))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-Sort%20tree%20by%20multiple%20methods%20at%20once" class="outline-3">
<h3 id="Sort%20tree%20by%20multiple%20methods%20at%20once">Sort tree by multiple methods at once</h3>
<div class="outline-text-3" id="text-Sort%20tree%20by%20multiple%20methods%20at%20once">
<p>
Call <code>org-sort-entries</code> with multiple sorting methods specified in <code>KEYS</code>.
</p>

<p>
This is much easier than doing <kbd>C-c ^ KEY</kbd> several times in a row.
</p>

<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/org-sort-multi</span> ()
  <span style="color: #35a69c; font-style: italic;">"Call `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">org-sort</span><span style="color: #35a69c; font-style: italic;">' until \\[</span><span style="color: #d33682; font-weight: bold; font-style: italic;">keyboard-quit</span><span style="color: #35a69c; font-style: italic;">] is pressed."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span>)
  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Not sure if `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">with-local-quit</span><span style="color: #405A61; font-style: italic;">' is necessary, but probably a good</span>
  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">idea in case of recursive edit.</span>
  (<span style="color: #859900; font-weight: bold;">with-local-quit</span>
    (<span style="color: #859900; font-weight: bold;">cl-loop</span> while (<span style="text-decoration: underline;">call-interactively</span> #'org-sort))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-Packages" class="outline-2">
<h2 id="Packages">Packages&#xa0;&#xa0;&#xa0;<span class="tag"><span class="packages">packages</span></span></h2>
<div class="outline-text-2" id="text-Packages">
</div>
<div id="outline-container-Delete%20all%20installed%20versions%20of%20a%20package" class="outline-3">
<h3 id="Delete%20all%20installed%20versions%20of%20a%20package">Delete all installed versions of a package</h3>
<div class="outline-text-3" id="text-Delete%20all%20installed%20versions%20of%20a%20package">
<p>
Delete all versions of package named <code>NAME</code>.  <code>NAME</code> may be a string or symbol.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/package-delete-all-versions</span> (name <span style="color: #b58900;">&amp;optional</span> force)
  <span style="color: #35a69c; font-style: italic;">"Delete all versions of package named NAME.</span>
<span style="color: #35a69c; font-style: italic;">NAME may be a string or symbol."</span>
  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Copied from `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">package-delete</span><span style="color: #405A61; font-style: italic;">'.</span>
  (<span style="color: #859900; font-weight: bold;">let*</span> ((package-name (<span style="color: #859900; font-weight: bold;">cl-typecase</span> name
                         (<span style="text-decoration: underline;">string</span> (<span style="text-decoration: underline;">intern</span> name))
                         (symbol name)))
         (user-packages-list (<span style="color: #859900; font-weight: bold;">-&gt;&gt;</span> package-alist
                                  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Just to be safe, we ignore built-ins.</span>
                                  (<span style="text-decoration: underline;">-select</span> (<span style="text-decoration: underline;">-not</span> #'package-built-in-p))))
         (matching-versions (<span style="color: #859900; font-weight: bold;">--select</span> (<span style="text-decoration: underline;">eql</span> (<span style="text-decoration: underline;">car</span> it) package-name) user-packages-list)))
    <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Safety checks.</span>
    (<span style="color: #859900; font-weight: bold;">cl-loop</span> for (symbol first-desc . rest) in matching-versions
             do (<span style="color: #859900; font-weight: bold;">progn</span>
                  (<span style="color: #859900; font-weight: bold;">unless</span> force
                    (<span style="color: #859900; font-weight: bold;">when-let*</span> ((dependent (<span style="text-decoration: underline;">package--used-elsewhere-p</span> first-desc)))
                      (<span style="color: #b58900;">error</span> <span style="color: #2aa198;">"Package `</span><span style="color: #d33682; font-weight: bold;">%s</span><span style="color: #2aa198;">' depends on `</span><span style="color: #d33682; font-weight: bold;">%s</span><span style="color: #2aa198;">'"</span> (<span style="text-decoration: underline;">package-desc-name</span> dependent) package-name)))
                  (<span style="color: #859900; font-weight: bold;">unless</span> (<span style="text-decoration: underline;">string-prefix-p</span> (<span style="text-decoration: underline;">file-name-as-directory</span> (<span style="text-decoration: underline;">expand-file-name</span> package-user-dir))
                                           (<span style="text-decoration: underline;">expand-file-name</span> (<span style="text-decoration: underline;">package-desc-dir</span> first-desc)))
                    (<span style="color: #b58900;">error</span> <span style="color: #2aa198;">"Package `</span><span style="color: #d33682; font-weight: bold;">%s</span><span style="color: #2aa198;">' is a system package"</span> symbol))))
    <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Checks passed: delete packages.</span>
    (<span style="color: #859900; font-weight: bold;">cl-loop</span> for (_symbol . descs) in matching-versions
             do (<span style="color: #859900; font-weight: bold;">--each</span> descs
                  (<span style="text-decoration: underline;">package-delete</span> it force)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-Reload%20a%20package%27s%20features" class="outline-3">
<h3 id="Reload%20a%20package%27s%20features">Reload a package's features</h3>
<div class="outline-text-3" id="text-Reload%20a%20package%27s%20features">
<p>
Reload <code>PACKAGE</code>'s features.  If <code>ALLP</code> is non-nil (interactively, with prefix), load all of its features; otherwise only load ones that were already loaded.
</p>

<p>
This is useful to reload a package after upgrading it.  Since a package may provide multiple features, to reload it properly would require either restarting Emacs or manually unloading and reloading each loaded feature.  This automates that process.
</p>

<p>
Note that this unloads all of the package's symbols before reloading.  Any data stored in those symbols will be lost, so if the package would normally save that data, e.g. when a mode is deactivated or when Emacs exits, the user should do so before using this command.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/reload-package</span> (package <span style="color: #b58900;">&amp;optional</span> allp)
  <span style="color: #35a69c; font-style: italic;">"Reload PACKAGE's features.</span>
<span style="color: #35a69c; font-style: italic;">If ALLP is non-nil (interactively, with prefix), load all of its</span>
<span style="color: #35a69c; font-style: italic;">features; otherwise only load ones that were already loaded.</span>

<span style="color: #35a69c; font-style: italic;">This is useful to reload a package after upgrading it.  Since a</span>
<span style="color: #35a69c; font-style: italic;">package may provide multiple features, to reload it properly</span>
<span style="color: #35a69c; font-style: italic;">would require either restarting Emacs or manually unloading and</span>
<span style="color: #35a69c; font-style: italic;">reloading each loaded feature.  This automates that process.</span>

<span style="color: #35a69c; font-style: italic;">Note that this unloads all of the package's symbols before</span>
<span style="color: #35a69c; font-style: italic;">reloading.  Any data stored in those symbols will be lost, so if</span>
<span style="color: #35a69c; font-style: italic;">the package would normally save that data, e.g. when a mode is</span>
<span style="color: #35a69c; font-style: italic;">deactivated or when Emacs exits, the user should do so before</span>
<span style="color: #35a69c; font-style: italic;">using this command."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span>
   (<span style="text-decoration: underline;">list</span> (<span style="text-decoration: underline;">intern</span> (<span style="text-decoration: underline;">completing-read</span> <span style="color: #2aa198;">"Package: "</span>
                                  (<span style="text-decoration: underline;">mapcar</span> #'car package-alist) nil t))
         current-prefix-arg))
  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">This finds features in the currently installed version of PACKAGE, so if</span>
  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">it provided other features in an older version, those are not unloaded.</span>
  (<span style="color: #859900; font-weight: bold;">when</span> (<span style="text-decoration: underline;">yes-or-no-p</span> (<span style="text-decoration: underline;">format</span> <span style="color: #2aa198;">"Unload all of %s's symbols and reload its features? "</span> package))
    (<span style="color: #859900; font-weight: bold;">let*</span> ((package-name (<span style="text-decoration: underline;">symbol-name</span> package))
           (package-dir (<span style="text-decoration: underline;">file-name-directory</span>
                         (<span style="text-decoration: underline;">locate-file</span> package-name load-path (<span style="text-decoration: underline;">get-load-suffixes</span>))))
           (package-files (<span style="text-decoration: underline;">directory-files</span> package-dir 'full (<span style="color: #859900; font-weight: bold;">rx</span> <span style="color: #2aa198;">".el"</span> eos)))
           (package-features
            (<span style="color: #859900; font-weight: bold;">cl-loop</span> for file in package-files
                     when (<span style="color: #859900; font-weight: bold;">with-temp-buffer</span>
                            (<span style="text-decoration: underline;">insert-file-contents</span> file)
                            (<span style="color: #859900; font-weight: bold;">when</span> (<span style="text-decoration: underline;">re-search-forward</span> (<span style="color: #859900; font-weight: bold;">rx</span> bol <span style="color: #2aa198;">"(provide"</span> (<span style="text-decoration: underline;">1+</span> space)) nil t)
                              (<span style="text-decoration: underline;">goto-char</span> (<span style="text-decoration: underline;">match-beginning</span> 0))
                              (<span style="text-decoration: underline;">cadadr</span> (<span style="text-decoration: underline;">read</span> (<span style="text-decoration: underline;">current-buffer</span>)))))
                     collect it)))
      (<span style="color: #859900; font-weight: bold;">unless</span> allp
        (<span style="color: #859900; font-weight: bold;">setf</span> package-features (<span style="text-decoration: underline;">seq-intersection</span> package-features features)))
      (<span style="color: #859900; font-weight: bold;">dolist</span> (feature package-features)
        (<span style="color: #859900; font-weight: bold;">ignore-errors</span>
          <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Ignore error in case it's not loaded.</span>
          (<span style="text-decoration: underline;">unload-feature</span> feature 'force)))
      (<span style="color: #859900; font-weight: bold;">dolist</span> (feature package-features)
        (<span style="color: #859900; font-weight: bold;">require</span> <span style="color: #d33682; font-weight: bold;">feature</span>))
      (<span style="text-decoration: underline;">message</span> <span style="color: #2aa198;">"Reloaded: %s"</span> (<span style="text-decoration: underline;">mapconcat</span> #'symbol-name package-features <span style="color: #2aa198;">" "</span>)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-Upgrade%20a%20~quelpa-use-package~%20form%27s%20package" class="outline-3">
<h3 id="Upgrade%20a%20~quelpa-use-package~%20form%27s%20package">Upgrade a <code>quelpa-use-package</code> form's package</h3>
<div class="outline-text-3" id="text-Upgrade%20a%20~quelpa-use-package~%20form%27s%20package">
<p>
Eval the current <code>use-package</code> form with <code>quelpa-upgrade-p</code> true.  Delete the package first to remove obsolete versions.  When <code>RELOADP</code> is non-nil, reload the package's features after upgrade using <code>unpackaged/reload-package</code>; otherwise (interactively, with prefix), leave old features loaded.
</p>

<p>
This makes it easy to upgrade a package you install with <a href="https://framagit.org/steckerhalter/quelpa-use-package">quelpa-use-package</a> without having to add <code>:upgrade t</code> to the form, which would cause Quelpa to <i>always</i> upgrade the package every time Emacs loads.
</p>

<p>
<b>Requires:</b>
</p>

<ul class="org-ul">
<li></li>
</ul>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #6c71c4;">quelpa-upgrade-p</span>)

<span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #268bd2;">unpackaged/quelpa-use-package-upgrade</span> (<span style="color: #b58900;">&amp;key</span> (reloadp t))
  <span style="color: #35a69c; font-style: italic;">"Eval the current `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">use-package</span><span style="color: #35a69c; font-style: italic;">' form with `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">quelpa-upgrade-p</span><span style="color: #35a69c; font-style: italic;">' true.</span>
<span style="color: #35a69c; font-style: italic;">Delete the package first to remove obsolete versions.  When</span>
<span style="color: #35a69c; font-style: italic;">RELOADP is non-nil, reload the package's features after upgrade</span>
<span style="color: #35a69c; font-style: italic;">using `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">unpackaged/reload-package</span><span style="color: #35a69c; font-style: italic;">'; otherwise (interactively, with</span>
<span style="color: #35a69c; font-style: italic;">prefix), leave old features loaded."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span> (<span style="text-decoration: underline;">list</span> <span style="color: #268bd2; font-weight: bold;">:reloadp</span> (<span style="text-decoration: underline;">not</span> current-prefix-arg)))
  (<span style="color: #859900; font-weight: bold;">save-excursion</span>
    (<span style="color: #859900; font-weight: bold;">if</span> (<span style="color: #859900; font-weight: bold;">or</span> (<span style="text-decoration: underline;">looking-at</span> (<span style="color: #859900; font-weight: bold;">rx</span> <span style="color: #2aa198;">"(use-package "</span>))
            (<span style="color: #859900; font-weight: bold;">let</span> ((limit (<span style="color: #859900; font-weight: bold;">save-excursion</span>
                           (<span style="color: #859900; font-weight: bold;">or</span> (<span style="text-decoration: underline;">re-search-backward</span> (<span style="color: #859900; font-weight: bold;">rx</span> bol <span style="color: #2aa198;">"("</span>))
                               (<span style="text-decoration: underline;">point-min</span>)))))
              <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Don't go past previous top-level form</span>
              (<span style="text-decoration: underline;">re-search-backward</span> (<span style="color: #859900; font-weight: bold;">rx</span> <span style="color: #2aa198;">"(use-package "</span>) limit t)))
        (<span style="color: #859900; font-weight: bold;">progn</span>
          (<span style="color: #859900; font-weight: bold;">pcase-let*</span> ((`(<span style="color: #859900; font-weight: bold;">use-package</span> ,package-name . ,rest) (<span style="text-decoration: underline;">read</span> (<span style="text-decoration: underline;">current-buffer</span>))))
            (<span style="color: #b58900;">cl-assert</span> package-name nil <span style="color: #2aa198;">"Can't determine package name"</span>)
            (<span style="color: #b58900;">cl-assert</span> (<span style="text-decoration: underline;">memq</span> <span style="color: #268bd2; font-weight: bold;">:quelpa</span> rest) nil <span style="color: #2aa198;">"`</span><span style="color: #d33682; font-weight: bold;">:quelpa</span><span style="color: #2aa198;">' form not found"</span>)
            (<span style="text-decoration: underline;">unpackaged/package-delete-all-versions</span> package-name 'force)
            (<span style="color: #859900; font-weight: bold;">let</span> ((quelpa-upgrade-p t))
              (<span style="text-decoration: underline;">call-interactively</span> #'eval-defun))
            (<span style="color: #859900; font-weight: bold;">when</span> reloadp
              (<span style="text-decoration: underline;">unpackaged/reload-package</span> package-name))))
      (<span style="color: #b58900;">user-error</span> <span style="color: #2aa198;">"Not in a `</span><span style="color: #d33682; font-weight: bold;">use-package</span><span style="color: #2aa198;">' form"</span>))))
</pre>
</div>
</div>
</div>

<div id="outline-container-Upgrade%20one%20package%20in%20the%20package%20menu" class="outline-3">
<h3 id="Upgrade%20one%20package%20in%20the%20package%20menu">Upgrade one package in the package menu</h3>
<div class="outline-text-3" id="text-Upgrade%20one%20package%20in%20the%20package%20menu">
<p>
Mark current package for upgrading (i.e. also mark obsolete version for deletion.)
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">use-package</span> <span style="color: #d33682; font-weight: bold;">package</span>
  <span style="color: #268bd2; font-weight: bold;">:bind</span> (<span style="color: #268bd2; font-weight: bold;">:map</span> package-menu-mode-map
              (<span style="color: #2aa198;">"t"</span> . #'unpackaged/package-menu-upgrade-package))
  <span style="color: #268bd2; font-weight: bold;">:config</span>
  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">I think the `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">use-package</span><span style="color: #405A61; font-style: italic;">' form takes care of autoloading here.</span>
  (<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/package-menu-upgrade-package</span> ()
    <span style="color: #35a69c; font-style: italic;">"Mark current package for upgrading (i.e. also mark obsolete version for deletion.)"</span>
    (<span style="color: #859900; font-weight: bold;">interactive</span>)
    (<span style="color: #859900; font-weight: bold;">when-let</span> ((upgrades (<span style="text-decoration: underline;">package-menu--find-upgrades</span>))
               (description (<span style="text-decoration: underline;">tabulated-list-get-id</span>))
               (name (<span style="text-decoration: underline;">package-desc-name</span> description))
               (upgradable (<span style="text-decoration: underline;">cdr</span> (<span style="text-decoration: underline;">assq</span> name upgrades))))
      <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Package is upgradable</span>
      (<span style="color: #859900; font-weight: bold;">save-excursion</span>
        (<span style="text-decoration: underline;">goto-char</span> (<span style="text-decoration: underline;">point-min</span>))
        (<span style="color: #859900; font-weight: bold;">while</span> (<span style="text-decoration: underline;">not</span> (<span style="text-decoration: underline;">eobp</span>))
          (<span style="color: #859900; font-weight: bold;">let*</span> ((current-description (<span style="text-decoration: underline;">tabulated-list-get-id</span>))
                 (current-name (<span style="text-decoration: underline;">package-desc-name</span> current-description)))
            (<span style="color: #859900; font-weight: bold;">when</span> (<span style="text-decoration: underline;">equal</span> current-name name)
              (<span style="color: #859900; font-weight: bold;">cond</span> ((<span style="text-decoration: underline;">equal</span> description current-description)
                     (<span style="text-decoration: underline;">package-menu-mark-install</span>)
                     (<span style="text-decoration: underline;">forward-line</span> -1))
                    (t (<span style="text-decoration: underline;">package-menu-mark-delete</span>)))))
          (<span style="text-decoration: underline;">forward-line</span> 1))))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-Programming" class="outline-2">
<h2 id="Programming">Programming&#xa0;&#xa0;&#xa0;<span class="tag"><span class="programming">programming</span></span></h2>
<div class="outline-text-2" id="text-Programming">
</div>
<div id="outline-container-Compile%20top-level%20form%20with%20warnings" class="outline-3">
<h3 id="Compile%20top-level%20form%20with%20warnings">Compile top-level form with warnings</h3>
<div class="outline-text-3" id="text-Compile%20top-level%20form%20with%20warnings">
<p>
The only way to get byte-compilation warnings for Elisp is to compile the whole file with, e.g. <code>byte-compile-file</code>, which is less convenient when one wants to debug a single function.  So this function byte-compiles just the current top-level form and displays the warnings.
</p>

<p>
Since <code>compile-defun</code> already takes a prefix argument (i.e. <code>C-u C-M-x</code> already does something), this could be bound to, e.g. <code>C-M-S-x</code>.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/compile-defun-debug</span> ()
  <span style="color: #35a69c; font-style: italic;">"Compile and evaluate the current top-level form, displaying compilation warnings.</span>
<span style="color: #35a69c; font-style: italic;">Calls `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">compile-defun</span><span style="color: #35a69c; font-style: italic;">' with `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">byte-compile-debug</span><span style="color: #35a69c; font-style: italic;">' non-nil."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span>)
  (<span style="color: #859900; font-weight: bold;">let</span> ((byte-compile-debug t))
    (<span style="text-decoration: underline;">call-interactively</span> #'compile-defun)))
</pre>
</div>
</div>
</div>

<div id="outline-container-Flexibly%20fill%2Funfill%20paragraphs" class="outline-3">
<h3 id="Flexibly%20fill%2Funfill%20paragraphs">Flexibly fill/unfill paragraphs</h3>
<div class="outline-text-3" id="text-Flexibly%20fill%2Funfill%20paragraphs">
<p>
Fill paragraph, incrementing fill column to cause a change when repeated.  The global value of <code>fill-column</code> is not modified; it is only bound around calls to <code>fill-paragraph</code>.  When called for the first time in a sequence, unfill to the default <code>fill-column</code>.  When called repeatedly, increase <code>fill-column</code> until filling changes.  With one universal prefix, increase <code>fill-column</code> until the number of lines is reduced.  With two, unfill completely.
</p>

<p>

</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #6c71c4;">unpackaged/flex-fill-paragraph-column</span> nil
  <span style="color: #35a69c; font-style: italic;">"Last fill column used in command `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">unpackaged/flex-fill-paragraph</span><span style="color: #35a69c; font-style: italic;">'."</span>)

<span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/flex-fill-paragraph</span> (<span style="color: #b58900;">&amp;optional</span> fewer-lines unfill)
  <span style="color: #35a69c; font-style: italic;">"Fill paragraph, incrementing fill column to cause a change when repeated.</span>
<span style="color: #35a69c; font-style: italic;">The global value of `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">fill-column</span><span style="color: #35a69c; font-style: italic;">' is not modified; it is only</span>
<span style="color: #35a69c; font-style: italic;">bound around calls to `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">fill-paragraph</span><span style="color: #35a69c; font-style: italic;">'.</span>

<span style="color: #35a69c; font-style: italic;">When called for the first time in a sequence, unfill to the</span>
<span style="color: #35a69c; font-style: italic;">default `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">fill-column</span><span style="color: #35a69c; font-style: italic;">'.</span>

<span style="color: #35a69c; font-style: italic;">When called repeatedly, increase `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">fill-column</span><span style="color: #35a69c; font-style: italic;">' until filling</span>
<span style="color: #35a69c; font-style: italic;">changes.</span>

<span style="color: #35a69c; font-style: italic;">With one universal prefix, increase `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">fill-column</span><span style="color: #35a69c; font-style: italic;">' until the</span>
<span style="color: #35a69c; font-style: italic;">number of lines is reduced.  With two, unfill completely."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span> <span style="color: #2aa198;">"P"</span>)
  (<span style="color: #859900; font-weight: bold;">let*</span> ((fewer-lines (<span style="color: #859900; font-weight: bold;">or</span> fewer-lines (<span style="text-decoration: underline;">equal</span> current-prefix-arg '(4))))
         (unfill (<span style="color: #859900; font-weight: bold;">or</span> unfill (<span style="text-decoration: underline;">equal</span> current-prefix-arg '(16))))
         (fill-column
          (<span style="color: #859900; font-weight: bold;">cond</span> (unfill (<span style="color: #859900; font-weight: bold;">setf</span> unpackaged/flex-fill-paragraph-column nil)
                        most-positive-fixnum)
                (t (<span style="color: #859900; font-weight: bold;">setf</span> unpackaged/flex-fill-paragraph-column
                         (<span style="color: #859900; font-weight: bold;">if</span> (<span style="text-decoration: underline;">equal</span> last-command this-command)
                             (<span style="color: #859900; font-weight: bold;">or</span> (<span style="text-decoration: underline;">unpackaged/flex-fill-paragraph--next-fill-column</span> fewer-lines)
                                 fill-column)
                           fill-column))))))
    (<span style="text-decoration: underline;">fill-paragraph</span>)
    (<span style="text-decoration: underline;">message</span> <span style="color: #2aa198;">"Fill column: %s"</span> fill-column)))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/flex-fill-paragraph--next-fill-column</span> (<span style="color: #b58900;">&amp;optional</span> fewer-lines)
  <span style="color: #35a69c; font-style: italic;">"Return next `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">fill-column</span><span style="color: #35a69c; font-style: italic;">' value.</span>
<span style="color: #35a69c; font-style: italic;">If FEWER-LINES is non-nil, reduce the number of lines in the</span>
<span style="color: #35a69c; font-style: italic;">buffer, otherwise just change the current paragraph."</span>
  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">This works well, but because of all the temp buffers, sometimes when called</span>
  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">in rapid succession, it can cause GC, which can be noticeable.  It would be</span>
  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">nice to avoid that.  Note that this has primarily been tested on</span>
  <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">`</span><span style="color: #d33682; font-weight: bold; font-style: italic;">emacs-lisp-mode</span><span style="color: #405A61; font-style: italic;">'; hopefully it works well in other modes.</span>
  (<span style="color: #859900; font-weight: bold;">let*</span> ((<span style="text-decoration: underline;">point</span> (<span style="text-decoration: underline;">point</span>))
         (source-buffer (<span style="text-decoration: underline;">current-buffer</span>))
         (mode major-mode)
         (fill-column (<span style="color: #859900; font-weight: bold;">or</span> unpackaged/flex-fill-paragraph-column fill-column))
         (old-fill-column fill-column)
         (hash (<span style="color: #859900; font-weight: bold;">unless</span> fewer-lines
                 (<span style="text-decoration: underline;">buffer-hash</span>)))
         (original-num-lines (<span style="color: #859900; font-weight: bold;">when</span> fewer-lines
                               (<span style="text-decoration: underline;">line-number-at-pos</span> (<span style="text-decoration: underline;">point-max</span>)))))
    (<span style="color: #859900; font-weight: bold;">with-temp-buffer</span>
      (<span style="color: #859900; font-weight: bold;">delay-mode-hooks</span>
        (<span style="text-decoration: underline;">funcall</span> mode))
      (<span style="color: #859900; font-weight: bold;">setq-local</span> fill-column old-fill-column)
      (<span style="text-decoration: underline;">insert-buffer-substring</span> source-buffer)
      (<span style="text-decoration: underline;">goto-char</span> point)
      (<span style="color: #859900; font-weight: bold;">cl-loop</span> while (<span style="text-decoration: underline;">fill-paragraph</span>)
               <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">If filling doesn't change after 100 iterations, abort by returning nil.</span>
               if (&gt; (- fill-column old-fill-column) 100)
               return nil
               else do (<span style="color: #859900; font-weight: bold;">cl-incf</span> fill-column)
               while (<span style="color: #859900; font-weight: bold;">if</span> fewer-lines
                         (= original-num-lines (<span style="text-decoration: underline;">line-number-at-pos</span> (<span style="text-decoration: underline;">point-max</span>)))
                       (<span style="text-decoration: underline;">string=</span> hash (<span style="text-decoration: underline;">buffer-hash</span>)))
               finally return fill-column))))
</pre>
</div>
</div>
</div>

<div id="outline-container-~iedit~" class="outline-3">
<h3 id="~iedit~"><code>iedit</code>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="iedit">iedit</span>&#xa0;<span class="refactoring">refactoring</span></span></h3>
<div class="outline-text-3" id="text-~iedit~">
<p>
These commands make <code>iedit-mode</code> a bit easier to use.
</p>
</div>

<div id="outline-container-~iedit-scoped~" class="outline-4">
<h4 id="~iedit-scoped~"><code>iedit-scoped</code></h4>
<div class="outline-text-4" id="text-~iedit-scoped~">
<p>
Call <code>iedit-mode</code> with function-local scope, or global scope if called with a universal prefix.
</p>

<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/iedit-scoped</span> (orig-fn)
  <span style="color: #35a69c; font-style: italic;">"Call `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">iedit-mode</span><span style="color: #35a69c; font-style: italic;">' with function-local scope, or global scope if called with a universal prefix."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span>)
  (<span style="color: #859900; font-weight: bold;">pcase-exhaustive</span> current-prefix-arg
    ('nil (<span style="text-decoration: underline;">funcall</span> orig-fn '(0)))
    ('(4) (<span style="text-decoration: underline;">funcall</span> orig-fn))))

(<span style="text-decoration: underline;">advice-add</span> #'iedit-mode <span style="color: #268bd2; font-weight: bold;">:around</span> #'unpackaged/iedit-scoped)
</pre>
</div>
</div>
</div>

<div id="outline-container-~iedit-or-flyspell~" class="outline-4">
<h4 id="~iedit-or-flyspell~"><code>iedit-or-flyspell</code>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="flyspell">flyspell</span>&#xa0;<span class="spell_checking">spell_checking</span></span></h4>
<div class="outline-text-4" id="text-~iedit-or-flyspell~">
<p>
Toggle <code>iedit-mode</code> or correct previous misspelling with <code>flyspell</code>, depending on context.
</p>

<p>
With point in code or when <code>iedit-mode</code> is already active, toggle <code>iedit-mode</code>.  With point in a comment or string, and when <code>iedit-mode</code> is not already active, auto-correct previous misspelled word with <code>flyspell</code>.  Call this command a second time to choose a different correction.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #6c71c4;">flyspell-previous-command</span>)

<span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/iedit-or-flyspell</span> ()
  <span style="color: #35a69c; font-style: italic;">"Toggle `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">iedit-mode</span><span style="color: #35a69c; font-style: italic;">' or correct previous misspelling with `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">flyspell</span><span style="color: #35a69c; font-style: italic;">', depending on context.</span>

<span style="color: #35a69c; font-style: italic;">With point in code or when `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">iedit-mode</span><span style="color: #35a69c; font-style: italic;">' is already active, toggle</span>
<span style="color: #35a69c; font-style: italic;">`</span><span style="color: #d33682; font-weight: bold; font-style: italic;">iedit-mode</span><span style="color: #35a69c; font-style: italic;">'.  With point in a comment or string, and when</span>
<span style="color: #35a69c; font-style: italic;">`</span><span style="color: #d33682; font-weight: bold; font-style: italic;">iedit-mode</span><span style="color: #35a69c; font-style: italic;">' is not already active, auto-correct previous</span>
<span style="color: #35a69c; font-style: italic;">misspelled word with `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">flyspell</span><span style="color: #35a69c; font-style: italic;">'.  Call this command a second time</span>
<span style="color: #35a69c; font-style: italic;">to choose a different correction."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span>)
  (<span style="color: #859900; font-weight: bold;">if</span> (<span style="color: #859900; font-weight: bold;">or</span> (<span style="color: #859900; font-weight: bold;">bound-and-true-p</span> iedit-mode)
          (<span style="color: #859900; font-weight: bold;">and</span> (<span style="text-decoration: underline;">derived-mode-p</span> 'prog-mode)
               (<span style="text-decoration: underline;">not</span> (<span style="color: #859900; font-weight: bold;">or</span> (<span style="text-decoration: underline;">nth</span> 4 (<span style="text-decoration: underline;">syntax-ppss</span>))
                        (<span style="text-decoration: underline;">nth</span> 3 (<span style="text-decoration: underline;">syntax-ppss</span>))))))
      <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">prog-mode is active and point is in a comment, string, or</span>
      <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">already in iedit-mode</span>
      (<span style="text-decoration: underline;">call-interactively</span> #'iedit-mode)
    <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Not prog-mode or not in comment or string</span>
    (<span style="color: #859900; font-weight: bold;">if</span> (<span style="text-decoration: underline;">not</span> (<span style="text-decoration: underline;">equal</span> flyspell-previous-command this-command))
        <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #cc9393; font-style: italic;">FIXME</span><span style="color: #405A61; font-style: italic;">: This mostly works, but if there are two words on the</span>
        <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">same line that are misspelled, it doesn't work quite right</span>
        <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">when correcting the earlier word after correcting the later</span>
        <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">one</span>

        <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">First correction; autocorrect</span>
        (<span style="text-decoration: underline;">call-interactively</span> 'flyspell-auto-correct-previous-word)
      <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">First correction was not wanted; use popup to choose</span>
      (<span style="color: #859900; font-weight: bold;">progn</span>
        (<span style="color: #859900; font-weight: bold;">save-excursion</span>
          (<span style="text-decoration: underline;">undo</span>)) <span style="color: #405A61; font-style: italic;">; </span><span style="color: #405A61; font-style: italic;">This doesn't move point, which I think may be the problem.</span>
        (<span style="text-decoration: underline;">flyspell-region</span> (<span style="text-decoration: underline;">line-beginning-position</span>) (<span style="text-decoration: underline;">line-end-position</span>))
        (<span style="text-decoration: underline;">call-interactively</span> 'flyspell-correct-previous-word-generic)))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-Sort%20sexps" class="outline-3">
<h3 id="Sort%20sexps">Sort sexps</h3>
<div class="outline-text-3" id="text-Sort%20sexps">
<p>
Sort sexps in region.  Comments stay with the code below.
</p>

<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/sort-sexps</span> (beg end)
  <span style="color: #35a69c; font-style: italic;">"Sort sexps in region.</span>
<span style="color: #35a69c; font-style: italic;">Comments stay with the code below."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span> <span style="color: #2aa198;">"r"</span>)
  (<span style="color: #859900; font-weight: bold;">cl-flet</span> ((skip-whitespace () (<span style="color: #859900; font-weight: bold;">while</span> (<span style="text-decoration: underline;">looking-at</span> (<span style="color: #859900; font-weight: bold;">rx</span> (<span style="text-decoration: underline;">1+</span> (<span style="color: #859900; font-weight: bold;">or</span> space <span style="color: #2aa198;">"\n"</span>))))
                                  (<span style="text-decoration: underline;">goto-char</span> (<span style="text-decoration: underline;">match-end</span> 0))))
            (skip-both () (<span style="color: #859900; font-weight: bold;">while</span> (<span style="color: #859900; font-weight: bold;">cond</span> ((<span style="color: #859900; font-weight: bold;">or</span> (<span style="text-decoration: underline;">nth</span> 4 (<span style="text-decoration: underline;">syntax-ppss</span>))
                                            (<span style="color: #859900; font-weight: bold;">ignore-errors</span>
                                              (<span style="color: #859900; font-weight: bold;">save-excursion</span>
                                                (<span style="text-decoration: underline;">forward-char</span> 1)
                                                (<span style="text-decoration: underline;">nth</span> 4 (<span style="text-decoration: underline;">syntax-ppss</span>)))))
                                        (<span style="text-decoration: underline;">forward-line</span> 1))
                                       ((<span style="text-decoration: underline;">looking-at</span> (<span style="color: #859900; font-weight: bold;">rx</span> (<span style="text-decoration: underline;">1+</span> (<span style="color: #859900; font-weight: bold;">or</span> space <span style="color: #2aa198;">"\n"</span>))))
                                        (<span style="text-decoration: underline;">goto-char</span> (<span style="text-decoration: underline;">match-end</span> 0)))))))
    (<span style="color: #859900; font-weight: bold;">save-excursion</span>
      (<span style="color: #859900; font-weight: bold;">save-restriction</span>
        (<span style="text-decoration: underline;">narrow-to-region</span> beg end)
        (<span style="text-decoration: underline;">goto-char</span> beg)
        (skip-both)
        (<span style="color: #859900; font-weight: bold;">cl-destructuring-bind</span> (sexps markers)
            (<span style="color: #859900; font-weight: bold;">cl-loop</span> do (skip-whitespace)
                     for start = (<span style="text-decoration: underline;">point-marker</span>)
                     for sexp = (<span style="color: #859900; font-weight: bold;">ignore-errors</span>
                                  (<span style="text-decoration: underline;">read</span> (<span style="text-decoration: underline;">current-buffer</span>)))
                     for end = (<span style="text-decoration: underline;">point-marker</span>)
                     while sexp
                     <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Collect the real string, then one used for sorting.</span>
                     collect (<span style="text-decoration: underline;">cons</span> (<span style="text-decoration: underline;">buffer-substring</span> (<span style="text-decoration: underline;">marker-position</span> start) (<span style="text-decoration: underline;">marker-position</span> end))
                                   (<span style="color: #859900; font-weight: bold;">save-excursion</span>
                                     (<span style="text-decoration: underline;">goto-char</span> (<span style="text-decoration: underline;">marker-position</span> start))
                                     (skip-both)
                                     (<span style="text-decoration: underline;">buffer-substring</span> (<span style="text-decoration: underline;">point</span>) (<span style="text-decoration: underline;">marker-position</span> end))))
                     into sexps
                     collect (<span style="text-decoration: underline;">cons</span> start end)
                     into markers
                     finally return (<span style="text-decoration: underline;">list</span> sexps markers))
          (<span style="color: #859900; font-weight: bold;">setq</span> sexps (<span style="text-decoration: underline;">sort</span> sexps (<span style="color: #859900; font-weight: bold;">lambda</span> (a b)
                                    (<span style="text-decoration: underline;">string&lt;</span> (<span style="text-decoration: underline;">cdr</span> a) (<span style="text-decoration: underline;">cdr</span> b)))))
          (<span style="color: #859900; font-weight: bold;">cl-loop</span> for (real . sort) in sexps
                   for (start . end) in markers
                   do (<span style="color: #859900; font-weight: bold;">progn</span>
                        (<span style="text-decoration: underline;">goto-char</span> (<span style="text-decoration: underline;">marker-position</span> start))
                        (<span style="text-decoration: underline;">insert-before-markers</span> real)
                        (<span style="text-decoration: underline;">delete-region</span> (<span style="text-decoration: underline;">point</span>) (<span style="text-decoration: underline;">marker-position</span> end)))))))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-Regular%20expressions" class="outline-2">
<h2 id="Regular%20expressions">Regular expressions&#xa0;&#xa0;&#xa0;<span class="tag"><span class="regular_expressions">regular_expressions</span></span></h2>
<div class="outline-text-2" id="text-Regular%20expressions">
</div>
<div id="outline-container-query-replace-rx" class="outline-3">
<h3 id="query-replace-rx">query-replace-rx</h3>
<div class="outline-text-3" id="text-query-replace-rx">
<p>
Call <code>query-replace-regexp</code>, reading regexp in <code>rx</code> syntax.  Automatically wraps in parens and adds <code>seq</code> to the beginning of the form.
</p>

<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/query-replace-rx</span> (<span style="color: #b58900;">&amp;rest</span> _)
  <span style="color: #35a69c; font-style: italic;">"Call `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">query-replace-regexp</span><span style="color: #35a69c; font-style: italic;">', reading regexp in `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">rx</span><span style="color: #35a69c; font-style: italic;">' syntax.</span>
<span style="color: #35a69c; font-style: italic;">Automatically wraps in parens and adds `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">seq</span><span style="color: #35a69c; font-style: italic;">' to the beginning of</span>
<span style="color: #35a69c; font-style: italic;">the form."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span>)
  (<span style="color: #859900; font-weight: bold;">cl-letf</span> (((<span style="text-decoration: underline;">symbol-function</span> #'query-replace-read-from) (<span style="color: #859900; font-weight: bold;">lambda</span> (<span style="color: #b58900;">&amp;rest</span> _)
                                                           (<span style="color: #859900; font-weight: bold;">--&gt;</span> (<span style="text-decoration: underline;">read-string</span> <span style="color: #2aa198;">"rx form: "</span>)
                                                                (<span style="text-decoration: underline;">concat</span> <span style="color: #2aa198;">"'(seq "</span> it <span style="color: #2aa198;">")"</span>)
                                                                (<span style="text-decoration: underline;">read</span> it)
                                                                (<span style="text-decoration: underline;">cadr</span> it)
                                                                (<span style="text-decoration: underline;">rx-to-string</span> it)))))
    (<span style="text-decoration: underline;">call-interactively</span> #'query-replace-regexp)))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-Version%20control" class="outline-2">
<h2 id="Version%20control">Version control&#xa0;&#xa0;&#xa0;<span class="tag"><span class="version_control">version_control</span></span></h2>
<div class="outline-text-2" id="text-Version%20control">
</div>
<div id="outline-container-Magit" class="outline-3">
<h3 id="Magit">Magit&#xa0;&#xa0;&#xa0;<span class="tag"><span class="Magit">Magit</span></span></h3>
<div class="outline-text-3" id="text-Magit">
</div>
<div id="outline-container-Improved%20~magit-status~%20command" class="outline-4">
<h4 id="Improved%20~magit-status~%20command">Improved <code>magit-status</code> command</h4>
<div class="outline-text-4" id="text-Improved%20~magit-status~%20command">
<p>
Open a <code>magit-status</code> buffer and close the other window so only Magit is visible.  If a file was visited in the buffer that was active when this command was called, go to its unstaged changes section.
</p>

<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/magit-status</span> ()
  <span style="color: #35a69c; font-style: italic;">"Open a `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">magit-status</span><span style="color: #35a69c; font-style: italic;">' buffer and close the other window so only Magit is visible.</span>
<span style="color: #35a69c; font-style: italic;">If a file was visited in the buffer that was active when this</span>
<span style="color: #35a69c; font-style: italic;">command was called, go to its unstaged changes section."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span>)
  (<span style="color: #859900; font-weight: bold;">let*</span> ((buffer-file-path (<span style="color: #859900; font-weight: bold;">when</span> buffer-file-name
                             (<span style="text-decoration: underline;">file-relative-name</span> buffer-file-name
                                                 (<span style="text-decoration: underline;">locate-dominating-file</span> buffer-file-name <span style="color: #2aa198;">".git"</span>))))
         (section-ident `((file . ,buffer-file-path) (unstaged) (status))))
    (<span style="text-decoration: underline;">call-interactively</span> #'magit-status)
    (<span style="text-decoration: underline;">delete-other-windows</span>)
    (<span style="color: #859900; font-weight: bold;">when</span> buffer-file-path
      (<span style="text-decoration: underline;">goto-char</span> (<span style="text-decoration: underline;">point-min</span>))
      (<span style="color: #859900; font-weight: bold;">cl-loop</span> until (<span style="color: #859900; font-weight: bold;">when</span> (<span style="text-decoration: underline;">equal</span> section-ident (<span style="text-decoration: underline;">magit-section-ident</span> (<span style="text-decoration: underline;">magit-current-section</span>)))
                       (<span style="text-decoration: underline;">magit-section-show</span> (<span style="text-decoration: underline;">magit-current-section</span>))
                       (<span style="text-decoration: underline;">recenter</span>)
                       t)
               do (<span style="color: #859900; font-weight: bold;">condition-case</span> nil
                      (<span style="text-decoration: underline;">magit-section-forward</span>)
                    (<span style="color: #b58900;">error</span> (<span style="color: #859900; font-weight: bold;">cl-return</span> (magit-status-goto-initial-section-1))))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-magit-log%20date%20headers" class="outline-4">
<h4 id="magit-log%20date%20headers">magit-log date headers</h4>
<div class="outline-text-4" id="text-magit-log%20date%20headers">
<p>
Add date headers to Magit log buffers.
</p>

<p>
<b>Requires:</b>
</p>
<ul class="org-ul">
<li><a href="https://github.com/ShingoFukuyama/ov.el">ov.el</a></li>
</ul>

<p>

</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/magit-log--add-date-headers</span> (<span style="color: #b58900;">&amp;rest</span> _ignore)
  <span style="color: #35a69c; font-style: italic;">"Add date headers to Magit log buffers."</span>
  (<span style="color: #859900; font-weight: bold;">when</span> (<span style="text-decoration: underline;">derived-mode-p</span> 'magit-log-mode)
    (<span style="color: #859900; font-weight: bold;">save-excursion</span>
      (<span style="text-decoration: underline;">ov-clear</span> 'date-header t)
      (<span style="text-decoration: underline;">goto-char</span> (<span style="text-decoration: underline;">point-min</span>))
      (<span style="color: #859900; font-weight: bold;">cl-loop</span> with last-age
               for this-age = (<span style="color: #859900; font-weight: bold;">-some--&gt;</span> (<span style="text-decoration: underline;">ov-in</span> 'before-string 'any (<span style="text-decoration: underline;">line-beginning-position</span>) (<span style="text-decoration: underline;">line-end-position</span>))
                                        car
                                        (<span style="text-decoration: underline;">overlay-get</span> it 'before-string)
                                        (<span style="text-decoration: underline;">get-text-property</span> 0 'display it)
                                        cadr
                                        (<span style="text-decoration: underline;">s-match</span> (<span style="color: #859900; font-weight: bold;">rx</span> (group (<span style="text-decoration: underline;">1+</span> digit) <span style="color: #405A61; font-style: italic;">; </span><span style="color: #405A61; font-style: italic;">number</span>
                                                            <span style="color: #2aa198;">" "</span>
                                                            (<span style="text-decoration: underline;">1+</span> (<span style="text-decoration: underline;">not</span> blank))) <span style="color: #405A61; font-style: italic;">; </span><span style="color: #405A61; font-style: italic;">unit</span>
                                                     (<span style="text-decoration: underline;">1+</span> blank) eos)
                                                 it)
                                        cadr)
               do (<span style="color: #859900; font-weight: bold;">when</span> (<span style="color: #859900; font-weight: bold;">and</span> this-age
                             (<span style="text-decoration: underline;">not</span> (<span style="text-decoration: underline;">equal</span> this-age last-age)))
                    (<span style="text-decoration: underline;">ov</span> (<span style="text-decoration: underline;">line-beginning-position</span>) (<span style="text-decoration: underline;">line-beginning-position</span>)
                        'after-string (<span style="text-decoration: underline;">propertize</span> (<span style="text-decoration: underline;">concat</span> <span style="color: #2aa198;">" "</span> this-age <span style="color: #2aa198;">"\n"</span>)
                                                  'face 'magit-section-heading)
                        'date-header t)
                    (<span style="color: #859900; font-weight: bold;">setq</span> last-age this-age))
               do (<span style="text-decoration: underline;">forward-line</span> 1)
               until (<span style="text-decoration: underline;">eobp</span>)))))

(<span style="color: #859900; font-weight: bold;">define-minor-mode</span> <span style="color: #268bd2;">unpackaged/magit-log-date-headers-mode</span>
  <span style="color: #35a69c; font-style: italic;">"Display date/time headers in `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">magit-log</span><span style="color: #35a69c; font-style: italic;">' buffers."</span>
  <span style="color: #268bd2; font-weight: bold;">:global</span> t
  (<span style="color: #859900; font-weight: bold;">if</span> unpackaged/magit-log-date-headers-mode
      (<span style="color: #859900; font-weight: bold;">progn</span>
        <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Enable mode</span>
        (<span style="text-decoration: underline;">add-hook</span> 'magit-post-refresh-hook #'unpackaged/magit-log--add-date-headers)
        (<span style="text-decoration: underline;">advice-add</span> #'magit-setup-buffer-internal <span style="color: #268bd2; font-weight: bold;">:after</span> #'unpackaged/magit-log--add-date-headers))
    <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Disable mode</span>
    (<span style="text-decoration: underline;">remove-hook</span> 'magit-post-refresh-hook #'unpackaged/magit-log--add-date-headers)
    (<span style="text-decoration: underline;">advice-remove</span> #'magit-setup-buffer-internal #'unpackaged/magit-log--add-date-headers)))
</pre>
</div>

<p>
This isn't always perfect, because dates in a git commit log are not always in order (e.g. when commits are merged at a later date), but it's often very helpful to visually group commits by their age.
</p>
</div>
</div>

<div id="outline-container-Save%20buffer%20and%20show%20changes%20in%20Magit%20status" class="outline-4">
<h4 id="Save%20buffer%20and%20show%20changes%20in%20Magit%20status">Save buffer and show changes in Magit status</h4>
<div class="outline-text-4" id="text-Save%20buffer%20and%20show%20changes%20in%20Magit%20status">
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/magit-save-buffer-show-status</span> ()
  <span style="color: #35a69c; font-style: italic;">"Save buffer and show its changes in `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">magit-status</span><span style="color: #35a69c; font-style: italic;">'."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span>)
  (<span style="text-decoration: underline;">save-buffer</span>)
  (<span style="text-decoration: underline;">unpackaged/magit-status</span>))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-~smerge-mode~" class="outline-3">
<h3 id="~smerge-mode~"><code>smerge-mode</code></h3>
<div class="outline-text-3" id="text-~smerge-mode~">
</div>

<div id="outline-container-Hydra" class="outline-4">
<h4 id="Hydra">Hydra</h4>
<div class="outline-text-4" id="text-Hydra">
<p>
This configuration automatically activates a helpful <code>smerge-mode</code> hydra when a file containing merge conflicts is visited from a Magit diff section.  You can manually activate the hydra with the command <code>unpackaged/smerge-hydra/body</code>.  (Inspired by <a href="https://github.com/kaushalmodi/.emacs.d/blob/master/setup-files/setup-diff.el">Kaushal Modi's Emacs config</a>.)
</p>

<p>
<b>Requires</b>:
</p>
<ul class="org-ul">
<li><a href="https://github.com/abo-abo/hydra">hydra</a></li>
<li><a href="https://magit.vc/">Magit</a></li>
</ul>

<p>

</p>

<p>
See these screencasts comparing what it's like to resolve the conflict with and with this .
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #d33682; font-weight: bold;">hydra</span>)

(<span style="color: #859900; font-weight: bold;">use-package</span> <span style="color: #d33682; font-weight: bold;">smerge-mode</span>
  <span style="color: #268bd2; font-weight: bold;">:config</span>
  (<span style="color: #859900; font-weight: bold;">defhydra</span> unpackaged/smerge-hydra
    (<span style="color: #268bd2; font-weight: bold;">:color</span> pink <span style="color: #268bd2; font-weight: bold;">:hint</span> nil <span style="color: #268bd2; font-weight: bold;">:post</span> (<span style="text-decoration: underline;">smerge-auto-leave</span>))
    <span style="color: #35a69c; font-style: italic;">"</span>
<span style="color: #35a69c; font-style: italic;">^Move^       ^Keep^               ^Diff^                 ^Other^</span>
<span style="color: #35a69c; font-style: italic;">^^-----------^^-------------------^^---------------------^^-------</span>
<span style="color: #35a69c; font-style: italic;">_n_ext       _b_ase               _&lt;_: upper/base        _C_ombine</span>
<span style="color: #35a69c; font-style: italic;">_p_rev       _u_pper              _=_: upper/lower       _r_esolve</span>
<span style="color: #35a69c; font-style: italic;">^^           _l_ower              _&gt;_: base/lower        _k_ill current</span>
<span style="color: #35a69c; font-style: italic;">^^           _a_ll                _R_efine</span>
<span style="color: #35a69c; font-style: italic;">^^           _RET_: current       _E_diff</span>
<span style="color: #35a69c; font-style: italic;">"</span>
    (<span style="color: #2aa198;">"n"</span> smerge-next)
    (<span style="color: #2aa198;">"p"</span> smerge-prev)
    (<span style="color: #2aa198;">"b"</span> smerge-keep-base)
    (<span style="color: #2aa198;">"u"</span> smerge-keep-upper)
    (<span style="color: #2aa198;">"l"</span> smerge-keep-lower)
    (<span style="color: #2aa198;">"a"</span> smerge-keep-all)
    (<span style="color: #2aa198;">"RET"</span> smerge-keep-current)
    (<span style="color: #2aa198;">"\C-m"</span> smerge-keep-current)
    (<span style="color: #2aa198;">"&lt;"</span> smerge-diff-base-upper)
    (<span style="color: #2aa198;">"="</span> smerge-diff-upper-lower)
    (<span style="color: #2aa198;">"&gt;"</span> smerge-diff-base-lower)
    (<span style="color: #2aa198;">"R"</span> smerge-refine)
    (<span style="color: #2aa198;">"E"</span> smerge-ediff)
    (<span style="color: #2aa198;">"C"</span> smerge-combine-with-next)
    (<span style="color: #2aa198;">"r"</span> smerge-resolve)
    (<span style="color: #2aa198;">"k"</span> smerge-kill-current)
    (<span style="color: #2aa198;">"ZZ"</span> (<span style="color: #859900; font-weight: bold;">lambda</span> ()
            (<span style="color: #859900; font-weight: bold;">interactive</span>)
            (<span style="text-decoration: underline;">save-buffer</span>)
            (<span style="text-decoration: underline;">bury-buffer</span>))
     <span style="color: #2aa198;">"Save and bury buffer"</span> <span style="color: #268bd2; font-weight: bold;">:color</span> blue)
    (<span style="color: #2aa198;">"q"</span> nil <span style="color: #2aa198;">"cancel"</span> <span style="color: #268bd2; font-weight: bold;">:color</span> blue))
  <span style="color: #268bd2; font-weight: bold;">:hook</span> (<span style="text-decoration: underline;">magit-diff-visit-file</span> . (<span style="color: #859900; font-weight: bold;">lambda</span> ()
                                   (<span style="color: #859900; font-weight: bold;">when</span> smerge-mode
                                     (<span style="text-decoration: underline;">unpackaged/smerge-hydra/body</span>)))))
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-Web" class="outline-2">
<h2 id="Web">Web&#xa0;&#xa0;&#xa0;<span class="tag"><span class="web">web</span></span></h2>
<div class="outline-text-2" id="text-Web">
</div>
<div id="outline-container-EWW%20Imenu%20support" class="outline-3">
<h3 id="EWW%20Imenu%20support">EWW Imenu support&#xa0;&#xa0;&#xa0;<span class="tag"><span class="EWW">EWW</span>&#xa0;<span class="Imenu">Imenu</span></span></h3>
<div class="outline-text-3" id="text-EWW%20Imenu%20support">
<p>
This function allows Imenu to offer HTML headings in EWW buffers, which is especially helpful for navigating long, technical documents.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">unpackaged/imenu-eww-headings</span> ()
  <span style="color: #35a69c; font-style: italic;">"Return alist of HTML headings in current EWW buffer for Imenu.</span>
<span style="color: #35a69c; font-style: italic;">Suitable for `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">imenu-create-index-function</span><span style="color: #35a69c; font-style: italic;">'."</span>
  (<span style="color: #859900; font-weight: bold;">let</span> ((faces '(shr-h1 shr-h2 shr-h3 shr-h4 shr-h5 shr-h6 shr-heading)))
    (<span style="color: #859900; font-weight: bold;">save-excursion</span>
      (<span style="color: #859900; font-weight: bold;">save-restriction</span>
        (<span style="text-decoration: underline;">widen</span>)
        (<span style="text-decoration: underline;">goto-char</span> (<span style="text-decoration: underline;">point-min</span>))
        (<span style="color: #859900; font-weight: bold;">cl-loop</span> for next-pos = (<span style="text-decoration: underline;">next-single-property-change</span> (<span style="text-decoration: underline;">point</span>) 'face)
                 while next-pos
                 do (<span style="text-decoration: underline;">goto-char</span> next-pos)
                 for face = (<span style="text-decoration: underline;">get-text-property</span> (<span style="text-decoration: underline;">point</span>) 'face)
                 when (<span style="color: #859900; font-weight: bold;">cl-typecase</span> face
                        (<span style="text-decoration: underline;">list</span> (<span style="text-decoration: underline;">cl-intersection</span> face faces))
                        (symbol (<span style="text-decoration: underline;">member</span> face faces)))
                 collect (<span style="text-decoration: underline;">cons</span> (<span style="text-decoration: underline;">buffer-substring</span> (<span style="text-decoration: underline;">point-at-bol</span>) (<span style="text-decoration: underline;">point-at-eol</span>)) (<span style="text-decoration: underline;">point</span>))
                 and do (<span style="text-decoration: underline;">forward-line</span> 1))))))

(<span style="text-decoration: underline;">add-hook</span> 'eww-mode-hook
          (<span style="color: #859900; font-weight: bold;">lambda</span> ()
            (<span style="color: #859900; font-weight: bold;">setq-local</span> imenu-create-index-function #'unpackaged/imenu-eww-headings)))
</pre>
</div>
</div>
</div>

<div id="outline-container-feed-for-url" class="outline-3">
<h3 id="feed-for-url">feed-for-url&#xa0;&#xa0;&#xa0;<span class="tag"><span class="RSS">RSS</span>&#xa0;<span class="Atom">Atom</span>&#xa0;<span class="XML">XML</span></span></h3>
<div class="outline-text-3" id="text-feed-for-url">
<p>
Return ATOM or RSS feed <code>URL</code> for web page at <code>URL</code>.  Interactively, insert the <code>URL</code> at point.  <code>PREFER</code> may be <code>atom</code> (the default) or <code>rss</code>.  When <code>ALL</code> is non-nil, return all feed URLs of all types; otherwise, return only one feed <code>URL</code>, preferring the preferred type.
</p>

<p>
<b>Requires:</b>
</p>
<ul class="org-ul">
<li><a href="https://github.com/tali713/esxml">esxml</a></li>
<li><a href="https://github.com/alphapapa/org-web-tools">org-web-tools</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">eval-when-compile</span>
  (<span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #d33682; font-weight: bold;">esxml-query</span>))

<span style="color: #405A61; font-style: italic;">;;;</span><span style="color: #405A61; font-style: italic;">###</span><span style="color: #b58900; font-style: italic;">autoload</span>
(<span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #268bd2;">unpackaged/feed-for-url</span> (url <span style="color: #b58900;">&amp;key</span> (prefer 'atom) (all nil))
  <span style="color: #35a69c; font-style: italic;">"Return feed URL for web page at URL.</span>
<span style="color: #35a69c; font-style: italic;">Interactively, insert the URL at point.  PREFER may be</span>
<span style="color: #35a69c; font-style: italic;">`</span><span style="color: #d33682; font-weight: bold; font-style: italic;">atom</span><span style="color: #35a69c; font-style: italic;">' (the default) or `</span><span style="color: #d33682; font-weight: bold; font-style: italic;">rss</span><span style="color: #35a69c; font-style: italic;">'.  When ALL is non-nil, return all</span>
<span style="color: #35a69c; font-style: italic;">feed URLs of all types; otherwise, return only one feed URL,</span>
<span style="color: #35a69c; font-style: italic;">preferring the preferred type."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span> (<span style="text-decoration: underline;">list</span> (org-web-tools--get-first-url)))
  (<span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #d33682; font-weight: bold;">esxml-query</span>)
  (<span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #d33682; font-weight: bold;">org-web-tools</span>)
  (<span style="color: #859900; font-weight: bold;">cl-flet</span> ((feed-p (type)
                    <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Return t if TYPE appears to be an RSS/ATOM feed</span>
                    (<span style="text-decoration: underline;">string-match-p</span> (<span style="color: #859900; font-weight: bold;">rx</span> <span style="color: #2aa198;">"application/"</span> (<span style="color: #859900; font-weight: bold;">or</span> <span style="color: #2aa198;">"rss"</span> <span style="color: #2aa198;">"atom"</span>) <span style="color: #2aa198;">"+xml"</span>)
                                    type)))
    (<span style="color: #859900; font-weight: bold;">let*</span> ((preferred-type (<span style="text-decoration: underline;">format</span> <span style="color: #2aa198;">"application/%s+xml"</span> (<span style="text-decoration: underline;">symbol-name</span> prefer)))
           (html (org-web-tools--get-url url))
           (dom (<span style="color: #859900; font-weight: bold;">with-temp-buffer</span>
                  (<span style="text-decoration: underline;">insert</span> html)
                  (<span style="text-decoration: underline;">libxml-parse-html-region</span> (<span style="text-decoration: underline;">point-min</span>) (<span style="text-decoration: underline;">point-max</span>))))
           (potential-feeds (esxml-query-all <span style="color: #2aa198;">"link[rel=alternate]"</span> dom))
           (return (<span style="color: #859900; font-weight: bold;">if</span> all
                       <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Return all URLs</span>
                       (<span style="color: #859900; font-weight: bold;">cl-loop</span> for (_tag attrs) in potential-feeds
                                when (feed-p (<span style="text-decoration: underline;">alist-get</span> 'type attrs))
                                collect (<span style="text-decoration: underline;">url-expand-file-name</span> (<span style="text-decoration: underline;">alist-get</span> 'href attrs) url))
                     (<span style="color: #859900; font-weight: bold;">or</span>
                      <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Return the first URL of preferred type</span>
                      (<span style="color: #859900; font-weight: bold;">cl-loop</span> for (_tag attrs) in potential-feeds
                               when (<span style="text-decoration: underline;">equal</span> preferred-type (<span style="text-decoration: underline;">alist-get</span> 'type attrs))
                               return (<span style="text-decoration: underline;">url-expand-file-name</span> (<span style="text-decoration: underline;">alist-get</span> 'href attrs) url))
                      <span style="color: #405A61; font-style: italic;">;; </span><span style="color: #405A61; font-style: italic;">Return the first URL of non-preferred type</span>
                      (<span style="color: #859900; font-weight: bold;">cl-loop</span> for (_tag attrs) in potential-feeds
                               when (feed-p (<span style="text-decoration: underline;">alist-get</span> 'type attrs))
                               return (<span style="text-decoration: underline;">url-expand-file-name</span> (<span style="text-decoration: underline;">alist-get</span> 'href attrs) url))))))
      (<span style="color: #859900; font-weight: bold;">if</span> (<span style="text-decoration: underline;">called-interactively-p</span> 'interactive)
          (<span style="text-decoration: underline;">insert</span> (<span style="color: #859900; font-weight: bold;">if</span> (<span style="text-decoration: underline;">listp</span> return)
                      (<span style="text-decoration: underline;">s-join</span> <span style="color: #2aa198;">" "</span> return)
                    return))
        return))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-License" class="outline-2">
<h2 id="License">License</h2>
<div class="outline-text-2" id="text-License">
<p>
GPLv3
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2023-03-12 Sun 09:20</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
